importScripts("idb.js");importScripts("server-config.js");var q="pollShopeeEvery5m",J="syncShopeeData",R="notified_date",H="loginRequired",V="yesterdayHasData",W=!1,U=!1,B=!1;chrome.runtime.onInstalled.addListener(t=>{chrome.alarms.create(q,{periodInMinutes:5}),chrome.alarms.create(J,{periodInMinutes:360}),chrome.contextMenus.create({id:"calculateCommission",title:"T\xEDnh to\xE1n hoa h\u1ED3ng trang hi\u1EC7n t\u1EA1i",contexts:["page"],documentUrlPatterns:["https://affiliate.shopee.vn/*"]}),chrome.contextMenus.create({id:"openOrderHistory",title:"M\u1EDF l\u1ECBch s\u1EED \u0111\u01A1n h\xE0ng",contexts:["page"],documentUrlPatterns:["*://*.shopee.vn/*"]}),chrome.contextMenus.create({id:"viewProductDetails",title:"Xem chi ti\u1EBFt s\u1EA3n ph\u1EA9m",contexts:["page"],documentUrlPatterns:["*://*.shopee.vn/*"]}),t.reason==="install"&&chrome.tabs.create({url:"https://addlivetag.com/extension/thank-you.html"}),Y()});chrome.runtime.onStartup.addListener(()=>{chrome.alarms.create(q,{periodInMinutes:5}),chrome.alarms.create(J,{periodInMinutes:360}),Y()});function P(t){return t.toISOString().split("T")[0]}function z(){let t=new Date,s=new Date(t.getFullYear(),t.getMonth(),t.getDate()),n=new Date(s.getTime()-864e5),e=new Date(s.getTime()-1e3);return{s:Math.floor(n.getTime()/1e3),e:Math.floor(e.getTime()/1e3)}}async function te(){let t=P(new Date),{[R]:s}=await chrome.storage.local.get(R);s&&s!==t&&await chrome.storage.local.remove(R)}async function X(){let t=await chrome.notifications.getAll();t&&t[H]||chrome.notifications.create(H,{type:"basic",iconUrl:"/icon/icon128.png",title:"C\xF4ng c\u1EE5 t\xEDnh hoa h\u1ED3ng Shopee",message:`Phi\xEAn \u0111\u0103ng nh\u1EADp Shopee Affiliate \u0111\xE3 h\u1EBFt h\u1EA1n.
Nh\u1EA5p \u0111\u1EC3 m\u1EDF Shopee Affiliate v\xE0 \u0111\u0103ng nh\u1EADp l\u1EA1i.`})}async function ne(t){let s=await chrome.notifications.getAll();if(s&&s[V])return;let n=Number(t).toLocaleString("vi-VN");chrome.notifications.create(V,{type:"basic",iconUrl:"/icon/icon128.png",title:"C\xF4ng c\u1EE5 t\xEDnh hoa h\u1ED3ng Shopee",message:`\u0110ang b\u1EAFt \u0111\u1EA7u l\xEAn \u0111\u01A1n h\xF4m qua, \u0111\xE3 hi\u1EC7n: ${n} \u0111\u01A1n.`})}chrome.notifications.onClicked.addListener(t=>{t===H?(chrome.tabs.create({url:"https://affiliate.shopee.vn/"}),chrome.notifications.clear(H)):t===V&&(chrome.tabs.create({url:"https://affiliate.shopee.vn/report/conversion_report"}),chrome.notifications.clear(V))});async function oe(){var t;if(!W){W=!0;try{let s=P(new Date),{[R]:n}=await chrome.storage.local.get(R);if(n===s){console.debug("pollShopee: \u0111\xE3 th\xF4ng b\xE1o h\xF4m nay");return}let{s:e,e:r}=z(),h=`https://affiliate.shopee.vn/api/v3/report/list?page_size=500&page_num=1&purchase_time_s=${e}&purchase_time_e=${r}&version=1`,a=await fetch(h,{credentials:"include"});if(a.status===401){await X();return}if(!a.ok){console.warn("pollShopee: HTTP",a.status);return}let u=null;try{u=await a.json()}catch(d){console.warn("pollShopee: bad JSON",d);return}if(await new Promise(d=>setTimeout(d,100)),u&&u.code===0){let d=((t=u.data)==null?void 0:t.total_count)||0;d>0&&(await ne(d),await chrome.storage.local.set({[R]:s}),console.log(`pollShopee: ph\xE1t hi\u1EC7n ${d} \u0111\u01A1n h\xE0ng m\u1EDBi, b\u1EAFt \u0111\u1EA7u \u0111\u1ED3ng b\u1ED9...`),Y().catch(_=>{console.error("pollShopee: l\u1ED7i khi \u0111\u1ED3ng b\u1ED9 t\u1EF1 \u0111\u1ED9ng:",_)}))}}catch(s){console.error("pollShopee error:",s)}finally{W=!1}}}chrome.alarms.onAlarm.addListener(async t=>{if(t.name===q)try{await te();let{enableNotif:s}=await chrome.storage.local.get("enableNotif");if(s===!1){console.debug("[alarm] notifications disabled by user");return}let n=new Date().getHours();if(n<5||n>=17)return;Promise.resolve().then(()=>oe()).catch(e=>{console.warn("[alarm] pollShopee error:",e)})}catch(s){console.error("[alarm] handler error:",s)}else t.name===J&&Y().catch(s=>{console.error("[alarm] syncShopeeData error:",s)})});function Q(t,s,n=5){let e=[],r=new Date(t),h=new Date(s),a=24*60*60*1e3,u=new Date(r);for(;u<h;){let d=new Date(Math.min(u.getTime()+n*a,h.getTime()));e.push({start:new Date(u),end:new Date(d)}),u=new Date(d.getTime()+1e3)}return e}function se(t,s){let n=[],e=new Date(t),r=new Date(s),h=60*60*1e3,a=new Date(e);for(;a<r;){let u=new Date(Math.min(a.getTime()+h,r.getTime()));n.push({start:new Date(a),end:new Date(u)}),a=new Date(u.getTime()+1e3)}return n}async function F(t,s="orders",n=500,e=4500){var u,d,_,y;let r=Math.floor(t.start.getTime()/1e3),h=Math.floor(t.end.getTime()/1e3),a=s==="orders"?`https://affiliate.shopee.vn/api/v3/report/list?page_size=${n}&page_num=1&purchase_time_s=${r}&purchase_time_e=${h}&version=1`:`https://affiliate.shopee.vn/api/v1/click_report/list?click_time_s=${r}&click_time_e=${h}&page_num=1&page_size=${n}`;try{let S=await fetch(a,{credentials:"include"});if(!S.ok||S.status===401)return{chunks:[t],page1Data:null};let b=await S.json(),m=((u=b==null?void 0:b.data)==null?void 0:u.total_count)||0,c=((d=b==null?void 0:b.data)==null?void 0:d.list)||[];if(await new Promise(o=>setTimeout(o,100)),m<=e)return{chunks:[t],page1Data:c};let i=Q(t.start,t.end,1),f=[],T=new Map;for(let o of i){let l=Math.floor(o.start.getTime()/1e3),g=Math.floor(o.end.getTime()/1e3),p=s==="orders"?`https://affiliate.shopee.vn/api/v3/report/list?page_size=${n}&page_num=1&purchase_time_s=${l}&purchase_time_e=${g}&version=1`:`https://affiliate.shopee.vn/api/v1/click_report/list?click_time_s=${l}&click_time_e=${g}&page_num=1&page_size=${n}`;try{let w=await fetch(p,{credentials:"include"});if(!w.ok||w.status===401){f.push(o);continue}let k=await w.json(),C=((_=k==null?void 0:k.data)==null?void 0:_.total_count)||0,E=((y=k==null?void 0:k.data)==null?void 0:y.list)||[];if(await new Promise($=>setTimeout($,100)),C>e){let $=se(o.start,o.end);f.push(...$)}else{f.push(o);let $=`${l}_${g}`;T.set($,E)}await new Promise($=>setTimeout($,200))}catch(w){console.warn("splitDateRangeDynamic: l\u1ED7i khi ki\u1EC3m tra chunk ng\xE0y:",w),f.push(o)}}return{chunks:f,page1Data:T}}catch(S){return console.warn("splitDateRangeDynamic: l\u1ED7i khi ki\u1EC3m tra chunk:",S),{chunks:[t],page1Data:null}}}async function Y(){if(U){console.debug("syncShopeeData: \u0111ang sync, b\u1ECF qua");return}U=!0;try{await chrome.storage.local.set({syncStatus:"in_progress",lastSyncTime:Date.now()});let{syncDays:t=30}=await chrome.storage.local.get("syncDays"),s=new Date,n=new Date(s.getTime()-t*24*60*60*1e3),e=new Date(s);await ee(n,e)}catch(t){console.error("syncShopeeData error:",t),await chrome.storage.local.set({syncStatus:"error",syncError:t.message||"UNKNOWN_ERROR"})}finally{U=!1}}async function re(t,s){if(U){console.debug("syncShopeeDataForDateRange: \u0111ang sync, b\u1ECF qua");return}U=!0;try{await chrome.storage.local.set({syncStatus:"in_progress",lastSyncTime:Date.now()}),await ee(t,s)}catch(n){throw console.error("syncShopeeDataForDateRange error:",n),await chrome.storage.local.set({syncStatus:"error",syncError:n.message||"UNKNOWN_ERROR"}),n}finally{U=!1}}async function ee(t,s){var b,m;let n=Q(t,s,5);n.sort((c,i)=>i.end.getTime()-c.end.getTime());let e=[],r=new Map;for(let c=0;c<n.length;c++){let i=n[c];console.log(`syncShopeeData: \u0111ang ki\u1EC3m tra chunk ${c+1}/${n.length} (${P(i.start)} - ${P(i.end)})`);let f=await F(i,"orders");if(f.page1Data&&Array.isArray(f.page1Data)){let T=`${Math.floor(i.start.getTime()/1e3)}_${Math.floor(i.end.getTime()/1e3)}`;r.set(T,f.page1Data)}else f.page1Data instanceof Map&&f.page1Data.forEach((T,o)=>{r.set(o,T)});e=e.concat(f.chunks),c<n.length-1&&await new Promise(T=>setTimeout(T,100))}e.sort((c,i)=>i.end.getTime()-c.end.getTime());let h=[],a=500,u=9,d=await idb.getAllOrders();for(let c=0;c<e.length;c++){c>0&&await new Promise(C=>setTimeout(C,100));let i=e[c],f=Math.floor(i.start.getTime()/1e3),T=Math.floor(i.end.getTime()/1e3),o=`${f}_${T}`;console.log(`syncShopeeData: \u0111ang \u0111\u1ED3ng b\u1ED9 chunk ${c+1}/${e.length} (${P(i.start)} - ${P(i.end)})`);let l=r.get(o),g=1,p=!0,w=0,k=3;for(l&&l.length>0?(console.log(`syncShopeeData: t\xE1i s\u1EED d\u1EE5ng d\u1EEF li\u1EC7u page 1 (${l.length} items) cho chunk key: ${o}`),h=h.concat(l),g=2):console.log(`syncShopeeData: kh\xF4ng c\xF3 cache cho chunk key: ${o}, s\u1EBD g\u1ECDi API t\u1EEB page 1`);p&&g<=u;){let C=`https://affiliate.shopee.vn/api/v3/report/list?page_size=${a}&page_num=${g}&purchase_time_s=${f}&purchase_time_e=${T}&version=1`;try{let E=await fetch(C,{credentials:"include"});if(E.status===401)throw await chrome.storage.local.set({syncStatus:"error",syncError:"UNAUTHORIZED"}),await X(),new Error("UNAUTHORIZED");if(!E.ok){if((E.status===413||E.status===429)&&g===1){console.warn(`syncShopeeData: chunk ${c+1} g\u1EB7p l\u1ED7i ${E.status}, \u0111ang chia nh\u1ECF l\u1EA1i...`);let N=await F(i,"orders");N.chunks.sort((A,D)=>D.end.getTime()-A.end.getTime()),e=[...e.slice(0,c),...N.chunks,...e.slice(c+1)],e.sort((A,D)=>D.end.getTime()-A.end.getTime()),p=!1;break}throw new Error(`HTTP ${E.status}`)}let $=null;try{$=await E.json()}catch{throw new Error("BAD_JSON")}if(await new Promise(N=>setTimeout(N,100)),$&&$.code===0){let N=((b=$.data)==null?void 0:b.list)||[],A=((m=$.data)==null?void 0:m.total_count)||0;if(A>u*a&&g===1){console.warn(`syncShopeeData: chunk ${c+1} c\xF3 ${A} items (${Math.ceil(A/a)} trang), v\u01B0\u1EE3t qu\xE1 gi\u1EDBi h\u1EA1n. \u0110ang chia nh\u1ECF l\u1EA1i...`);let D=await F(i,"orders");D.chunks.sort((O,I)=>I.end.getTime()-O.end.getTime()),e=[...e.slice(0,c),...D.chunks,...e.slice(c+1)],e.sort((O,I)=>I.end.getTime()-O.end.getTime()),p=!1;break}h=h.concat(N),N.length===0||g*a>=A?p=!1:g>=u?(console.warn(`syncShopeeData: chunk ${c+1} \u0111\xE3 \u0111\u1EA1t gi\u1EDBi h\u1EA1n ${u} trang, c\xF3 th\u1EC3 c\xF2n d\u1EEF li\u1EC7u ch\u01B0a l\u1EA5y h\u1EBFt`),p=!1):(g++,await new Promise(D=>setTimeout(D,400)))}else throw new Error(($==null?void 0:$.msg)||"API_ERROR")}catch(E){if(console.error(`syncShopeeData: l\u1ED7i khi l\u1EA5y trang ${g} c\u1EE7a chunk ${c+1}:`,E),w++,w>=k)throw await chrome.storage.local.set({syncStatus:"error",syncError:E.message||"UNKNOWN_ERROR"}),E;await new Promise($=>setTimeout($,1e3*w))}}}let _=0,y=null;h.forEach(c=>{c.affiliate_id&&!y&&(y=c.affiliate_id,idb.setCurrentAffiliateId(c.affiliate_id).catch(()=>{}));let i=null;if(c.orders&&c.orders.length>0){let f=c.orders[0];f.order_id&&(i=`order_${f.order_id}`)}else c.checkout_id&&(i=`checkout_${c.checkout_id}`);i&&!d[i]?(d[i]={...c,storedAt:Date.now()},_++):i&&(d[i]={...d[i],...c,updatedAt:Date.now()})}),await idb.saveOrders(d),await chrome.storage.local.set({syncStatus:"success",lastSyncTime:Date.now(),lastSyncCount:_,totalOrdersCount:Object.keys(d).length}),console.log(`syncShopeeDataForDateRangeInternal: th\xE0nh c\xF4ng, ${_} orders m\u1EDBi, t\u1ED5ng ${Object.keys(d).length} orders`),Math.abs(s.getTime()-t.getTime())>2*24*60*60*1e3&&Z(t,s).catch(c=>{console.error("syncShopeeDataForDateRangeInternal: l\u1ED7i khi \u0111\u1ED3ng b\u1ED9 click t\u1EF1 \u0111\u1ED9ng:",c)})}async function Z(t,s){var n,e;if(B){console.debug("syncShopeeClicks: \u0111ang sync, b\u1ECF qua");return}B=!0;try{await chrome.storage.local.set({clickSyncStatus:"in_progress",lastClickSyncTime:Date.now()});let{maxClicksLimit:r=5e4}=await chrome.storage.local.get("maxClicksLimit"),h=Q(t,s,5);h.sort((o,l)=>l.end.getTime()-o.end.getTime());let a=[],u=new Map;for(let o=0;o<h.length;o++){let l=h[o];console.log(`syncShopeeClicks: \u0111ang ki\u1EC3m tra chunk ${o+1}/${h.length} (${P(l.start)} - ${P(l.end)})`);let g=await F(l,"clicks");if(g.page1Data&&Array.isArray(g.page1Data)){let p=`${Math.floor(l.start.getTime()/1e3)}_${Math.floor(l.end.getTime()/1e3)}`;u.set(p,g.page1Data),console.log(`syncShopeeClicks: \u0111\xE3 l\u01B0u cache page 1 cho chunk key: ${p} (${g.page1Data.length} clicks)`)}else g.page1Data instanceof Map?g.page1Data.forEach((p,w)=>{u.set(w,p),console.log(`syncShopeeClicks: \u0111\xE3 l\u01B0u cache page 1 cho chunk key: ${w} (${p.length} clicks)`)}):console.log(`syncShopeeClicks: chunk ${o+1} kh\xF4ng c\xF3 page1Data (c\xF3 th\u1EC3 b\u1ECB l\u1ED7i ho\u1EB7c kh\xF4ng c\xF3 d\u1EEF li\u1EC7u)`);a=a.concat(g.chunks),o<h.length-1&&await new Promise(p=>setTimeout(p,100))}a.sort((o,l)=>l.end.getTime()-o.end.getTime());let d=[],_=500,y=9,S=0,m={...await idb.getAllClicks()},c=Object.keys(m).length;if(c>r){console.log(`syncShopeeClicks: \u0111\xE3 c\xF3 ${c} clicks, v\u01B0\u1EE3t gi\u1EDBi h\u1EA1n ${r}, \u0111ang x\xF3a clicks c\u0169 tr\u01B0\u1EDBc khi sync...`);let o=Object.entries(m);o.sort((g,p)=>{let w=g[1].storedAt||g[1].updatedAt||0,k=p[1].storedAt||p[1].updatedAt||0;return w-k});let l=o.slice(-r);m={},l.forEach(([g,p])=>{m[g]=p}),console.log(`syncShopeeClicks: \u0111\xE3 x\xF3a ${c-r} clicks c\u0169, gi\u1EEF l\u1EA1i ${Object.keys(m).length} clicks`)}for(let o=0;o<a.length;o++){if(S>=r){console.warn(`syncShopeeClicks: \u0111\xE3 \u0111\u1EA1t gi\u1EDBi h\u1EA1n ${r} clicks, d\u1EEBng \u0111\u1ED3ng b\u1ED9`);break}o>0&&await new Promise(A=>setTimeout(A,100));let l=a[o],g=Math.floor(l.start.getTime()/1e3),p=Math.floor(l.end.getTime()/1e3),w=`${g}_${p}`;console.log(`syncShopeeClicks: \u0111ang \u0111\u1ED3ng b\u1ED9 chunk ${o+1}/${a.length} (${P(l.start)} - ${P(l.end)})`);let k=u.get(w),C=1,E=!0,$=0,N=3;if(k&&k.length>0){console.log(`syncShopeeClicks: t\xE1i s\u1EED d\u1EE5ng d\u1EEF li\u1EC7u page 1 (${k.length} clicks) cho chunk key: ${w}`);let A=r-S,D=k;k.length>A&&(D=k.slice(0,A),console.warn(`syncShopeeClicks: ch\u1EC9 l\u1EA5y ${A} clicks t\u1EEB cache \u0111\u1EC3 kh\xF4ng v\u01B0\u1EE3t gi\u1EDBi h\u1EA1n`)),d=d.concat(D),S+=D.length,C=2}else console.log(`syncShopeeClicks: kh\xF4ng c\xF3 cache cho chunk key: ${w}, s\u1EBD g\u1ECDi API t\u1EEB page 1`);for(;E&&C<=y&&S<r;){let A=`https://affiliate.shopee.vn/api/v1/click_report/list?click_time_s=${g}&click_time_e=${p}&page_num=${C}&page_size=${_}`;try{let D=await fetch(A,{credentials:"include"});if(D.status===401){await chrome.storage.local.set({clickSyncStatus:"error",clickSyncError:"UNAUTHORIZED"}),await X();return}if(!D.ok){if((D.status===413||D.status===429)&&C===1){console.warn(`syncShopeeClicks: chunk ${o+1} g\u1EB7p l\u1ED7i ${D.status}, \u0111ang chia nh\u1ECF l\u1EA1i...`);let I=await F(l,"clicks");I.chunks.sort((M,L)=>L.end.getTime()-M.end.getTime()),a=[...a.slice(0,o),...I.chunks,...a.slice(o+1)],a.sort((M,L)=>L.end.getTime()-M.end.getTime()),E=!1;break}throw new Error(`HTTP ${D.status}`)}let O=null;try{O=await D.json()}catch{throw new Error("BAD_JSON")}if(await new Promise(I=>setTimeout(I,100)),O&&O.code===0){let I=((n=O.data)==null?void 0:n.list)||[],M=((e=O.data)==null?void 0:e.total_count)||0;if(M>y*_&&C===1){console.warn(`syncShopeeClicks: chunk ${o+1} c\xF3 ${M} clicks (${Math.ceil(M/_)} trang), v\u01B0\u1EE3t qu\xE1 gi\u1EDBi h\u1EA1n. \u0110ang chia nh\u1ECF l\u1EA1i...`);let x=await F(l,"clicks");x.chunks.sort((K,G)=>G.end.getTime()-K.end.getTime()),a=[...a.slice(0,o),...x.chunks,...a.slice(o+1)],a.sort((K,G)=>G.end.getTime()-K.end.getTime()),E=!1;break}let L=r-S,j=I;I.length>L&&(j=I.slice(0,L),console.warn(`syncShopeeClicks: ch\u1EC9 l\u1EA5y ${L} clicks c\xF2n l\u1EA1i \u0111\u1EC3 kh\xF4ng v\u01B0\u1EE3t gi\u1EDBi h\u1EA1n`)),d=d.concat(j),S+=j.length,I.length===0||C*_>=M?E=!1:C>=y?(console.warn(`syncShopeeClicks: chunk ${o+1} \u0111\xE3 \u0111\u1EA1t gi\u1EDBi h\u1EA1n ${y} trang nh\u01B0ng c\xF2n ${M-C*_} clicks ch\u01B0a l\u1EA5y`),E=!1):(C++,await new Promise(x=>setTimeout(x,400))),S>=r&&(E=!1)}else throw new Error((O==null?void 0:O.msg)||"API_ERROR")}catch(D){if(console.error(`syncShopeeClicks: l\u1ED7i khi l\u1EA5y trang ${C} c\u1EE7a chunk ${o+1}:`,D),$++,$>=N){await chrome.storage.local.set({clickSyncStatus:"error",clickSyncError:D.message||"UNKNOWN_ERROR"});return}await new Promise(O=>setTimeout(O,1e3*$))}}}let i=0,f=null;d.forEach(o=>{o.affiliate_id&&!f&&(f=o.affiliate_id,idb.setCurrentAffiliateId(o.affiliate_id).catch(()=>{}));let l=`click_${o.click_id}`;m[l]?m[l]={...m[l],...o,updatedAt:Date.now()}:(m[l]={...o,storedAt:Date.now()},i++)});let T=Object.keys(m).length;if(T>r){console.log(`syncShopeeClicks: t\u1ED5ng s\u1ED1 clicks (${T}) v\u01B0\u1EE3t qu\xE1 gi\u1EDBi h\u1EA1n (${r}), \u0111ang x\xF3a c\xE1c clicks c\u0169 nh\u1EA5t...`);let o=Object.entries(m);o.sort((p,w)=>{let k=p[1].storedAt||p[1].updatedAt||0,C=w[1].storedAt||w[1].updatedAt||0;return k-C});let l=o.slice(-r),g={};l.forEach(([p,w])=>{g[p]=w}),m=g,console.log(`syncShopeeClicks: \u0111\xE3 x\xF3a ${T-r} clicks c\u0169, gi\u1EEF l\u1EA1i ${Object.keys(m).length} clicks`)}try{await idb.saveClicks(m),console.log(`syncShopeeClicks: l\u01B0u th\xE0nh c\xF4ng ${Object.keys(m).length} clicks`)}catch(o){throw console.error("syncShopeeClicks: l\u1ED7i khi l\u01B0u IndexedDB:",o),o}await chrome.storage.local.set({clickSyncStatus:"success",lastClickSyncTime:Date.now(),lastClickSyncCount:i,totalClicksCount:Object.keys(m).length}),console.log(`syncShopeeClicks: th\xE0nh c\xF4ng, ${i} clicks m\u1EDBi, t\u1ED5ng ${Object.keys(m).length} clicks`)}catch(r){console.error("syncShopeeClicks error:",r),await chrome.storage.local.set({clickSyncStatus:"error",clickSyncError:r.message||"UNKNOWN_ERROR"})}finally{B=!1}}chrome.contextMenus.onClicked.addListener(async(t,s)=>{if(t.menuItemId==="calculateCommission")chrome.action.openPopup();else if(t.menuItemId==="viewProductDetails"){let n=new URL(s.url),e=null,r=n.pathname.match(/\/product\/(\d+)/);if(r)e=r[1];else{let h=n.searchParams.get("i");h&&(e=h)}if(e)try{await chrome.tabs.sendMessage(s.id,{type:"SHOW_PRODUCT_STATS",productId:e})}catch{chrome.scripting.executeScript({target:{tabId:s.id},files:["js/content.js"]}).then(()=>{chrome.tabs.sendMessage(s.id,{type:"SHOW_PRODUCT_STATS",productId:e})})}else chrome.notifications.create({type:"basic",iconUrl:"/icon/icon128.png",title:"C\xF4ng c\u1EE5 t\xEDnh hoa h\u1ED3ng Shopee",message:"Kh\xF4ng t\xECm th\u1EA5y ID s\u1EA3n ph\u1EA9m trong URL n\xE0y."})}else t.menuItemId==="openOrderHistory"&&chrome.tabs.create({url:chrome.runtime.getURL("order-history.html")})});function v(t,s){try{if(typeof t=="function")return t(s),!0}catch(n){console.error("[Background] Error in safeSendResponse:",n)}return!1}chrome.runtime.onMessage.addListener((t,s,n)=>{if(t.type==="CALCULATE_PRODUCT_STATS")return ae(t.productId).then(e=>{v(n,{success:!0,stats:e})}).catch(e=>{v(n,{success:!1,error:e.message})}),!0;if(t.type==="SYNC_NOW")return v(n,{success:!0}),Y().catch(e=>{console.error("SYNC_NOW error:",e)}),!0;if(t.type==="SYNC_YESTERDAY")return v(n,{success:!0}),(async()=>{try{let{s:e,e:r}=z(),h=new Date(e*1e3),a=new Date(r*1e3);await re(h,a)}catch(e){console.error("SYNC_YESTERDAY error:",e)}})(),!0;if(t.type==="CREATE_AFFILIATE_LINK")return(async()=>{try{let e=await ie(t.originalLink,t.subIds);v(n,{success:!0,...e})}catch(e){v(n,{success:!1,error:e.message||"Unknown error"})}})(),!0;if(t.type==="OPEN_ORDER_HISTORY")return chrome.tabs.create({url:chrome.runtime.getURL("order-history.html")}),n({success:!0}),!0;if(t.type==="OPEN_CLICK_OVERVIEW")return chrome.tabs.create({url:chrome.runtime.getURL("click-overview.html")}),n({success:!0}),!0;if(t.type==="SYNC_CLICKS_NOW")return v(n,{success:!0}),(async()=>{try{let{clickSyncDays:e=14}=await chrome.storage.local.get("clickSyncDays"),r=new Date,h=new Date(r.getTime()-e*24*60*60*1e3),a=new Date(r);await Z(h,a)}catch(e){console.error("SYNC_CLICKS_NOW error:",e)}})(),!0;if(t.type==="SYNC_CLICKS_YESTERDAY")return v(n,{success:!0}),(async()=>{try{let{s:e,e:r}=z(),h=new Date(e*1e3),a=new Date(r*1e3);await Z(h,a)}catch(e){console.error("SYNC_CLICKS_YESTERDAY error:",e)}})(),!0;if(t.type==="CLEAR_CLICK_DATA")return(async()=>{try{await idb.clearClicks(),await chrome.storage.local.remove(["clickSyncStatus","lastClickSyncTime","totalClicksCount","lastClickSyncCount","clickSyncError"]),v(n,{success:!0})}catch(e){v(n,{success:!1,error:e.message})}})(),!0;if(t.type==="FETCH_PRICE_TRACKING")return(async()=>{try{let{itemId:e,days:r=90,currency:h="VND",productData:a=null}=t,u=await ce(e,r,h,a);v(n,{success:!0,data:u})}catch(e){v(n,{success:!1,error:e.message})}})(),!0});async function ae(t){try{let s=await idb.getAllOrders(),n=[],e=String(t).trim();if(console.log("Searching for productId:",e,"in orderHistory with",Object.keys(s).length,"orders"),Object.values(s).forEach(m=>{(m.orders||(m.list?m.list.flatMap(i=>i.orders||[]):[])).forEach(i=>{(i.items||[]).forEach(T=>{let o=String(T.item_id||"").trim(),l=String(T.model_id||"").trim();(o===e||l===e)&&(console.log("Found matching item:",{item_id:o,model_id:l,productId:e,item_name:T.item_name}),n.push({...m,item:T,order:i}))})})}),console.log("Found",n.length,"matching orders for productId:",e),n.length===0)return{totalOrders:0,totalGMV:0,totalCommission:0,lastOrderDate:null,lastOrderAmount:0,channels:{video:0,live:0,social:0}};n.sort((m,c)=>{let i=m.purchase_time||m.checkout_complete_time||0;return(c.purchase_time||c.checkout_complete_time||0)-i});let r=new Map;n.forEach(m=>{let c=m.item,i=m.order&&m.order.order_id||m.checkout_id||`order_${m.purchase_time}`;r.has(i)||r.set(i,{orderData:m,items:[]}),r.get(i).items.push(c)});let h=0,a=0,u=0,d=0,_=0,y=null,S=0;r.forEach(m=>{let c=m.orderData,i=m.items,f=i[0],T=parseFloat(f.item_gmv||f.actual_amount||f.item_price||0),o=i.every(k=>parseFloat(k.item_gmv||k.actual_amount||k.item_price||0)===T),l=0,g=0;o&&f.item_gmv?(l=T,g=parseFloat(f.item_commission||0)):(i.forEach(k=>{let C=parseFloat(k.item_gmv||k.actual_amount||k.item_price||0);l+=C}),c.affiliate_net_commission!==void 0?g=parseFloat(c.affiliate_net_commission||c.estimated_total_commission||0):i.forEach(k=>{let C=parseFloat((k.item_commission||0)+(k.capped_brand_commission||0));g+=C}));let p=f.referrer||c.referrer||"MXH";l=l/1e5,g=g/1e5,h+=l,a+=g,p.includes("Shopeevideo")||p.includes("Shopeevideo-Shopee")?u++:p.includes("Shopeelive")||p.includes("Shopeelive-Shopee")?d++:_++;let w=c.purchase_time||c.checkout_complete_time||0;w>S&&(S=w,y={...c,item:f,orderGMV:l})});let b=null;return y&&S>0&&(b=new Date(S*1e3).toLocaleDateString("vi-VN")),{totalOrders:r.size,totalGMV:h,totalCommission:a,lastOrderDate:b,lastOrderAmount:y?y.orderGMV||parseFloat((y.item.item_gmv||y.item.actual_amount||y.item.item_price||0)/1e5):0,channels:{video:u,live:d,social:_},formatted:{totalGMV:h.toLocaleString("vi-VN",{style:"currency",currency:"VND"}),totalCommission:a.toLocaleString("vi-VN",{style:"currency",currency:"VND"}),lastOrderAmount:y?(y.orderGMV||parseFloat((y.item.item_gmv||y.item.actual_amount||y.item.item_price||0)/1e5)).toLocaleString("vi-VN",{style:"currency",currency:"VND"}):"0 \u20AB"}}}catch(s){throw console.error("Error calculating product stats:",s),s}}async function ce(t,s=90,n="VND",e=null){var h;if(!((h=SERVER_CONFIG==null?void 0:SERVER_CONFIG.priceTracking)!=null&&h.endpoint))throw new Error("Ch\u01B0a c\u1EA5u h\xECnh API endpoint");let r=new URL(SERVER_CONFIG.priceTracking.endpoint);try{let a;if(e){let d={item_id:t,day:s,currency:n,product_data:e};a=await fetch(r.toString(),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(d)})}else r.searchParams.set("item_id",t),r.searchParams.set("day",s),r.searchParams.set("currency",n),a=await fetch(r.toString());if(!a.ok){if(a.status===404)return{prices:[],stats:{}};throw new Error(`API error: ${a.status}`)}let u=await a.json();return u&&u.success&&u.data?u.data:u&&(u.prices||u.stats)?u:{prices:[],stats:{}}}catch(a){throw console.error("[Price Tracking] Error:",a),a}}async function ie(t,s={}){var e;try{let r="https://affiliate.shopee.vn/api/v3/gql?q=batchCustomLink",h=`
            query batchGetCustomLink($linkParams: [CustomLinkParam!], $sourceCaller: SourceCaller){
                batchCustomLink(linkParams: $linkParams, sourceCaller: $sourceCaller){
                    shortLink
                    longLink
                    failCode
                }
            }
        `,a={linkParams:[{originalLink:t,advancedLinkParams:{subId1:s.subId1||"",subId2:s.subId2||"",subId3:s.subId3||"",subId4:s.subId4||"",subId5:s.subId5||""}}],sourceCaller:"CUSTOM_LINK_CALLER"},u=new AbortController,d=setTimeout(()=>u.abort(),5e3);try{let _=await fetch(r,{method:"POST",headers:{"Content-Type":"application/json; charset=UTF-8",Accept:"application/json, text/plain, */*"},credentials:"include",signal:u.signal,body:JSON.stringify({operationName:"batchGetCustomLink",query:h,variables:a})});if(clearTimeout(d),_.status===401)throw new Error("UNAUTHORIZED");if(!_.ok)throw new Error(`HTTP ${_.status}`);let y=await _.json();if(y.errors)throw new Error(((e=y.errors[0])==null?void 0:e.message)||"API Error");if(y.data&&y.data.batchCustomLink&&y.data.batchCustomLink.length>0){let S=y.data.batchCustomLink[0];if(S.failCode)throw new Error(`Fail code: ${S.failCode}`);return{shortLink:S.shortLink||"",longLink:S.longLink||""}}throw new Error("No data returned from API")}catch(_){throw clearTimeout(d),_.name==="AbortError"?new Error("Request timeout. Vui l\xF2ng th\u1EED l\u1EA1i."):_}}catch(r){throw console.error("createAffiliateLinkAPI error:",r),r}}chrome.runtime.setUninstallURL("https://addlivetag.com/extension/uninstall.html");
