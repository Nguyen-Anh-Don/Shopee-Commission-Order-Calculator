(()=>{var M=[],H=[],U=[],L=[],A={},R=null,z=null,V=[],X=[],q=null,K=null,B=0,E={},F=dt(j,300);document.addEventListener("DOMContentLoaded",function(){tt();let t=document.getElementById("filterForm");t&&t.addEventListener("submit",function(r){r.preventDefault(),j()});let e=document.getElementById("start_date"),i=document.getElementById("start_time"),l=document.getElementById("end_date"),n=document.getElementById("end_time"),a=document.getElementById("sub_id");e&&e.addEventListener("change",F),i&&i.addEventListener("change",F),l&&l.addEventListener("change",F),n&&n.addEventListener("change",F),a&&a.addEventListener("input",F);let o=document.getElementById("openOptionsBtn");o&&o.addEventListener("click",function(){chrome.tabs.create({url:chrome.runtime.getURL("options.html")})});let d=document.querySelectorAll(".quick-date-btn");d.forEach(r=>{r.addEventListener("click",async function(){let g=parseInt(this.getAttribute("data-days"));nt(g),d.forEach(O=>O.classList.remove("active")),this.classList.add("active"),z=null;let f=document.getElementById("start_date").value,y=document.getElementById("start_time").value||"00:00",S=document.getElementById("end_date").value,P=document.getElementById("end_time").value||"23:59";await w(),z=`${f}_${y}_${S}_${P}`,j()})}),$(document).off("click","#subIdStatsTable tbody button.btn-detail").on("click","#subIdStatsTable tbody button.btn-detail",function(){let r=$(this).data("key");r&&at(r)}),$(document).off("click","#subIdStatsTable tbody .cpc-value").on("click","#subIdStatsTable tbody .cpc-value",function(){let r=$(this).data("key");r&&bt(r)});let b=document.getElementById("detailModal");b&&b.addEventListener("hidden.bs.modal",function(){let r=document.querySelector(".modal-backdrop");r&&r.remove(),document.body.classList.remove("modal-open"),document.body.style.overflow="",document.body.style.paddingRight=""});let u=document.getElementById("configCPCBtn");u&&u.addEventListener("click",function(){ut(),new bootstrap.Modal(document.getElementById("cpcConfigModal")).show()});let _=document.getElementById("addSubIdCPCBtn");_&&_.addEventListener("click",function(){let r=document.getElementById("subIdCPCInput").value.trim(),g=parseFloat(document.getElementById("subIdCPCValue").value)||0;r&&(rt(r,g),document.getElementById("subIdCPCInput").value="",document.getElementById("subIdCPCValue").value="")});let h=document.getElementById("saveCPCConfigBtn");h&&h.addEventListener("click",function(){_t()}),Q()});async function tt(){try{let[t,e]=await Promise.all([idb.getAllClicks(),idb.getAllOrders()]);if(console.log("Click history loaded:",Object.keys(t).length,"items"),console.log("Order history loaded:",Object.keys(e).length,"items"),Object.keys(t).length===0&&Object.keys(e).length===0){console.log("No data found"),G();return}if(M=Object.values(t),H=et(e),M.length>0){let i=M[0];console.log("Sample click:",{click_id:i.click_id,sub_id:i.sub_id,parsed:N(i.sub_id||"")})}if(H.length>0){let i=H[0];console.log("Sample order:",{order_id:i.order_id,sub_id1:i.sub_id1,sub_id2:i.sub_id2,sub_id3:i.sub_id3,sub_id4:i.sub_id4,sub_id5:i.sub_id5,has_dash_sub_id1:(i.sub_id1||"").includes("-"),parsed_sub_id1:N(i.sub_id1||"")})}it(),await Q(),await w(),j(),document.getElementById("loadingMessage").style.display="none",document.getElementById("mainContent").style.display="block"}catch(t){console.error("Error loading click overview:",t),G()}}function et(t){let e=[];function i(l){if(!l||l.trim()==="")return{sub_id1:"",sub_id2:"",sub_id3:"",sub_id4:"",sub_id5:""};let n=l.split("-");return{sub_id1:n[0]||"",sub_id2:n[1]||"",sub_id3:n[2]||"",sub_id4:n[3]||"",sub_id5:n[4]||""}}return Object.entries(t).forEach(([l,n])=>{if(!n||typeof n!="object"||l.includes("report_")||l.includes("validation_")||l.includes("payment_"))return;let a=[];if(n.orders&&Array.isArray(n.orders)&&n.orders.length>0)a=n.orders;else if(n.list&&Array.isArray(n.list))a=n.list.flatMap(o=>o.orders&&Array.isArray(o.orders)?o.orders:[]);else if(n.items&&Array.isArray(n.items)&&n.items.length>0)a=[n];else if(n.checkout_id&&!n.orders)return;a.length!==0&&a.forEach(o=>{if(!o||typeof o!="object")return;let d=o.items;if(!d||!Array.isArray(d)||d.length===0)return;let b=n.purchase_time||o.purchase_time,u=b?b>9466848e5?b:b*1e3:null,_=n.utm_content||o.utm_content||"",h=n.click_id||o.click_id||"",r=n.product_type||o.product_type||"",g=n.internal_source||o.internal_source||"",f=n.indirect_source||o.indirect_source||"",y,S,P,O,s;if(_.includes("-")){let m=i(_);y=m.sub_id1||"",S=m.sub_id2||"",P=m.sub_id3||"",O=m.sub_id4||"",s=m.sub_id5||""}else y=_,S=h,P=r,O=g,s=f;let c=n.estimated_total_commission_with_mcn?parseFloat(n.estimated_total_commission_with_mcn)>=1e5?parseFloat(n.estimated_total_commission_with_mcn)/1e5:parseFloat(n.estimated_total_commission_with_mcn)/100:0;d.forEach(m=>{if(!m||typeof m!="object")return;let C=m.actual_amount?m.actual_amount>1e3?parseFloat(m.actual_amount)/1e5:parseFloat(m.actual_amount):0;e.push({order_id:o.order_sn||o.order_id||"",checkout_id:n.checkout_id||"",purchase_time_ts:u,order_time:u?new Date(u).toISOString().slice(0,19).replace("T"," "):"",click_time_ts:n.click_time||o.click_time?n.click_time||o.click_time>9466848e5?n.click_time||o.click_time:(n.click_time||o.click_time)*1e3:null,click_time:n.click_time||o.click_time?new Date(n.click_time||o.click_time>9466848e5?n.click_time||o.click_time:(n.click_time||o.click_time)*1e3).toISOString().slice(0,19).replace("T"," "):"",completion_time:n.checkout_complete_time||o.checkout_complete_time?new Date(n.checkout_complete_time||o.checkout_complete_time>9466848e5?n.checkout_complete_time||o.checkout_complete_time:(n.checkout_complete_time||o.checkout_complete_time)*1e3).toISOString().slice(0,19).replace("T"," "):"",sub_id1:y||"",sub_id2:S||"",sub_id3:P||"",sub_id4:O||"",sub_id5:s||"",total_order_commission:c,actual_order_value:C})})})}),e}function N(t){if(!t||t.trim()==="")return{sub_id1:"",sub_id2:"",sub_id3:"",sub_id4:"",sub_id5:""};let e=t.split("-");return{sub_id1:e[0]||"",sub_id2:e[1]||"",sub_id3:e[2]||"",sub_id4:e[3]||"",sub_id5:e[4]||""}}async function w(){var y,S,P,O;await Q();let t={},e=(y=document.getElementById("start_date"))==null?void 0:y.value,i=((S=document.getElementById("start_time"))==null?void 0:S.value)||"00:00",l=(P=document.getElementById("end_date"))==null?void 0:P.value,n=((O=document.getElementById("end_time"))==null?void 0:O.value)||"23:59",a=null,o=null;if(e){let[s,c,m]=e.split("-").map(Number),[C,I]=(i||"00:00").split(":").map(Number);a=new Date(s,c-1,m,C,I,0,0).getTime()}if(l){let[s,c,m]=l.split("-").map(Number),[C,I]=(n||"23:59").split(":").map(Number);o=new Date(s,c-1,m,C,I,59,999).getTime()}let d=M.filter(s=>{if(!s.click_time)return!1;let c=s.click_time>9466848e5?s.click_time:s.click_time*1e3;return!(a!==null&&c<a||o!==null&&c>o)});V=d;let b=H.filter(s=>{let c=s.purchase_time_ts;return!c&&s.order_time&&(c=new Date(s.order_time).getTime()),(!c||isNaN(c))&&(c=s.click_time_ts),(!c||isNaN(c))&&(c=s.click_time?new Date(s.click_time).getTime():null),(!c||isNaN(c))&&(c=s.completion_time?new Date(s.completion_time).getTime():null),!(!c||isNaN(c)||a!==null&&c<a||o!==null&&c>o)});X=b;let u={},_={},h={};if(d.forEach(s=>{let c=s.sub_id;if(!c||c.trim()==="")return;let m=`full:${c}`;_[m]||(_[m]=0),_[m]++;let C=N(c);for(let I=1;I<=5;I++){let v=`sub_id${I}`,p=C[v];if(p&&p.trim()!==""){let k=`${v}:${p}`;u[k]||(u[k]=0,h[k]=[]),u[k]++,h[k].push({click_id:s.click_id||"",sub_id:s.sub_id||"",click_time:s.click_time?s.click_time>9466848e5?s.click_time:s.click_time*1e3:null,click_time_formatted:s.click_time?new Date(s.click_time>9466848e5?s.click_time:s.click_time*1e3).toISOString().slice(0,19).replace("T"," "):""})}}}),M.length>0){let s=M[0];console.log("Sample click sub_id:",s.sub_id),console.log("Parsed click:",N(s.sub_id)),console.log("Sample clicksBySubIdParts:",Object.keys(u).slice(0,5))}let r={},g={},f={};if(b.forEach(s=>{let c=s.order_id;if(!c)return;let m=s.total_order_commission||0;for(let C=1;C<=5;C++){let I=`sub_id${C}`,v=s[I];if(!(!v||v.trim()===""))if(v.includes("-")){let p=N(v);for(let k=1;k<=5;k++){let x=p[`sub_id${k}`];if(x&&x.trim()!==""){let T=`sub_id${k}:${x}`;r[T]||(r[T]=new Set,f[T]=[]),r[T].has(c)||(r[T].add(c),g[T]||(g[T]=0),g[T]+=m,f[T].push({order_id:s.order_id||"",checkout_id:s.checkout_id||"",purchase_time_ts:s.purchase_time_ts,order_time:s.order_time||"",click_time:s.click_time||"",completion_time:s.completion_time||"",total_order_commission:s.total_order_commission||0,actual_order_value:s.actual_order_value||0,sub_id1:s.sub_id1||"",sub_id2:s.sub_id2||"",sub_id3:s.sub_id3||"",sub_id4:s.sub_id4||"",sub_id5:s.sub_id5||""}))}}}else{let p=`${I}:${v}`;r[p]||(r[p]=new Set,f[p]=[]),r[p].has(c)||(r[p].add(c),g[p]||(g[p]=0),g[p]+=m,f[p].push({order_id:s.order_id||"",checkout_id:s.checkout_id||"",purchase_time_ts:s.purchase_time_ts,order_time:s.order_time||"",click_time:s.click_time||"",completion_time:s.completion_time||"",total_order_commission:s.total_order_commission||0,actual_order_value:s.actual_order_value||0,sub_id1:s.sub_id1||"",sub_id2:s.sub_id2||"",sub_id3:s.sub_id3||"",sub_id4:s.sub_id4||"",sub_id5:s.sub_id5||""}))}}}),b.length>0){let s=b[0];console.log("Sample order sub_ids:",{sub_id1:s.sub_id1,sub_id2:s.sub_id2,sub_id3:s.sub_id3,sub_id4:s.sub_id4,sub_id5:s.sub_id5}),console.log("Sample orderIdsBySubIdKey:",Object.keys(r).slice(0,5)),console.log("Total clicks keys:",Object.keys(u).length),console.log("Total orders keys:",Object.keys(r).length);let c=new Set(Object.keys(u)),m=new Set(Object.keys(r)),C=[...c].filter(I=>m.has(I));console.log("Matching keys count:",C.length),C.length>0&&console.log("Sample matching keys:",C.slice(0,5))}Object.keys(u).forEach(s=>{let[c,m]=s.split(":");t[s]||(t[s]={subId:m,subIdType:c,sub_id1:"",sub_id2:"",sub_id3:"",sub_id4:"",sub_id5:"",clicks:0,orders:0,commission:0,cost:0,profit:0,epc:0,cvr:0,rating:"",clickDetails:[],orderDetails:[]},c==="sub_id1"?t[s].sub_id1=m:c==="sub_id2"?t[s].sub_id2=m:c==="sub_id3"?t[s].sub_id3=m:c==="sub_id4"?t[s].sub_id4=m:c==="sub_id5"&&(t[s].sub_id5=m)),t[s].clicks=u[s],t[s].clickDetails=h[s]||[]}),Object.keys(r).forEach(s=>{let[c,m]=s.split(":");t[s]||(t[s]={subId:m,subIdType:c,sub_id1:"",sub_id2:"",sub_id3:"",sub_id4:"",sub_id5:"",clicks:0,orders:0,commission:0,cost:0,profit:0,epc:0,cvr:0,rating:"",clickDetails:[],orderDetails:[]}),t[s].orders=r[s].size,t[s].commission=g[s]||0,t[s].orderDetails=f[s]||[],c==="sub_id1"?t[s].sub_id1=m:c==="sub_id2"?t[s].sub_id2=m:c==="sub_id3"?t[s].sub_id3=m:c==="sub_id4"?t[s].sub_id4=m:c==="sub_id5"&&(t[s].sub_id5=m)}),Object.keys(t).forEach(s=>{let c=t[s];if(c.epc=c.clicks>0?c.commission/c.clicks:0,c.cvr=c.clicks>0?c.orders/c.clicks:0,c.clickDetails&&c.clickDetails.length>0){let m=0,C={};c.clickDetails.forEach(p=>{let k=p.sub_id||"";C[k]=(C[k]||0)+1});let I=0,v=0;Object.entries(C).forEach(([p,k])=>{let x=p&&E[p]?E[p]:B;m+=k*x,I+=x*k,v+=k}),c.cost=m,c.avgCPC=v>0?I/v:B}else c.cost=c.clicks*B,c.avgCPC=B;c.profit=c.commission-c.cost,c.profit<0?c.rating="L\u1ED7":c.cvr<.01?c.rating="Kh\xF4ng hi\u1EC7u qu\u1EA3":c.profit>0&&c.epc>1e3&&c.cvr>.02?c.rating="L\u1EDDi":c.rating="Ti\u1EC1m n\u0103ng"}),U=Object.values(t),A={},Object.entries(t).forEach(([s,c])=>{A[s]=c})}function it(){let t=new Date,e=new Date;e.setDate(e.getDate()-7);let i=document.getElementById("start_date"),l=document.getElementById("end_date");i&&!i.value&&(i.value=e.toISOString().split("T")[0]),l&&!l.value&&(l.value=t.toISOString().split("T")[0]),document.querySelectorAll(".quick-date-btn").forEach(a=>{a.classList.remove("active"),a.getAttribute("data-days")==="7"&&a.classList.add("active")})}function nt(t){let e=new Date,i=new Date;i.setDate(i.getDate()-t);let l=document.getElementById("start_date"),n=document.getElementById("end_date");l&&(l.value=i.toISOString().split("T")[0]),n&&(n.value=e.toISOString().split("T")[0])}function J(t,e){if(!e||e.trim()==="")return!0;let i=t.sub_id||"";if(!i)return!1;let l=N(i);return l.sub_id1&&l.sub_id1.includes(e)||l.sub_id2&&l.sub_id2.includes(e)||l.sub_id3&&l.sub_id3.includes(e)||l.sub_id4&&l.sub_id4.includes(e)||l.sub_id5&&l.sub_id5.includes(e)||i.includes(e)}function st(t,e){return!e||e.trim()===""?!0:t.sub_id1&&t.sub_id1.includes(e)||t.sub_id2&&t.sub_id2.includes(e)||t.sub_id3&&t.sub_id3.includes(e)||t.sub_id4&&t.sub_id4.includes(e)||t.sub_id5&&t.sub_id5.includes(e)||t.utm_content&&t.utm_content.includes(e)}function j(){let t=document.getElementById("start_date").value,e=document.getElementById("start_time").value||"00:00",i=document.getElementById("end_date").value,l=document.getElementById("end_time").value||"23:59",n=document.getElementById("sub_id").value.trim(),a=`${t}_${e}_${i}_${l}`;(z!==a||U.length===0)&&(w(),z=a),L=U.filter(_=>{if(n!==""){let h=_.sub_id1&&_.sub_id1.includes(n),r=_.sub_id2&&_.sub_id2.includes(n),g=_.sub_id3&&_.sub_id3.includes(n),f=_.sub_id4&&_.sub_id4.includes(n),y=_.sub_id5&&_.sub_id5.includes(n),S=_.subId&&_.subId.includes(n);if(!h&&!r&&!g&&!f&&!y&&!S)return!1}return!0});let d=_=>{if(!_)return"";let[h,r,g]=_.split("-");return`${g}/${r}/${h}`},b=document.getElementById("startDate"),u=document.getElementById("endDate");if(b&&(b.textContent=d(t)||""),u){let _=d(i);t===i?u.textContent="":u.textContent=" - "+_}lt(n),gt(n),ct()}function ct(){let t=$("#subIdStatsTable").DataTable();if(t&&t.destroy(),L.length===0){document.getElementById("noFilterResultsMessage").style.display="block";return}document.getElementById("noFilterResultsMessage").style.display="none",L.sort((i,l)=>l.clicks-i.clicks);let e=$("#subIdStatsTable").DataTable({data:L,columns:[{data:"subIdType",render:i=>i||"-"},{data:"sub_id1",render:i=>i||"-"},{data:"sub_id2",render:i=>i||"-"},{data:"sub_id3",render:i=>i||"-"},{data:"sub_id4",render:i=>i||"-"},{data:"sub_id5",render:i=>i||"-"},{data:"clicks",render:i=>i.toLocaleString("vi-VN")},{data:"orders",render:i=>i.toLocaleString("vi-VN")},{data:"commission",render:i=>D(i)},{data:"epc",render:i=>D(i)},{data:"cvr",render:i=>(i*100).toFixed(2)+"%"},{data:"avgCPC",render:(i,l,n)=>{let a=i||0;return`<span class="cpc-value" data-key="${`${n.subIdType}:${n.subId}`}" style="cursor: pointer; text-decoration: underline; color: #0d6efd;" title="Click \u0111\u1EC3 c\u1EA5u h\xECnh CPC">${D(a)}</span>`}},{data:"profit",render:i=>D(i)},{data:"rating",render:i=>{let l="rating-potential";return i==="L\u1EDDi"?l="rating-profit":i==="L\u1ED7"?l="rating-loss":i==="Kh\xF4ng hi\u1EC7u qu\u1EA3"&&(l="rating-ineffective"),`<span class="${l}">${i}</span>`}},{data:null,orderable:!1,render:(i,l,n)=>`<button class="btn btn-sm btn-info btn-detail" data-key="${`${n.subIdType}:${n.subId}`}" title="Xem chi ti\u1EBFt">\u{1F50D}</button>`}],order:[[6,"desc"]],pageLength:25,language:{emptyTable:"Kh\xF4ng c\xF3 d\u1EEF li\u1EC7u",info:"Hi\u1EC3n th\u1ECB _START_ \u0111\u1EBFn _END_ trong t\u1ED5ng s\u1ED1 _TOTAL_ m\u1EE5c",infoEmpty:"Hi\u1EC3n th\u1ECB 0 \u0111\u1EBFn 0 trong t\u1ED5ng s\u1ED1 0 m\u1EE5c",infoFiltered:"(\u0111\xE3 l\u1ECDc t\u1EEB _MAX_ m\u1EE5c)",lengthMenu:"Hi\u1EC3n th\u1ECB _MENU_ m\u1EE5c",loadingRecords:"\u0110ang t\u1EA3i...",processing:"\u0110ang x\u1EED l\xFD...",search:"T\xECm ki\u1EBFm:",zeroRecords:"Kh\xF4ng t\xECm th\u1EA5y k\u1EBFt qu\u1EA3",paginate:{first:"\u0110\u1EA7u",last:"Cu\u1ED1i",next:"Sau",previous:"Tr\u01B0\u1EDBc"}}})}function W(t,e){let i=`${t}:${e}`;return A[i]?A[i]:L.find(l=>l.subIdType===t&&l.subId===e)}function ot(t=""){let e=t?V.filter(f=>J(f,t)):V,i=t?X.filter(f=>st(f,t)):X,l=new Set,n={};e.forEach(f=>{f.click_id&&l.add(f.click_id);let y=f.sub_id||"";y&&(n[y]=(n[y]||0)+1)});let a=l.size,o=new Set,d=0;i.forEach(f=>{f.order_id&&(o.has(f.order_id)||(o.add(f.order_id),d+=f.total_order_commission||0))});let b=o.size,u=0;Object.entries(n).forEach(([f,y])=>{let S=E[f]||B;u+=y*S});let _=d-u,h=a>0?d/a:0,r=a>0?b/a:0,g=L?L.length:0;return{totalClicks:a,totalOrders:b,totalCommission:d,avgEPC:h,avgCVR:r,totalProfit:_,totalCost:u,uniqueSubIds:g}}function lt(t=""){let e=ot(t),i=document.getElementById("summaryStatsCard");e.totalClicks>0||e.totalOrders>0?i&&(i.style.display="block"):i&&(i.style.display="none");let l=document.getElementById("summaryTotalClicks");l&&(l.textContent=e.totalClicks.toLocaleString("vi-VN"));let n=document.getElementById("summaryTotalOrders");n&&(n.textContent=e.totalOrders.toLocaleString("vi-VN"));let a=document.getElementById("summaryTotalCommission");a&&(a.textContent=D(e.totalCommission));let o=document.getElementById("summaryAvgEPC");o&&(o.textContent=D(e.avgEPC));let d=document.getElementById("summaryAvgCVR");d&&(d.textContent=(e.avgCVR*100).toFixed(2)+"%");let b=document.getElementById("summaryTotalProfit");b&&(b.textContent=D(e.totalProfit));let u=document.getElementById("summaryUniqueSubIds");u&&(u.textContent=e.uniqueSubIds.toLocaleString("vi-VN"))}function D(t){return new Intl.NumberFormat("vi-VN",{style:"currency",currency:"VND"}).format(t)}function G(){document.getElementById("loadingMessage").style.display="none",document.getElementById("mainContent").style.display="none";let t=document.getElementById("noDataMessage");t&&(t.style.display="block");let e=document.getElementById("summaryStatsCard");e&&(e.style.display="none")}function at(t){let e=A[t];if(!e){let u=t.split(":");u.length===2&&(e=W(u[0],u[1]))}if(!e){alert("Kh\xF4ng t\xECm th\u1EA5y d\u1EEF li\u1EC7u chi ti\u1EBFt!");return}let i=document.getElementById("detailModal");if(!i){console.error("Modal not found!");return}if(R){try{R.dispose()}catch{}R=null}let l=document.querySelector(".modal-backdrop");l&&l.remove(),document.body.classList.remove("modal-open"),document.body.style.overflow="",document.body.style.paddingRight="";let n=i.querySelector("#detailModalTitle");n&&(n.textContent=`Chi ti\u1EBFt: ${e.subIdType} = ${e.subId}`);let a=i.querySelector("#detailClicksCount");a&&(a.textContent=e.clickDetails?e.clickDetails.length:0);let o=i.querySelector("#detailOrdersCount");o&&(o.textContent=e.orderDetails?e.orderDetails.length:0);let d=i.querySelector("#detailClicksList");d&&(e.clickDetails&&e.clickDetails.length>0?d.innerHTML=e.clickDetails.map((u,_)=>{let h=u.click_time_formatted||(u.click_time?new Date(u.click_time).toLocaleString("vi-VN"):"N/A"),r=u.sub_id||"-";return`
                    <tr>
                        <td>${_+1}</td>
                        <td>${u.click_id||"-"}</td>
                        <td><code style="font-size: 11px;">${r}</code></td>
                        <td>${h}</td>
                    </tr>
                `}).join(""):d.innerHTML="<tr><td colspan='4' class='text-center text-muted'>Kh\xF4ng c\xF3 d\u1EEF li\u1EC7u click</td></tr>");let b=i.querySelector("#detailOrdersList");b&&(e.orderDetails&&e.orderDetails.length>0?b.innerHTML=e.orderDetails.map((u,_)=>{let h=u.order_time||(u.purchase_time_ts?new Date(u.purchase_time_ts).toLocaleString("vi-VN"):"N/A"),r=D(u.total_order_commission||0),g=D(u.actual_order_value||0),f=[u.sub_id1,u.sub_id2,u.sub_id3,u.sub_id4,u.sub_id5].filter(y=>y&&y.trim()).join("-");return`
                    <tr>
                        <td>${_+1}</td>
                        <td><code>${u.order_id||"-"}</code></td>
                        <td><code style="font-size: 11px;">${f||"-"}</code></td>
                        <td>${h}</td>
                        <td class="text-end">${r}</td>
                        <td class="text-end">${g}</td>
                    </tr>
                `}).join(""):b.innerHTML="<tr><td colspan='6' class='text-center text-muted'>Kh\xF4ng c\xF3 d\u1EEF li\u1EC7u \u0111\u01A1n h\xE0ng</td></tr>"),R=new bootstrap.Modal(i,{backdrop:!0,keyboard:!0,focus:!0}),R.show()}function dt(t,e){let i;return function(...n){let a=()=>{clearTimeout(i),t(...n)};clearTimeout(i),i=setTimeout(a,e)}}async function Q(){try{let t=await chrome.storage.local.get(["averageCPC","subIdCPC"]);B=t.averageCPC||0,E=t.subIdCPC||{}}catch(t){console.error("Error loading CPC config:",t),B=0,E={}}}async function Y(){try{await chrome.storage.local.set({averageCPC:B,subIdCPC:E})}catch(t){console.error("Error saving CPC config:",t)}}function ut(){document.getElementById("averageCPC").value=B,Z()}function Z(){let t=document.getElementById("subIdCPCList");if(t){if(Object.keys(E).length===0){t.innerHTML="<tr><td colspan='3' class='text-center text-muted'>Ch\u01B0a c\xF3 c\u1EA5u h\xECnh CPC theo SubID</td></tr>";return}t.innerHTML=Object.entries(E).map(([e,i])=>`
                <tr>
                    <td><code style="font-size: 11px;">${e}</code></td>
                    <td>${D(i)}</td>
                    <td>
                        <button class="btn btn-sm btn-danger btn-remove-cpc" data-subid="${e.replace(/"/g,"&quot;")}">X\xF3a</button>
                    </td>
                </tr>
            `).join(""),t.querySelectorAll(".btn-remove-cpc").forEach(e=>{e.addEventListener("click",function(){let i=this.getAttribute("data-subid");i&&confirm(`B\u1EA1n c\xF3 ch\u1EAFc ch\u1EAFn mu\u1ED1n x\xF3a CPC cho SubID: ${i}?`)&&mt(i)})})}}function rt(t,e){E[t]=e,Z()}function mt(t){t&&E[t]!==void 0&&(delete E[t],Z())}async function _t(){B=parseFloat(document.getElementById("averageCPC").value)||0,await Y(),await w(),j(),alert(`\u2705 \u0110\xE3 l\u01B0u c\u1EA5u h\xECnh CPC th\xE0nh c\xF4ng!

C\xE1c t\xEDnh to\xE1n \u0111\xE3 \u0111\u01B0\u1EE3c c\u1EADp nh\u1EADt t\u1EF1 \u0111\u1ED9ng.`);let t=bootstrap.Modal.getInstance(document.getElementById("cpcConfigModal"));t&&t.hide()}async function bt(t){let e=A[t];if(!e){let d=t.split(":");d.length===2&&(e=W(d[0],d[1]))}if(!e){alert("Kh\xF4ng t\xECm th\u1EA5y d\u1EEF li\u1EC7u!");return}let i=new Set;if(e.clickDetails&&e.clickDetails.length>0&&e.clickDetails.forEach(d=>{let b=d.sub_id||"";b&&b.trim()!==""&&i.add(b)}),i.size===0){alert("Kh\xF4ng c\xF3 d\u1EEF li\u1EC7u click \u0111\u1EC3 c\u1EA5u h\xECnh CPC!");return}let l=Array.from(i)[0],n=E[l]||B,a=prompt(`C\u1EA5u h\xECnh CPC cho ${e.subIdType} = ${e.subId}

S\u1ED1 SubID duy nh\u1EA5t: ${i.size}
CPC hi\u1EC7n t\u1EA1i: ${D(n)}

Nh\u1EADp CPC m\u1EDBi (VND):`,n.toString());if(a===null)return;let o=parseFloat(a);if(isNaN(o)||o<0){alert("CPC kh\xF4ng h\u1EE3p l\u1EC7! Vui l\xF2ng nh\u1EADp s\u1ED1 >= 0");return}i.forEach(d=>{o===B?delete E[d]:E[d]=o}),await Y(),await w(),j(),alert(`\u2705 \u0110\xE3 c\u1EADp nh\u1EADt CPC th\xE0nh c\xF4ng!

CPC m\u1EDBi: ${D(o)}
\xC1p d\u1EE5ng cho ${i.size} SubID`)}function ft(t=""){let e={totalClicks:0,platformStats:{},regionStats:{},subIdStats:{}},i=t?V.filter(n=>J(n,t)):V,l=new Set;return i.forEach(n=>{n.click_id&&l.add(n.click_id)}),e.totalClicks=l.size,i.forEach(n=>{let a=n.sub_id||"",o=n.direct_source||"",d=n.click_region||"";o&&o.trim()!==""&&(e.platformStats[o]=(e.platformStats[o]||0)+1),d&&d.trim()!==""&&(e.regionStats[d]=(e.regionStats[d]||0)+1),a&&a.trim()!==""&&(e.subIdStats[a]=(e.subIdStats[a]||0)+1)}),e}function gt(t=""){let e=ft(t),i=document.getElementById("clickAnalysisSection");if(e.totalClicks===0){i&&(i.style.display="none");return}i&&(i.style.display="block");let l=document.getElementById("analysisTotalClicks");l&&(l.textContent=e.totalClicks.toLocaleString("vi-VN"));let n=Object.entries(e.platformStats).sort((o,d)=>d[1]-o[1])[0];if(n){let o=document.getElementById("topPlatform"),d=document.getElementById("topPlatformClicks");o&&(o.textContent=n[0]),d&&(d.textContent=`${n[1].toLocaleString("vi-VN")} clicks`)}let a=Object.entries(e.regionStats).sort((o,d)=>d[1]-o[1])[0];if(a){let o=document.getElementById("topRegion"),d=document.getElementById("topRegionClicks");o&&(o.textContent=a[0]),d&&(d.textContent=`${a[1].toLocaleString("vi-VN")} clicks`)}pt(e.platformStats,e.totalClicks),yt(e.regionStats),Ct(e.subIdStats,e.totalClicks)}function pt(t,e){let i=document.getElementById("platformDistributionChart");if(!i)return;q&&q.destroy();let l=Object.keys(t).sort((o,d)=>t[d]-t[o]),n=l.map(o=>t[o]),a=n.map(o=>(o/e*100).toFixed(1));q=new Chart(i,{type:"doughnut",data:{labels:l.map((o,d)=>`${o} (${a[d]}%)`),datasets:[{data:n,backgroundColor:["#FF6384","#36A2EB","#FFCE56","#4BC0C0","#9966FF","#FF9F40","#FF6384"]}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"bottom"}}}})}function yt(t){let e=document.getElementById("regionClicksChart");if(!e)return;K&&K.destroy();let i=Object.keys(t).sort((n,a)=>t[a]-t[n]),l=i.map(n=>t[n]);K=new Chart(e,{type:"bar",data:{labels:i,datasets:[{label:"Clicks",data:l,backgroundColor:"#36A2EB"}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{y:{beginAtZero:!0}}}})}function Ct(t,e){let i=document.getElementById("topSubIdTableBody");if(!i)return;let l=Object.entries(t).sort((n,a)=>a[1]-n[1]).slice(0,10);if(l.length===0){i.innerHTML="<tr><td colspan='4' class='text-center text-muted'>Kh\xF4ng c\xF3 d\u1EEF li\u1EC7u</td></tr>";return}i.innerHTML=l.map(([n,a],o)=>{let d=(a/e*100).toFixed(1);return`
                <tr>
                    <td>${o+1}</td>
                    <td><code style="font-size: 11px;">${n}</code></td>
                    <td>${a.toLocaleString("vi-VN")}</td>
                    <td>${d}%</td>
                </tr>
            `}).join("")}})();
