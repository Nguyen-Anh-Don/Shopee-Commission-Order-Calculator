(()=>{var N="shopeeExtensionDB";var y=null,m=null,S=null;async function w(){if(S)return S;try{if(typeof chrome<"u"&&chrome.storage&&chrome.storage.local){let r=await chrome.storage.local.get("currentAffiliateId");if(r&&r.currentAffiliateId)return S=r.currentAffiliateId,r.currentAffiliateId}}catch(r){typeof console<"u"&&console.warn&&console.warn("Cannot access chrome.storage:",r)}return null}async function E(r){if(r){S=r;try{await chrome.storage.local.set({currentAffiliateId:r})}catch(e){typeof console<"u"&&console.warn&&console.warn("Cannot save affiliate_id to chrome.storage:",e)}}}function u(){return typeof indexedDB>"u"||!indexedDB?Promise.reject(new Error("IndexedDB is not available in this context")):m||(m=new Promise((r,e)=>{if(y)try{let i=y.objectStoreNames;if(i&&i.length>0){let n=m;m=null,r(y);return}}catch(i){typeof console<"u"&&console.warn&&console.warn("Database connection lost, reopening...",i),y=null}try{let i=indexedDB.open(N,3);i.onerror=()=>{let n=i.error||new Error("Unknown IndexedDB error");typeof console<"u"&&console.error&&console.error("IndexedDB open error:",n);let s=m;m=null,e(n)},i.onsuccess=()=>{try{if(y=i.result,!y){let s=m;m=null,e(new Error("Database result is null"));return}if(!y.objectStoreNames){let s=m;m=null,e(new Error("Database objectStoreNames is not available"));return}y.onclose=()=>{typeof console<"u"&&console.warn&&console.warn("Database connection closed"),y=null,m=null},y.onerror=s=>{typeof console<"u"&&console.error&&console.error("Database error:",s)};let n=m;m=null,r(y)}catch(n){let s=m;m=null,e(new Error("Error initializing database: "+(n.message||n)))}},i.onupgradeneeded=n=>{try{let s=n.target.result;if(!s){typeof console<"u"&&console.error&&console.error("Database upgrade: database result is null");return}let c=n.oldVersion||0;if(typeof console<"u"&&console.log&&console.log(`Upgrading database from version ${c} to 3`),c<3&&c>0){typeof console<"u"&&console.log&&console.log("Database version c\u0169 < 3, \u0111ang x\xF3a t\u1EA5t c\u1EA3 d\u1EEF li\u1EC7u c\u0169 v\xE0 t\u1EA1o l\u1EA1i v\u1EDBi affiliate_id support..."),Array.from(s.objectStoreNames).forEach(o=>{try{s.deleteObjectStore(o),typeof console<"u"&&console.log&&console.log(`\u0110\xE3 x\xF3a object store: ${o}`)}catch(l){typeof console<"u"&&console.warn&&console.warn(`Kh\xF4ng th\u1EC3 x\xF3a object store ${o}:`,l)}});try{if(typeof chrome<"u"&&chrome.storage&&chrome.storage.local){let o=["clickHistory","orderHistory"];chrome.storage.local.remove(o,()=>{chrome.runtime.lastError?console.warn("L\u1ED7i khi x\xF3a d\u1EEF li\u1EC7u c\u0169 t\u1EEB chrome.storage.local:",chrome.runtime.lastError):typeof console<"u"&&console.log&&console.log("\u0110\xE3 x\xF3a d\u1EEF li\u1EC7u c\u0169 t\u1EEB chrome.storage.local:",o)})}}catch(o){typeof console<"u"&&console.warn&&console.warn("Kh\xF4ng th\u1EC3 x\xF3a d\u1EEF li\u1EC7u t\u1EEB chrome.storage.local:",o)}}if(!s.objectStoreNames.contains("orders")){let t=s.createObjectStore("orders",{keyPath:"key"});t.createIndex("purchase_time","purchase_time",{unique:!1}),t.createIndex("checkout_id","checkout_id",{unique:!1}),t.createIndex("order_id","order_id",{unique:!1}),t.createIndex("affiliate_id","affiliate_id",{unique:!1})}if(!s.objectStoreNames.contains("clicks")){let t=s.createObjectStore("clicks",{keyPath:"key"});t.createIndex("click_time","click_time",{unique:!1}),t.createIndex("click_id","click_id",{unique:!1}),t.createIndex("affiliate_id","affiliate_id",{unique:!1})}if(!s.objectStoreNames.contains("affiliateLinks")){let t=s.createObjectStore("affiliateLinks",{keyPath:"id",autoIncrement:!0});t.createIndex("timestamp","timestamp",{unique:!1}),t.createIndex("affiliate_id","affiliate_id",{unique:!1})}if(!s.objectStoreNames.contains("favorites")){let t=s.createObjectStore("favorites",{keyPath:"id"});t.createIndex("item_id","item_id",{unique:!1}),t.createIndex("created_at","created_at",{unique:!1}),t.createIndex("affiliate_id","affiliate_id",{unique:!1})}}catch(s){typeof console<"u"&&console.error&&console.error("Error during database upgrade:",s)}},i.onblocked=()=>{typeof console<"u"&&console.warn&&console.warn("IndexedDB upgrade blocked - close other tabs using this database")}}catch(i){let n=m;m=null,e(new Error("Failed to open IndexedDB: "+(i.message||i)))}}),m)}async function A(r,e){let i=await u();if(!i)return Promise.reject(new Error("Database connection failed"));let n=await w()||e.affiliate_id||null;return e.affiliate_id&&e.affiliate_id!==n&&await E(e.affiliate_id),new Promise((s,c)=>{var f,d;if(!i||!i.objectStoreNames){c(new Error("Database connection is invalid"));return}let o=i.transaction(["orders"],"readwrite").objectStore("orders"),l={key:r,data:e,affiliate_id:e.affiliate_id||n,purchase_time:e.purchase_time||e.checkout_complete_time||0,checkout_id:e.checkout_id||"",order_id:((d=(f=e.orders)==null?void 0:f[0])==null?void 0:d.order_id)||""},a=o.put(l);a.onsuccess=()=>s(),a.onerror=()=>c(a.error)})}async function j(r){let e=await u(),i=await w();if(!i){let o=Object.values(r)[0];o!=null&&o.affiliate_id&&(i=o.affiliate_id,await E(i))}let n=Object.entries(r);if(n.length===0)return Promise.resolve();let c=1e3,t=[];for(let o=0;o<n.length;o+=c)t.push(n.slice(o,o+c));for(let o of t)await new Promise((l,a)=>{if(!e||!e.objectStoreNames){a(new Error("Database connection is invalid"));return}let d=e.transaction(["orders"],"readwrite").objectStore("orders"),b=0,h=!1;o.forEach(([x,_])=>{var q,I;let g=_.affiliate_id||i;g&&g!==i&&(E(g).catch(()=>{}),i=g);let P={key:x,data:_,affiliate_id:g,purchase_time:_.purchase_time||_.checkout_complete_time||0,checkout_id:_.checkout_id||"",order_id:((I=(q=_.orders)==null?void 0:q[0])==null?void 0:I.order_id)||""},k=d.put(P);k.onsuccess=()=>{b++,b===o.length&&!h&&l()},k.onerror=()=>{h||(h=!0,a(k.error))}})})}async function D(r){let e=await u();return e?new Promise((i,n)=>{if(!e||!e.objectStoreNames){n(new Error("Database connection is invalid"));return}let t=e.transaction(["orders"],"readonly").objectStore("orders").get(r);t.onsuccess=()=>{i(t.result?t.result.data:null)},t.onerror=()=>n(t.error)}):Promise.reject(new Error("Database connection failed"))}async function L(){let r=await u();if(!r)return Promise.reject(new Error("Database connection failed"));let e=await w();return new Promise((i,n)=>{if(!r||!r.objectStoreNames){n(new Error("Database connection is invalid"));return}let c=r.transaction(["orders"],"readonly").objectStore("orders");if(e&&c.indexNames.contains("affiliate_id")){let o=c.index("affiliate_id").getAll(e);o.onsuccess=()=>{let l={};o.result.forEach(a=>{l[a.key]=a.data}),i(l)},o.onerror=()=>n(o.error)}else{let t=c.getAll();t.onsuccess=()=>{let o={};t.result.forEach(l=>{(!e||l.affiliate_id===e)&&(o[l.key]=l.data)}),i(o)},t.onerror=()=>n(t.error)}})}async function C(r){let e=await u();return e?new Promise((i,n)=>{if(!e||!e.objectStoreNames){n(new Error("Database connection is invalid"));return}let t=e.transaction(["orders"],"readwrite").objectStore("orders").delete(r);t.onsuccess=()=>i(),t.onerror=()=>n(t.error)}):Promise.reject(new Error("Database connection failed"))}async function B(){let r;try{r=await u()}catch(i){return Promise.reject(new Error("Kh\xF4ng th\u1EC3 m\u1EDF database: "+i.message))}if(!r||r.objectStoreNames.length===0)return Promise.reject(new Error("Database connection kh\xF4ng h\u1EE3p l\u1EC7"));let e=await w();return new Promise((i,n)=>{if(!r||!r.objectStoreNames){n(new Error("Database connection is invalid"));return}let s;try{s=r.transaction(["orders"],"readwrite")}catch(t){n(new Error("Kh\xF4ng th\u1EC3 t\u1EA1o transaction: "+t.message));return}let c=s.objectStore("orders");if(s.oncomplete=()=>{},s.onerror=t=>{console.error("Transaction error:",t),n(t.target.error||new Error("Transaction failed"))},s.onabort=()=>{n(new Error("Transaction b\u1ECB h\u1EE7y"))},!e){let t=c.clear();t.onsuccess=()=>{typeof console<"u"&&console.log&&console.log("\u0110\xE3 x\xF3a t\u1EA5t c\u1EA3 orders (kh\xF4ng c\xF3 affiliate_id filter)"),i()},t.onerror=()=>n(t.error);return}if(c.indexNames.contains("affiliate_id")){let o=c.index("affiliate_id").openCursor(IDBKeyRange.only(e)),l=0,a=!1;o.onsuccess=f=>{if(s.readyState!=="active"){a||(a=!0,n(new Error("Transaction \u0111\xE3 b\u1ECB \u0111\xF3ng tr\u01B0\u1EDBc khi ho\xE0n th\xE0nh")));return}let d=f.target.result;if(d)try{d.delete(),l++,d.continue()}catch(b){a||(a=!0,n(new Error("L\u1ED7i khi x\xF3a record: "+b.message)))}else a||(a=!0,typeof console<"u"&&console.log&&console.log(`\u0110\xE3 x\xF3a ${l} orders c\u1EE7a affiliate_id: ${e}`),i())},o.onerror=f=>{a||(a=!0,console.error("L\u1ED7i khi x\xF3a orders theo affiliate_id:",o.error),n(o.error||new Error("Cursor error")))}}else{let t=c.getAll();t.onsuccess=()=>{let o=t.result.filter(f=>f.affiliate_id===e);if(o.length===0){i();return}let l=0,a=!1;o.forEach(f=>{let d=c.delete(f.key);d.onsuccess=()=>{l++,l===o.length&&!a&&(typeof console<"u"&&console.log&&console.log(`\u0110\xE3 x\xF3a ${l} orders c\u1EE7a affiliate_id: ${e}`),i())},d.onerror=()=>{a||(a=!0,n(d.error))}})},t.onerror=()=>n(t.error)}})}async function O(r,e){let i=await u();if(!i)return Promise.reject(new Error("Database connection failed"));let n=await w()||e.affiliate_id||null;return e.affiliate_id&&e.affiliate_id!==n&&await E(e.affiliate_id),new Promise((s,c)=>{if(!i||!i.objectStoreNames){c(new Error("Database connection is invalid"));return}let o=i.transaction(["clicks"],"readwrite").objectStore("clicks"),l={key:r,data:e,affiliate_id:e.affiliate_id||n,click_time:e.click_time||0,click_id:e.click_id||""},a=o.put(l);a.onsuccess=()=>s(),a.onerror=()=>c(a.error)})}async function $(r){let e=await u();if(!e)return Promise.reject(new Error("Database connection failed"));let i=await w();if(!i){let o=Object.values(r)[0];o!=null&&o.affiliate_id&&(i=o.affiliate_id,await E(i))}let n=Object.entries(r);if(n.length===0)return Promise.resolve();let c=1e3,t=[];for(let o=0;o<n.length;o+=c)t.push(n.slice(o,o+c));for(let o of t)await new Promise((l,a)=>{if(!e||!e.objectStoreNames){a(new Error("Database connection is invalid"));return}let d=e.transaction(["clicks"],"readwrite").objectStore("clicks"),b=0,h=!1;o.forEach(([x,_])=>{let g=_.affiliate_id||i;g&&g!==i&&(E(g).catch(()=>{}),i=g);let P={key:x,data:_,affiliate_id:g,click_time:_.click_time||0,click_id:_.click_id||""},k=d.put(P);k.onsuccess=()=>{b++,b===o.length&&!h&&l()},k.onerror=()=>{h||(h=!0,a(k.error))}})})}async function R(r){let e=await u();return e?new Promise((i,n)=>{if(!e||!e.objectStoreNames){n(new Error("Database connection is invalid"));return}let t=e.transaction(["clicks"],"readonly").objectStore("clicks").get(r);t.onsuccess=()=>{i(t.result?t.result.data:null)},t.onerror=()=>n(t.error)}):Promise.reject(new Error("Database connection failed"))}async function T(){let r=await u(),e=await w();return new Promise((i,n)=>{let c=r.transaction(["clicks"],"readonly").objectStore("clicks");if(e&&c.indexNames.contains("affiliate_id")){let o=c.index("affiliate_id").getAll(e);o.onsuccess=()=>{let l={};o.result.forEach(a=>{l[a.key]=a.data}),i(l)},o.onerror=()=>n(o.error)}else{let t=c.getAll();t.onsuccess=()=>{let o={};t.result.forEach(l=>{(!e||l.affiliate_id===e)&&(o[l.key]=l.data)}),i(o)},t.onerror=()=>n(t.error)}})}async function F(r){let e=await u();return e?new Promise((i,n)=>{if(!e||!e.objectStoreNames){n(new Error("Database connection is invalid"));return}let t=e.transaction(["clicks"],"readwrite").objectStore("clicks").delete(r);t.onsuccess=()=>i(),t.onerror=()=>n(t.error)}):Promise.reject(new Error("Database connection failed"))}async function H(){let r;try{r=await u()}catch(i){return Promise.reject(new Error("Kh\xF4ng th\u1EC3 m\u1EDF database: "+i.message))}if(!r||r.objectStoreNames.length===0)return Promise.reject(new Error("Database connection kh\xF4ng h\u1EE3p l\u1EC7"));let e=await w();return new Promise((i,n)=>{if(!r||!r.objectStoreNames){n(new Error("Database connection is invalid"));return}let s;try{s=r.transaction(["clicks"],"readwrite")}catch(t){n(new Error("Kh\xF4ng th\u1EC3 t\u1EA1o transaction: "+t.message));return}let c=s.objectStore("clicks");if(s.oncomplete=()=>{},s.onerror=t=>{console.error("Transaction error:",t),n(t.target.error||new Error("Transaction failed"))},s.onabort=()=>{n(new Error("Transaction b\u1ECB h\u1EE7y"))},!e){let t=c.clear();t.onsuccess=()=>{typeof console<"u"&&console.log&&console.log("\u0110\xE3 x\xF3a t\u1EA5t c\u1EA3 clicks (kh\xF4ng c\xF3 affiliate_id filter)"),i()},t.onerror=()=>n(t.error);return}if(c.indexNames.contains("affiliate_id")){let o=c.index("affiliate_id").openCursor(IDBKeyRange.only(e)),l=0,a=!1;o.onsuccess=f=>{if(s.readyState!=="active"){a||(a=!0,n(new Error("Transaction \u0111\xE3 b\u1ECB \u0111\xF3ng tr\u01B0\u1EDBc khi ho\xE0n th\xE0nh")));return}let d=f.target.result;if(d)try{d.delete(),l++,d.continue()}catch(b){a||(a=!0,n(new Error("L\u1ED7i khi x\xF3a record: "+b.message)))}else a||(a=!0,typeof console<"u"&&console.log&&console.log(`\u0110\xE3 x\xF3a ${l} clicks c\u1EE7a affiliate_id: ${e}`),i())},o.onerror=f=>{a||(a=!0,console.error("L\u1ED7i khi x\xF3a clicks theo affiliate_id:",o.error),n(o.error||new Error("Cursor error")))}}else{let t=c.getAll();t.onsuccess=()=>{let o=t.result.filter(f=>f.affiliate_id===e);if(o.length===0){i();return}let l=0,a=!1;o.forEach(f=>{let d=c.delete(f.key);d.onsuccess=()=>{l++,l===o.length&&!a&&(typeof console<"u"&&console.log&&console.log(`\u0110\xE3 x\xF3a ${l} clicks c\u1EE7a affiliate_id: ${e}`),i())},d.onerror=()=>{a||(a=!0,n(d.error))}})},t.onerror=()=>n(t.error)}})}async function K(r){let e=await u(),i=await w();return new Promise((n,s)=>{let t=e.transaction(["affiliateLinks"],"readwrite").objectStore("affiliateLinks"),o={...r,affiliate_id:i,timestamp:r.timestamp||Date.now()},l=t.add(o);l.onsuccess=()=>n(l.result),l.onerror=()=>s(l.error)})}async function V(){let r=await u();if(!r)return Promise.reject(new Error("Database connection failed"));let e=await w();return new Promise((i,n)=>{if(!r||!r.objectStoreNames){n(new Error("Database connection is invalid"));return}let c=r.transaction(["affiliateLinks"],"readonly").objectStore("affiliateLinks");if(e&&c.indexNames.contains("affiliate_id")){let o=c.index("affiliate_id").getAll(e);o.onsuccess=()=>{let l=o.result.sort((a,f)=>(f.timestamp||0)-(a.timestamp||0)).slice(0,100).map(a=>{let{id:f,...d}=a;return d});i(l)},o.onerror=()=>n(o.error)}else{let o=c.index("timestamp").getAll();o.onsuccess=()=>{let l=o.result.filter(a=>!e||a.affiliate_id===e).sort((a,f)=>(f.timestamp||0)-(a.timestamp||0)).slice(0,100).map(a=>{let{id:f,...d}=a;return d});i(l)},o.onerror=()=>n(o.error)}})}async function U(r){let e=await u();return new Promise((i,n)=>{let t=e.transaction(["affiliateLinks"],"readwrite").objectStore("affiliateLinks").delete(r);t.onsuccess=()=>i(),t.onerror=()=>n(t.error)})}async function Z(){let r=await u();return r?new Promise((e,i)=>{if(!r||!r.objectStoreNames){i(new Error("Database connection is invalid"));return}let c=r.transaction(["affiliateLinks"],"readwrite").objectStore("affiliateLinks").clear();c.onsuccess=()=>e(),c.onerror=()=>i(c.error)}):Promise.reject(new Error("Database connection failed"))}function p(r,e,i){if(r&&String(r).trim()!=="")return`item_${String(r).trim()}`;let n=(e||"").trim().toLowerCase(),s=(i||"").trim().toLowerCase();return`name_shop_${n}_${s}`}async function z(r){let e=await u();if(!e)return Promise.reject(new Error("Database connection failed"));let i=await w();return new Promise((n,s)=>{if(!e||!e.objectStoreNames){s(new Error("Database connection is invalid"));return}let t=e.transaction(["favorites"],"readwrite").objectStore("favorites"),o=p(r.item_id,r.item_name,r.shop_name),l={id:o,affiliate_id:i,item_id:r.item_id||"",item_name:r.item_name||"",shop_name:r.shop_name||"",shop_id:r.shop_id||"",category:r.category||"",notes:r.notes||"",tags:r.tags||[],product_link:r.product_link||"",created_at:r.created_at||Date.now(),updated_at:Date.now()},a=t.put(l);a.onsuccess=()=>n(o),a.onerror=()=>s(a.error)})}async function M(){let r=await u();if(!r)return Promise.reject(new Error("Database connection failed"));let e=await w();return new Promise((i,n)=>{if(!r||!r.objectStoreNames){n(new Error("Database connection is invalid"));return}let c=r.transaction(["favorites"],"readonly").objectStore("favorites");if(e&&c.indexNames.contains("affiliate_id")){let o=c.index("affiliate_id").getAll(e);o.onsuccess=()=>{i(o.result||[])},o.onerror=()=>n(o.error)}else{let t=c.getAll();t.onsuccess=()=>{let o=(t.result||[]).filter(l=>!e||l.affiliate_id===e);i(o)},t.onerror=()=>n(t.error)}})}async function G(r,e,i){let n=await u();return n?new Promise((s,c)=>{if(!n||!n.objectStoreNames){c(new Error("Database connection is invalid"));return}let o=n.transaction(["favorites"],"readonly").objectStore("favorites"),l=p(r,e,i),a=o.get(l);a.onsuccess=()=>{s(a.result||null)},a.onerror=()=>c(a.error)}):Promise.reject(new Error("Database connection failed"))}async function J(r,e,i,n){let s=await u();return s?new Promise((c,t)=>{if(!s||!s.objectStoreNames){t(new Error("Database connection is invalid"));return}let l=s.transaction(["favorites"],"readwrite").objectStore("favorites"),a=p(r,e,i),f=l.get(a);f.onsuccess=()=>{let d=f.result;if(!d){t(new Error("Favorite not found"));return}let b={...d,...n,updated_at:Date.now()},h=l.put(b);h.onsuccess=()=>c(b),h.onerror=()=>t(h.error)},f.onerror=()=>t(f.error)}):Promise.reject(new Error("Database connection failed"))}async function Q(r,e,i){let n=await u();return new Promise((s,c)=>{let o=n.transaction(["favorites"],"readwrite").objectStore("favorites"),l=p(r,e,i),a=o.delete(l);a.onsuccess=()=>s(),a.onerror=()=>c(a.error)})}async function W(){let r=await u();return r?new Promise((e,i)=>{if(!r||!r.objectStoreNames){i(new Error("Database connection is invalid"));return}let c=r.transaction(["favorites"],"readwrite").objectStore("favorites").clear();c.onsuccess=()=>e(),c.onerror=()=>i(c.error)}):Promise.reject(new Error("Database connection failed"))}var v={saveOrder:A,saveOrders:j,getOrder:D,getAllOrders:L,deleteOrder:C,clearOrders:B,saveClick:O,saveClicks:$,getClick:R,getAllClicks:T,deleteClick:F,clearClicks:H,saveAffiliateLink:K,getAllAffiliateLinks:V,deleteAffiliateLink:U,clearAffiliateLinks:Z,saveFavorite:z,getAllFavorites:M,getFavorite:G,updateFavorite:J,deleteFavorite:Q,clearFavorites:W,generateFavoriteId:p,getCurrentAffiliateId:w,setCurrentAffiliateId:E,initDB:u},X=v;typeof window<"u"&&(window.idb=v);typeof self<"u"&&(self.idb=v);})();
