(()=>{(function(){"use strict";console.log("[Affiliate Offer] Injected script is running in MAIN world.");let s=!1,u=0,I=30;function A(e){if(!e)return!1;let r=typeof e=="string"?e:e.toString();return["/api/v3/offer/product","api/v3/offer/product"].some(o=>{let t=r.indexOf(o);if(t===-1)return!1;let f=r.substring(0,t);return f.includes("affiliate.shopee.vn")||f===""||f.endsWith("/")||r.startsWith("/")})}function l(e){return s?!1:e&&e.code===0&&e.data?(console.log("[Affiliate Offer] \u2713 \u0110\xE3 b\u1EAFt \u0111\u01B0\u1EE3c d\u1EEF li\u1EC7u product offer"),s=!0,T(),window.postMessage({type:"SHOPEE_PRODUCT_OFFER_DATA",payload:e.data},"*"),!0):!1}let p=[];function _(e,r){let i=setInterval(()=>{e()},r);return p.push(i),i}function T(){p.forEach(e=>clearInterval(e)),p.length=0}function h(){if(!window.fetch){console.warn("[Affiliate Offer] window.fetch kh\xF4ng t\u1ED3n t\u1EA1i");return}let e=window.fetch;window.fetch=function(...r){let[i,n]=r,o=e.apply(this,r);return A(i)&&(console.log("[Affiliate Offer] \u2713 B\u1EAFt \u0111\u01B0\u1EE3c fetch request \u0111\u1EBFn product offer API"),o.then(t=>{console.log("[Affiliate Offer] Response status:",t.status,t.statusText);let f=t.clone();if(!t.ok){console.error("[Affiliate Offer] Response kh\xF4ng OK:",t.status,t.statusText),f.text().then(c=>{console.log("[Affiliate Offer] Response text:",c.substring(0,200))});return}f.json().then(c=>{console.log("[Affiliate Offer] Parsed data:",c),l(c)}).catch(c=>{console.error("[Affiliate Offer] L\u1ED7i khi parse JSON:",c),t.clone().text().then(d=>{console.log("[Affiliate Offer] Response as text:",d.substring(0,500))})})}).catch(t=>{console.error("[Affiliate Offer] L\u1ED7i khi ch\u1EB7n fetch request:",t)})),o},console.log("[Affiliate Offer] \u0110\xE3 thi\u1EBFt l\u1EADp intercept cho fetch")}function g(){let e=XMLHttpRequest.prototype.open,r=XMLHttpRequest.prototype.send,i=XMLHttpRequest.prototype.setRequestHeader;XMLHttpRequest.prototype.open=function(n,o,...t){return this._url=o,this._method=n,this._requestHeaders={},e.apply(this,[n,o,...t])},XMLHttpRequest.prototype.setRequestHeader=function(n,o){return this._requestHeaders||(this._requestHeaders={}),this._requestHeaders[n]=o,i.apply(this,[n,o])},XMLHttpRequest.prototype.send=function(...n){if(A(this._url)&&!s){console.log("[Affiliate Offer] \u2713 B\u1EAFt \u0111\u01B0\u1EE3c XHR request \u0111\u1EBFn product offer API");let o=this,t=!1,f=function(){if(!(t||s)&&o.status>=200&&o.status<300)try{let a=JSON.parse(o.responseText);l(a)&&(t=!0)}catch(a){console.error("[Affiliate Offer] L\u1ED7i khi parse XHR JSON:",a)}},c=this.onload;this.onload=function(a){if(f(),c)return c.apply(this,arguments)};let d=this.onerror;this.onerror=function(a){if(console.error("[Affiliate Offer] XHR request error"),d)return d.apply(this,arguments)},this.addEventListener("load",f,{once:!0}),this.addEventListener("error",function(){console.error("[Affiliate Offer] XHR request error")},{once:!0})}return r.apply(this,n)},console.log("[Affiliate Offer] \u0110\xE3 thi\u1EBFt l\u1EADp intercept cho XMLHttpRequest")}function O(){if(!s){if(u++,(u%5===0||u===1)&&console.log(`[Affiliate Offer] Thi\u1EBFt l\u1EADp l\u1EA1i interceptors (l\u1EA7n ${u})`),h(),g(),u>=I||s){s||console.warn("[Affiliate Offer] Kh\xF4ng th\u1EC3 b\u1EAFt \u0111\u01B0\u1EE3c request API sau 30 gi\xE2y. Vui l\xF2ng th\u1EED l\u1EA1i.");return}setTimeout(O,1e3)}}function b(){if(s)return;if(!document.head&&!document.documentElement){setTimeout(b,100);return}let e=new MutationObserver(function(r){if(s){e.disconnect();return}r.forEach(function(i){i.type==="childList"&&i.addedNodes.forEach(function(n){n.tagName==="SCRIPT"&&n.src&&n.src.includes("mdap")&&n.addEventListener("load",function(){s||(h(),g())})})})});e.observe(document.head||document.documentElement,{childList:!0,subtree:!0})}function D(){let e=0,r=30,i=_(()=>{if(s){clearInterval(i);return}if(e++,window.__INITIAL_STATE__&&window.__INITIAL_STATE__.productOffer&&l({code:0,data:window.__INITIAL_STATE__.productOffer})){clearInterval(i);return}if(window.SHOPEE_AFFILIATE_DATA&&l({code:0,data:window.SHOPEE_AFFILIATE_DATA})){clearInterval(i);return}e>=r&&clearInterval(i)},1e3)}function w(){console.log("[Affiliate Offer] Injected script initialized in MAIN world"),h(),g(),b(),D(),s||setTimeout(O,1e3)}w()})();})();
