(()=>{$(function(){chrome.storage.local.get("enableNotif",e=>{$("#enableNotif").prop("checked",e.enableNotif!==!1)}),$("#enableNotif").on("change",function(){chrome.storage.local.set({enableNotif:this.checked})}),chrome.storage.local.get("syncDays",e=>{let n=e.syncDays||30;$("#syncDays").val(n)}),$("#syncDays").on("change",function(){let e=parseInt($(this).val(),10);chrome.storage.local.set({syncDays:e})}),chrome.storage.local.get("clickSyncDays",e=>{let n=e.clickSyncDays||14;$("#clickSyncDays").val(n)}),$("#clickSyncDays").on("change",function(){let e=parseInt($(this).val(),10);chrome.storage.local.set({clickSyncDays:e})}),chrome.storage.local.get("maxClicksLimit",e=>{let n=e.maxClicksLimit||5e4;$("#maxClicksLimit").val(n)}),$("#maxClicksLimit").on("change",function(){let e=parseInt($(this).val(),10);e>0?chrome.storage.local.set({maxClicksLimit:e}):(alert("Gi\u1EDBi h\u1EA1n clicks ph\u1EA3i l\u1EDBn h\u01A1n 0"),$(this).val(5e4))}),d(),l(),$("#syncNowBtn").on("click",function(){let e=$(this);e.prop("disabled",!0).text("\u0110ang \u0111\u1ED3ng b\u1ED9..."),chrome.runtime.sendMessage({type:"SYNC_NOW"},n=>{chrome.runtime.lastError?(alert("L\u1ED7i: "+chrome.runtime.lastError.message),e.prop("disabled",!1).text("\u0110\u1ED3ng b\u1ED9 ngay")):setTimeout(()=>{d(),e.prop("disabled",!1).text("\u0110\u1ED3ng b\u1ED9 ngay")},2e3)})}),$("#syncYesterdayBtn").on("click",function(){let e=$(this);e.prop("disabled",!0).text("\u0110ang \u0111\u1ED3ng b\u1ED9..."),chrome.runtime.sendMessage({type:"SYNC_YESTERDAY"},n=>{chrome.runtime.lastError?(alert("L\u1ED7i: "+chrome.runtime.lastError.message),e.prop("disabled",!1).text("\u0110\u1ED3ng b\u1ED9 ng\xE0y h\xF4m qua")):setTimeout(()=>{d(),e.prop("disabled",!1).text("\u0110\u1ED3ng b\u1ED9 ng\xE0y h\xF4m qua")},2e3)})}),$("#viewHistoryBtn").on("click",function(){chrome.tabs.create({url:chrome.runtime.getURL("order-history.html")})}),$("#syncClicksNowBtn").on("click",function(){let e=$(this);e.prop("disabled",!0).text("\u0110ang \u0111\u1ED3ng b\u1ED9..."),chrome.runtime.sendMessage({type:"SYNC_CLICKS_NOW"},n=>{chrome.runtime.lastError?(alert("L\u1ED7i: "+chrome.runtime.lastError.message),e.prop("disabled",!1).text("\u0110\u1ED3ng b\u1ED9 Click ngay")):setTimeout(()=>{l(),e.prop("disabled",!1).text("\u0110\u1ED3ng b\u1ED9 Click ngay")},2e3)})}),$("#syncClicksYesterdayBtn").on("click",function(){let e=$(this);e.prop("disabled",!0).text("\u0110ang \u0111\u1ED3ng b\u1ED9..."),chrome.runtime.sendMessage({type:"SYNC_CLICKS_YESTERDAY"},n=>{chrome.runtime.lastError?(alert("L\u1ED7i: "+chrome.runtime.lastError.message),e.prop("disabled",!1).text("\u0110\u1ED3ng b\u1ED9 Click ng\xE0y h\xF4m qua")):setTimeout(()=>{l(),e.prop("disabled",!1).text("\u0110\u1ED3ng b\u1ED9 Click ng\xE0y h\xF4m qua")},2e3)})}),$("#viewClickOverviewBtn").on("click",function(){chrome.tabs.create({url:chrome.runtime.getURL("click-overview.html")})}),$("#exportCSVBtn").on("click",function(){I()}),$("#clearDataBtn").on("click",function(){confirm("B\u1EA1n c\xF3 ch\u1EAFc ch\u1EAFn mu\u1ED1n x\xF3a to\xE0n b\u1ED9 d\u1EEF li\u1EC7u l\u1ECBch s\u1EED? H\xE0nh \u0111\u1ED9ng n\xE0y kh\xF4ng th\u1EC3 ho\xE0n t\xE1c.")&&P()}),$("#clearClickDataBtn").on("click",function(){confirm("B\u1EA1n c\xF3 ch\u1EAFc ch\u1EAFn mu\u1ED1n x\xF3a to\xE0n b\u1ED9 d\u1EEF li\u1EC7u click \u0111\xE3 \u0111\u1ED3ng b\u1ED9? H\xE0nh \u0111\u1ED9ng n\xE0y kh\xF4ng th\u1EC3 ho\xE0n t\xE1c.")&&chrome.runtime.sendMessage({type:"CLEAR_CLICK_DATA"},e=>{chrome.runtime.lastError?alert("L\u1ED7i: "+chrome.runtime.lastError.message):(alert("\u0110\xE3 x\xF3a to\xE0n b\u1ED9 d\u1EEF li\u1EC7u click."),l())})}),chrome.storage.onChanged.addListener((e,n)=>{n==="local"&&((e.syncStatus||e.lastSyncTime||e.totalOrdersCount)&&d(),(e.clickSyncStatus||e.lastClickSyncTime||e.totalClicksCount)&&l())}),$("#sidebarNav .nav-link").on("click",function(){let e=$(this).data("target");$("#sidebarNav .nav-link").removeClass("active"),$(this).addClass("active"),$(".tab-pane").removeClass("active").filter(e).addClass("active"),history.replaceState(null,"",e)});let t=location.hash&&$(location.hash+".tab-pane").length?location.hash:"#pane-settings";$(`#sidebarNav .nav-link[data-target="${t}"]`).trigger("click"),N(),$("#addSubIdCPCBtnOptions").on("click",function(){let e=$("#subIdCPCInputOptions").val().trim(),n=parseFloat($("#subIdCPCValueOptions").val())||0;e&&(_(e,n),$("#subIdCPCInputOptions").val(""),$("#subIdCPCValueOptions").val(""))}),$("#saveCPCConfigBtnOptions").on("click",function(){D()}),chrome.storage.local.get("priceHistoryEnabled",e=>{$("#priceHistoryEnabled").prop("checked",e.priceHistoryEnabled!==!1)}),$("#priceHistoryEnabled").on("change",function(){chrome.storage.local.set({priceHistoryEnabled:this.checked})}),chrome.storage.local.get(["dataSyncEnabled","dataSyncServerUrl"],e=>{$("#dataSyncEnabled").prop("checked",e.dataSyncEnabled!==!1),$("#dataSyncServerUrl").val(e.dataSyncServerUrl||"")}),$("#dataSyncEnabled").on("change",function(){chrome.storage.local.set({dataSyncEnabled:this.checked})}),$("#dataSyncServerUrl").on("change",function(){let e=$(this).val().trim();if(e)try{new URL(e),chrome.storage.local.set({dataSyncServerUrl:e})}catch{alert("URL kh\xF4ng h\u1EE3p l\u1EC7. Vui l\xF2ng nh\u1EADp URL \u0111\u1EA7y \u0111\u1EE7 (v\xED d\u1EE5: https://api.example.com/data)"),$(this).focus()}else chrome.storage.local.set({dataSyncServerUrl:""})}),$("#dataSyncServerUrl").on("blur",function(){let e=$(this).val().trim();if(e)try{new URL(e),chrome.storage.local.set({dataSyncServerUrl:e})}catch{console.warn("Invalid URL:",e)}})});function d(){chrome.storage.local.get(["syncStatus","lastSyncTime","totalOrdersCount","syncError"],t=>{let e=t.syncStatus||"unknown",n=$("#syncStatus");if(n.removeClass("bg-secondary bg-success bg-danger bg-warning"),e==="success"?n.addClass("bg-success").text("Th\xE0nh c\xF4ng"):e==="error"?n.addClass("bg-danger").text("L\u1ED7i: "+(t.syncError||"Unknown")):e==="in_progress"?n.addClass("bg-warning").text("\u0110ang \u0111\u1ED3ng b\u1ED9..."):n.addClass("bg-secondary").text("Ch\u01B0a \u0111\u1ED3ng b\u1ED9"),t.lastSyncTime){let s=new Date(t.lastSyncTime);$("#lastSyncTime").text(s.toLocaleString("vi-VN"))}else $("#lastSyncTime").text("Ch\u01B0a c\xF3");t.totalOrdersCount!==void 0?$("#totalOrdersCount").text(t.totalOrdersCount.toLocaleString("vi-VN")):idb.getAllOrders().then(s=>{let r=s?Object.keys(s).length:0;$("#totalOrdersCount").text(r.toLocaleString("vi-VN"))})})}async function I(){try{let t=await idb.getAllOrders(),e=Object.values(t);if(e.length===0){alert("Kh\xF4ng c\xF3 d\u1EEF li\u1EC7u \u0111\u1EC3 xu\u1EA5t.");return}let s=[["Checkout ID","Order ID","Product ID","Product Name","Shop Name","Purchase Time","Order Status","Commission","GMV","Referrer","Channel"].join(",")];e.forEach(a=>{let f=a.checkout_id||"",p=a.purchase_time?new Date(a.purchase_time*1e3).toLocaleString("vi-VN"):"",S=a.checkout_status||"";(a.orders||[]).forEach(y=>{let k=y.order_id||"";(y.items||[]).forEach(c=>{let v=c.item_id||"",x=(c.item_name||"").replace(/"/g,'""'),L=(c.shop_name||"").replace(/"/g,'""'),E=c.item_commission||0,O=c.item_gmv||c.actual_amount||c.item_price||0,i=c.referrer||a.referrer||"MXH",g="MXH";i.includes("Shopeevideo")||i.includes("Shopeevideo-Shopee")?g="Video":(i.includes("Shopeelive")||i.includes("Shopeelive-Shopee"))&&(g="Live");let w=[f,k,v,`"${x}"`,`"${L}"`,p,S,E,O,i,g];s.push(w.join(","))})})});let r=s.join(`
`),b=new Blob(["\uFEFF"+r],{type:"text/csv;charset=utf-8;"}),C=URL.createObjectURL(b),h=document.createElement("a");h.href=C,h.download=`shopee_orders_${new Date().toISOString().split("T")[0]}.csv`,h.click(),URL.revokeObjectURL(C)}catch(t){console.error("Error exporting CSV:",t),alert("L\u1ED7i khi xu\u1EA5t d\u1EEF li\u1EC7u: "+t.message)}}function l(){chrome.storage.local.get(["clickSyncStatus","lastClickSyncTime","totalClicksCount","clickSyncError"],t=>{let e=t.clickSyncStatus||"unknown",n=$("#clickSyncStatus");if(n.removeClass("bg-secondary bg-success bg-danger bg-warning"),e==="success"?n.addClass("bg-success").text("Th\xE0nh c\xF4ng"):e==="error"?n.addClass("bg-danger").text("L\u1ED7i: "+(t.clickSyncError||"Unknown")):e==="in_progress"?n.addClass("bg-warning").text("\u0110ang \u0111\u1ED3ng b\u1ED9..."):n.addClass("bg-secondary").text("Ch\u01B0a \u0111\u1ED3ng b\u1ED9"),t.lastClickSyncTime){let s=new Date(t.lastClickSyncTime);$("#lastClickSyncTime").text(s.toLocaleString("vi-VN"))}else $("#lastClickSyncTime").text("Ch\u01B0a c\xF3");t.totalClicksCount!==void 0?$("#totalClicksCount").text(t.totalClicksCount.toLocaleString("vi-VN")):idb.getAllClicks().then(s=>{let r=s?Object.keys(s).length:0;$("#totalClicksCount").text(r.toLocaleString("vi-VN"))})})}async function P(){try{let t=await idb.getCurrentAffiliateId();console.log(t?`X\xF3a d\u1EEF li\u1EC7u orders c\u1EE7a affiliate_id: ${t}`:"Kh\xF4ng c\xF3 affiliate_id, x\xF3a t\u1EA5t c\u1EA3 d\u1EEF li\u1EC7u orders"),await idb.clearOrders(),await chrome.storage.local.remove(["lastSyncTime","syncStatus","totalOrdersCount","lastSyncCount","syncError"]),alert("\u0110\xE3 x\xF3a to\xE0n b\u1ED9 d\u1EEF li\u1EC7u."),d()}catch(t){console.error("Error clearing data:",t),alert("L\u1ED7i khi x\xF3a d\u1EEF li\u1EC7u: "+t.message)}}var u=0,o={};async function N(){try{let t=await chrome.storage.local.get(["averageCPC","subIdCPC"]);u=t.averageCPC||0,o=t.subIdCPC||{},$("#averageCPCOptions").val(u),m()}catch(t){console.error("Error loading CPC config:",t),u=0,o={}}}function m(){let t=$("#subIdCPCListOptions");if(t.length){if(Object.keys(o).length===0){t.html("<tr><td colspan='3' class='text-center text-muted'>Ch\u01B0a c\xF3 c\u1EA5u h\xECnh CPC theo SubID</td></tr>");return}t.html(Object.entries(o).map(([e,n])=>`
                    <tr>
                        <td><code style="font-size: 11px;">${e}</code></td>
                        <td>${T(n)}</td>
                        <td>
                            <button class="btn btn-sm btn-danger" onclick="removeSubIdCPCOptions('${e}')">X\xF3a</button>
                        </td>
                    </tr>
                `).join(""))}}function T(t){return new Intl.NumberFormat("vi-VN",{style:"currency",currency:"VND"}).format(t)}function _(t,e){o[t]=e,m()}window.removeSubIdCPCOptions=function(t){delete o[t],m()};async function D(){try{u=parseFloat($("#averageCPCOptions").val())||0,await chrome.storage.local.set({averageCPC:u,subIdCPC:o}),alert("\u0110\xE3 l\u01B0u c\u1EA5u h\xECnh CPC th\xE0nh c\xF4ng!")}catch(t){console.error("Error saving CPC config:",t),alert("L\u1ED7i khi l\u01B0u c\u1EA5u h\xECnh CPC: "+t.message)}}})();
