(()=>{var te=[],R=[],v={},z={},x={},X={},ce={},ue={},pe={},_e=[],be=[],he=[],C={},ee={overview:!1,gmv:!1,commission:!1,performance:!1},Q=xe(fe,300);document.addEventListener("DOMContentLoaded",function(){Ie();let o=document.getElementById("filterForm");o&&o.addEventListener("submit",function(f){f.preventDefault(),fe()});let a=document.getElementById("start_date"),l=document.getElementById("start_time"),r=document.getElementById("end_date"),e=document.getElementById("end_time"),c=document.getElementById("sub_id"),s=document.getElementById("sub_id_type"),_=document.getElementById("sub_id_field");a&&a.addEventListener("change",Q),l&&l.addEventListener("change",Q),r&&r.addEventListener("change",Q),e&&e.addEventListener("change",Q),c&&c.addEventListener("input",Q),s&&s.addEventListener("change",Q),_&&_.addEventListener("input",Q);let S=document.getElementById("captureBtn");S&&S.addEventListener("click",qe);let I=document.getElementById("openOptionsBtn");I&&I.addEventListener("click",function(){chrome.tabs.create({url:chrome.runtime.getURL("options.html")})});let u=document.getElementById("viewClickOverviewBtn");u&&u.addEventListener("click",function(){chrome.tabs.create({url:chrome.runtime.getURL("click-overview.html")})});let h=document.querySelectorAll(".quick-date-btn");h.forEach(f=>{f.addEventListener("click",function(){let g=parseInt(this.getAttribute("data-days"));Te(g),h.forEach(E=>E.classList.remove("active")),this.classList.add("active"),fe()})});let t=document.getElementById("exportCSVBtn");t&&t.addEventListener("click",Ne);let d=document.getElementById("exportJSONBtn");d&&d.addEventListener("click",ze);let n=document.getElementById("printReportBtn");n&&n.addEventListener("click",Ve),document.querySelectorAll('#statsTabs a[data-bs-toggle="tab"]').forEach(f=>{f.addEventListener("shown.bs.tab",function(g){let E=g.target.getAttribute("href"),q="overview";E==="#gmv"?q="gmv":E==="#commission"?q="commission":E==="#performance"?q="performance":q="overview",Ce(q)})})});async function Ie(){try{let o=document.getElementById("loadingMessage");o&&(o.innerHTML=`
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">\u0110ang t\u1EA3i...</span>
                </div>
                <p class="mt-2">\u0110ang t\u1EA3i d\u1EEF li\u1EC7u t\u1EEB IndexedDB...</p>
            `);let[a,l]=await Promise.all([idb.getAllOrders(),idb.getAllClicks()]),r=Object.keys(a).length,e=Object.keys(l).length;if(console.log("Order history loaded:",r,"items"),console.log("Click history loaded:",e,"items"),r===0){console.log("No order history found"),ge();return}if(o&&(o.innerHTML=`
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">\u0110ang x\u1EED l\xFD...</span>
                </div>
                <p class="mt-2">\u0110ang chuy\u1EC3n \u0111\u1ED5i d\u1EEF li\u1EC7u \u0111\u01A1n h\xE0ng...</p>
            `),await new Promise(c=>setTimeout(c,50)),te=ke(a),console.log("Converted orders:",te.length),te.length===0){console.log("No orders after conversion");let c=Object.keys(a);console.log("Total items in orderHistory:",c.length);for(let s=0;s<Math.min(5,c.length);s++){let _=c[s],S=a[_];console.log(`Sample item ${s+1} (${_}):`,{hasCheckoutId:!!S.checkout_id,hasOrders:!!(S.orders&&Array.isArray(S.orders)),ordersLength:S.orders?S.orders.length:0,hasItems:!!(S.items&&Array.isArray(S.items)),keys:Object.keys(S).slice(0,10)})}ge();return}o&&e>0&&(o.innerHTML=`
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">\u0110ang x\u1EED l\xFD...</span>
                </div>
                <p class="mt-2">\u0110ang k\u1EBFt n\u1ED1i d\u1EEF li\u1EC7u click v\u1EDBi \u0111\u01A1n h\xE0ng (${e.toLocaleString()} clicks)...</p>
                <p class="mt-1 small text-muted">Vui l\xF2ng \u0111\u1EE3i, qu\xE1 tr\xECnh n\xE0y c\xF3 th\u1EC3 m\u1EA5t v\xE0i gi\xE2y v\u1EDBi d\u1EEF li\u1EC7u l\u1EDBn.</p>
            `),await new Promise(c=>setTimeout(c,100)),te=Be(te,l),Se(),o&&(o.innerHTML=`
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">\u0110ang x\u1EED l\xFD...</span>
                </div>
                <p class="mt-2">\u0110ang \xE1p d\u1EE5ng b\u1ED9 l\u1ECDc v\xE0 t\xEDnh to\xE1n th\u1ED1ng k\xEA...</p>
            `),await new Promise(c=>setTimeout(c,50)),fe(),o&&(o.style.display="none"),document.getElementById("mainContent").style.display="block"}catch(o){console.error("Error loading order history:",o),ge()}}function Ee(o){if(!o)return"";if(typeof o=="string")try{let a=JSON.parse(o);if(a&&typeof a=="object"){if(a.internal_source&&a.internal_source.trim()!=="")return a.internal_source;if(a.direct_source&&a.direct_source.trim()!=="")return a.direct_source;if(a.last_external_source&&a.last_external_source.trim()!=="")return a.last_external_source}}catch{return o}if(typeof o=="object"&&o!==null){if(o.internal_source&&o.internal_source.trim()!=="")return o.internal_source;if(o.direct_source&&o.direct_source.trim()!=="")return o.direct_source;if(o.last_external_source&&o.last_external_source.trim()!=="")return o.last_external_source}return""}function Be(o,a){let l={},r={};console.log("Building click history indexes...");let e=Object.keys(a),c=e.length,s=5e3,_=0;for(let h=0;h<c;h+=s){let t=Math.min(h+s,c);for(let d=h;d<t;d++){let n=e[d],p=a[n];if(p){if(p.click_id){let f=`click_${p.click_id}`;l[f]=p}if(p.sub_id&&p.sub_id.trim()!==""){let f=p.sub_id.trim();r[f]||(r[f]=[]),r[f].push(p)}}}_=t,(_%1e4===0||_===c)&&console.log(`Indexed ${_}/${c} clicks...`)}console.log("Sorting clicks by time...");let S=Object.keys(r);for(let h of S)r[h].sort((t,d)=>{let n=t.click_time||t.click_time_ts||0;return(d.click_time||d.click_time_ts||0)-n});console.log("Joining orders with click data...");let I=o.length,u=[];for(let h=0;h<I;h++){let t=o[h];if(t.click_id){let n=`click_${t.click_id}`;if(l[n]){t.clickData=l[n],u.push(t);continue}}let d=!1;for(let n=1;n<=5;n++){let p=`sub_id${n}`,f=t[p];if(f&&f.trim()!==""){let g=f.trim(),E=r[g];if(E&&E.length>0){t.clickData=E[0],d=!0;break}}}u.push(t),((h+1)%500===0||h+1===I)&&console.log(`Joined ${h+1}/${I} orders...`)}return console.log("Click data join completed!"),u}function ke(o){let a=[],l=0;return Object.entries(o).forEach(([r,e])=>{if(!e||typeof e!="object"){console.log("Skipping invalid row:",r,e);return}if(r.includes("report_")||r.includes("validation_")||r.includes("payment_"))return;let c=!!e.checkout_id,s=e.orders&&Array.isArray(e.orders),_=e.items&&Array.isArray(e.items),S=e.list&&Array.isArray(e.list);if(!c&&!s&&!_&&!S&&!e.order_sn&&!e.order_id&&Object.keys(e).length>5)return;let I=[];if(e.orders&&Array.isArray(e.orders)&&e.orders.length>0)I=e.orders;else if(e.list&&Array.isArray(e.list))I=e.list.flatMap(u=>u.orders&&Array.isArray(u.orders)?u.orders:[]);else if(e.items&&Array.isArray(e.items)&&e.items.length>0)I=[e];else if(e.checkout_id&&!e.orders)return;I.length!==0&&I.forEach(u=>{if(!u||typeof u!="object")return;let h=0,t=0,d=u.items;if(!(!d||!Array.isArray(d)||d.length===0)&&(d.forEach(n=>{n&&typeof n=="object"&&(n.actual_amount&&(h+=parseFloat(n.actual_amount)||0),(n.item_commission||n.capped_brand_commission)&&(t+=parseFloat(n.item_commission||0)+parseFloat(n.capped_brand_commission||0)))}),d.length>0)){let n=d[0];if(!n||typeof n!="object")return;let p=e.purchase_time||u.purchase_time,f=e.click_time||u.click_time,g=e.checkout_complete_time||u.checkout_complete_time,E=p?p>9466848e5?p:p*1e3:null,q=f?f>9466848e5?f:f*1e3:null,K=g?g>9466848e5?g:g*1e3:null,V="";u.shop_type===1?V="C2C(Non-CB)":u.shop_type===3?V="Mall":u.shop_type===5&&(V="Preferred");let T=u.order_status||"";(e.shopee_order_status||u.shopee_order_status)===3||T==="CANCEL"||T==="CANCELED"||T==="Canceled"||T==="CANCELLED"?T="\u0110\xE3 h\u1EE7y":T==="PAID"||T==="UNPAID"||T==="Pending"||T==="PENDING"||T==="Waiting for payment"||T==="WAITING_FOR_PAYMENT"?T="\u0110ang ch\u1EDD x\u1EED l\xFD":T==="COMPLETED"||T==="Completed"?T="\u0110\xE3 ho\xE0n th\xE0nh":T||(T="\u0110\xE3 ho\xE0n th\xE0nh");let y=w=>w?new Date(w).toISOString().slice(0,19).replace("T"," "):"",L="",O=e.last_external_source||u.last_external_source||e.referrer||u.referrer||e.channel||u.channel||n.referrer||n.channel||e.first_external_source||u.first_external_source||e.direct_source||u.direct_source||e.indirect_source||u.indirect_source||"";L=Ee(O),L||(L=e.internal_source||u.internal_source||n.internal_source||""),L||(L="");let B=h>1e3?h/1e5:h,P={id:l++,order_id:u.order_sn||u.order_id||"",status:T,checkout_id:e.checkout_id||"",order_time:y(E),completion_time:y(K),click_time:y(q),click_time_ts:q,purchase_time_ts:E,shop_name:n.shop_name||"",shop_id:String(n.shop_id||""),shop_type:V,item_id:String(n.item_id||""),item_name:n.item_name||"",model_id:String(n.model_id||""),product_type:"Normal Product",promotion_id:n.promotion_id||"",l1_category:n.global_category_lv1_name||"",l2_category:n.global_category_lv2_name||"",l3_category:n.global_category_lv3_name||"",price:n.item_price?n.item_price>1e3?n.item_price/1e5:n.item_price:0,quantity:n.qty?parseInt(n.qty):0,commission_type:n.brand_commission_rate&&n.brand_commission_rate>0?"XTRA Comm":"",strategic_partner:"",order_value:h>1e3?h/1e5:h,actual_order_value:B,refund_amount:n.refunded_amount?n.refunded_amount>1e3?parseFloat(n.refunded_amount)/1e5:parseFloat(n.refunded_amount):0,shopee_commission_rate:n.platform_commission_rate?n.platform_commission_rate>1?parseFloat(n.platform_commission_rate)/100:parseFloat(n.platform_commission_rate):0,shopee_commission_amount:n.item_commission?n.item_commission>1e3?parseFloat(n.item_commission)/1e5:parseFloat(n.item_commission):0,seller_commission_rate:n.brand_commission_rate?n.brand_commission_rate>1?parseFloat(n.brand_commission_rate)/100:parseFloat(n.brand_commission_rate):0,xtra_commission_amount:n.capped_brand_commission?n.capped_brand_commission>1e3?parseFloat(n.capped_brand_commission)/1e5:parseFloat(n.capped_brand_commission):0,total_product_commission:t>1e3?t/1e5:t,shopee_order_commission:e.capped_commission?e.capped_commission>1e3?parseFloat(e.capped_commission)/1e5:parseFloat(e.capped_commission):0,seller_order_commission:e.total_brand_commission?e.total_brand_commission>1e3?parseFloat(e.total_brand_commission)/1e5:parseFloat(e.total_brand_commission):0,total_order_commission:e.estimated_total_commission_with_mcn?parseFloat(e.estimated_total_commission_with_mcn)>=1e5?parseFloat(e.estimated_total_commission_with_mcn)/1e5:parseFloat(e.estimated_total_commission_with_mcn)/100:0,mnc_name:e.linked_mcn_name||"",mnc_contract_code:e.mcn_agreement_id||"",mcn_management_fee_rate:e.linked_mcn_commission_rate?e.linked_mcn_commission_rate>1?parseFloat(e.linked_mcn_commission_rate)/100:parseFloat(e.linked_mcn_commission_rate):0,mcn_management_fee:e.mcn_management_fee_commission?e.mcn_management_fee_commission>1e3?parseFloat(e.mcn_management_fee_commission)/1e5:parseFloat(e.mcn_management_fee_commission):0,affiliate_commission_rate:98,net_affiliate_commission:e.affiliate_net_commission?e.affiliate_net_commission>1e3?parseFloat(e.affiliate_net_commission)/1e5:parseFloat(e.affiliate_net_commission):0,estimated_total_commission:e.estimated_total_commission?e.estimated_total_commission>1e3?parseFloat(e.estimated_total_commission)/1e5:parseFloat(e.estimated_total_commission):0,product_link_status:n.display_item_status||"",product_notes:"",attribute_type:"\u0110\u01A1n h\xE0ng t\u1EEB c\xE1c Shop kh\xE1c nhau",buyer_status:e.user_status==="Existing"||u.user_status==="Existing"?"\u0110\xE3 t\u1ED3n t\u1EA1i":"M\u1EDBi",...function(){let w=e.utm_content||u.utm_content||"",J=e.click_id||u.click_id||"",Y=e.product_type||u.product_type||"",U=e.internal_source||u.internal_source||"",m=e.indirect_source||u.indirect_source||"";if(w.includes("-")){let i=de(w);return{sub_id1:i.sub_id1||"",sub_id2:i.sub_id2||"",sub_id3:i.sub_id3||"",sub_id4:i.sub_id4||"",sub_id5:i.sub_id5||""}}else return{sub_id1:w,sub_id2:J,sub_id3:Y,sub_id4:U,sub_id5:m}}(),channel:L};a.push(P)}})}),a}function ve(o){let a=o.getFullYear(),l=String(o.getMonth()+1).padStart(2,"0"),r=String(o.getDate()).padStart(2,"0");return`${a}-${l}-${r}`}function xe(o,a){let l;return(...r)=>{clearTimeout(l),l=setTimeout(()=>o.apply(this,r),a)}}function Se(){let o=new Date,a=new Date(o);a.setDate(a.getDate()-1);let l=ve(a);document.getElementById("start_date").value=l,document.getElementById("end_date").value=l,document.querySelectorAll(".quick-date-btn").forEach(e=>{e.getAttribute("data-days")==="1"?e.classList.add("active"):e.classList.remove("active")})}function Te(o){let a=new Date,l=new Date(a);l.setDate(l.getDate()-1),l.setHours(23,59,59,999);let r=new Date(l);r.setDate(r.getDate()-(o-1)),r.setHours(0,0,0,0),document.getElementById("start_date").value=ve(r),document.getElementById("end_date").value=ve(l),document.getElementById("start_time").value="00:00",document.getElementById("end_time").value="23:59"}function ge(){document.getElementById("loadingMessage").style.display="none";let o=document.getElementById("noDataMessage");o&&(o.style.display="block")}function fe(){let o=document.getElementById("start_date").value,a=document.getElementById("start_time").value||"00:00",l=document.getElementById("end_date").value,r=document.getElementById("end_time").value||"23:59",e=document.getElementById("sub_id").value.trim(),c=document.getElementById("sub_id_type").value,s=document.getElementById("sub_id_field").value.trim(),_=c&&s!=="",S=null,I=null;if(o){let[d,n,p]=o.split("-").map(Number),[f,g]=(a||"00:00").split(":").map(Number);S=new Date(d,n-1,p,f,g,0,0).getTime()}if(l){let[d,n,p]=l.split("-").map(Number),[f,g]=(r||"23:59").split(":").map(Number);I=new Date(d,n-1,p,f,g,59,999).getTime()}R=te.filter(d=>{let n=d.purchase_time_ts;if(!n&&d.order_time&&(n=new Date(d.order_time).getTime()),(!n||isNaN(n))&&(n=d.click_time_ts),(!n||isNaN(n))&&(n=d.click_time?new Date(d.click_time).getTime():null),(!n||isNaN(n))&&(n=d.completion_time?new Date(d.completion_time).getTime():null),!n||isNaN(n)||S!==null&&n<S||I!==null&&n>I)return!1;if(_){let p=d[c]||"";return p===s||p.includes(s)}else{if(e==="")return!0;for(let p=1;p<=5;p++){let f=`sub_id${p}`,g=d[f]||"";if(g===e||g.includes(e))return!0}return!1}});let u=d=>{if(!d)return"";let[n,p,f]=d.split("-");return`${f}/${p}/${n}`},h=document.getElementById("startDate"),t=document.getElementById("endDate");if(h&&(h.textContent=u(o)||""),t){let d=u(l);d&&d!==u(o)?t.textContent=` - ${d}`:t.textContent=""}ee={overview:!1,gmv:!1,commission:!1,performance:!1},requestAnimationFrame(()=>{Le()})}function Le(){if(R.length===0){$e();let m=document.getElementById("noFilterResultsMessage");m&&(m.style.display="block");let i=document.getElementById("result-capture");i&&(i.style.display="none");return}let o=document.getElementById("noFilterResultsMessage");o&&(o.style.display="none");let a=document.getElementById("result-capture");a&&(a.style.display="block"),v={total:0,video:0,live:0,social:0,zero:0,cancelled:0},z={total:0,video:0,live:0,social:0,average_order_value:0,by_category:{},by_day:{},by_hour:{}},x={total:0,video:0,live:0,social:0,average_commission:0,commission_rate:0,by_category:{},by_day:{},by_hour:{},xtra_rate:0,shopee_rate:0};let l=0,r=0,e=0,c=0,s={},_={},S={},I={},u={},h={},t={},d={},n={},p=new Set,f={},g=R.length;for(let m=0;m<g;m++){let i=R[m],k=parseFloat(i.actual_order_value)||0,F=parseFloat(i.total_order_commission)||0,M=parseFloat(i.xtra_commission_amount)||0,N=parseFloat(i.shopee_commission_amount)||0,H=i.order_id&&i.order_id.trim()?i.order_id:null;if(H){if(p.add(H),!f[H]){let me=parseFloat(i.shopee_order_commission)||0,re=parseFloat(i.seller_order_commission)||0;f[H]={order_id:H,total_order_commission:F,shopee_order_commission:me,seller_order_commission:re,channel:i.channel||"",status:i.status||"",actual_order_value:0,purchase_time_ts:i.purchase_time_ts,order_time:i.order_time}}f[H].actual_order_value+=k}let A=i.l1_category||"Kh\xE1c",G=`${i.shop_id}__${i.item_id}`;if(!t[G]){let me=i.channel||"",re="social";me==="Shopeevideo-Shopee"?re="video":me==="Shopeelive-Shopee"&&(re="live"),t[G]={item_id:i.item_id,shop_id:i.shop_id,name:i.item_name,link:`https://shopee.vn/product/${i.shop_id}/${i.item_id}`,order_count:0,gmv:0,commission:0,commission_rate:0,category:A,channel:re}}let W=i.shop_id;W&&!d[W]&&(d[W]={shop_name:i.shop_name,shop_id:W,link:W?`https://shopee.vn/shop/${W}`:"",order_count:0,gmv:0,commission:0,commission_rate:0});let oe=i.sub_id1,se=i.sub_id2,ie=i.sub_id3,ae=i.sub_id4,le=i.sub_id5;oe&&oe.trim()&&(n[oe]||(n[oe]={count:0,commission:0}),n[oe].count++),se&&se.trim()&&(n[se]||(n[se]={count:0,commission:0}),n[se].count++),ie&&ie.trim()&&(n[ie]||(n[ie]={count:0,commission:0}),n[ie].count++),ae&&ae.trim()&&(n[ae]||(n[ae]={count:0,commission:0}),n[ae].count++),le&&le.trim()&&(n[le]||(n[le]={count:0,commission:0}),n[le].count++)}let E=Object.values(f),q=E.length;for(let m=0;m<q;m++){let i=E[m],k=parseFloat(i.actual_order_value)||0,F=parseFloat(i.total_order_commission)||0,M=parseFloat(i.shopee_order_commission)||0,N=parseFloat(i.seller_order_commission)||0;l+=k,r+=F,c+=M,e+=N;let H=i.channel||"",A="social";H==="Shopeevideo-Shopee"?(v.video++,A="video"):H==="Shopeelive-Shopee"?(v.live++,A="live"):v.social++,z[A]+=k,x[A]+=F,k===0&&v.zero++,i.status==="\u0110\xE3 h\u1EE7y"&&v.cancelled++}v.total=p.size;let K={};for(let m=0;m<g;m++){let i=R[m],k=i.order_id&&i.order_id.trim()?i.order_id:null;k&&!K[k]&&(K[k]=i.l1_category||"Kh\xE1c")}for(let m=0;m<q;m++){let i=E[m],k=i.purchase_time_ts||(i.order_time?new Date(i.order_time).getTime():null);if(k){let F=new Date(k),M=F.toISOString().split("T")[0],N=String(F.getHours()).padStart(2,"0"),H=parseFloat(i.actual_order_value)||0,A=parseFloat(i.total_order_commission)||0;s[M]=(s[M]||0)+H,S[N]=(S[N]||0)+H,_[M]=(_[M]||0)+A,I[N]=(I[N]||0)+A;let G=K[i.order_id]||"Kh\xE1c";u[G]=(u[G]||0)+H,h[G]=(h[G]||0)+A}}let V={},T={};for(let m=0;m<g;m++){let i=R[m],k=i.order_id&&i.order_id.trim()?i.order_id:null;if(k&&f[k]){let F=`${i.shop_id}__${i.item_id}`,M=i.shop_id;V[F]||(V[F]=new Set),T[M]||(T[M]=new Set),V[F].add(k),T[M].add(k)}}let D=Object.keys(V),y=D.length;for(let m=0;m<y;m++){let i=D[m],k=0,F=0,M=V[i].size,N=Array.from(V[i]),H=N.length;for(let A=0;A<H;A++){let G=N[A],W=f[G];W&&(k+=parseFloat(W.actual_order_value)||0,F+=parseFloat(W.total_order_commission)||0)}t[i]&&(t[i].order_count=M,t[i].gmv=k,t[i].commission=F)}let L=Object.keys(T),O=L.length;for(let m=0;m<O;m++){let i=L[m],k=0,F=0,M=T[i].size,N=Array.from(T[i]),H=N.length;for(let A=0;A<H;A++){let G=N[A],W=f[G];W&&(k+=parseFloat(W.actual_order_value)||0,F+=parseFloat(W.total_order_commission)||0)}d[i]&&(d[i].order_count=M,d[i].gmv=k,d[i].commission=F)}let B={};for(let m=0;m<g;m++){let i=R[m],k=i.order_id&&i.order_id.trim()?i.order_id:null;if(!k)continue;let F=i.sub_id1,M=i.sub_id2,N=i.sub_id3,H=i.sub_id4,A=i.sub_id5;F&&F.trim()&&(B[F]||(B[F]=new Set),B[F].add(k)),M&&M.trim()&&(B[M]||(B[M]=new Set),B[M].add(k)),N&&N.trim()&&(B[N]||(B[N]=new Set),B[N].add(k)),H&&H.trim()&&(B[H]||(B[H]=new Set),B[H].add(k)),A&&A.trim()&&(B[A]||(B[A]=new Set),B[A].add(k))}let P=Object.keys(n),w=P.length;for(let m=0;m<w;m++){let i=P[m],k=B[i]||new Set,F=0,M=Array.from(k),N=M.length;for(let H=0;H<N;H++){let A=M[H],G=f[A];G&&(F+=parseFloat(G.total_order_commission)||0)}n[i].commission=F,n[i].count=k.size}z.total=l,z.average_order_value=p.size>0?l/p.size:0,z.by_category=u,z.by_day=s,z.by_hour=S,x.total=r,x.average_commission=p.size>0?r/p.size:0,x.commission_rate=l>0?r/l*100:0,x.by_category=h,x.by_day=_,x.by_hour=I,x.xtra_rate=r>0?e/r*100:0,x.shopee_rate=r>0?c/r*100:0;let J=Object.values(t),Y=J.length;for(let m=0;m<Y;m++){let i=J[m];i.gmv>0&&(i.commission_rate=Math.round(i.commission/i.gmv*100*100)/100)}let U=Object.values(t).sort((m,i)=>i.commission-m.commission);X.top_performing_products=U.slice(0,10),X.low_performing_products=U.slice(-10).reverse(),_e=Object.values(d).sort((m,i)=>i.order_count-m.order_count).slice(0,5),_e.forEach(m=>{m.gmv>0&&(m.commission_rate=Math.round(m.commission/m.gmv*100*100)/100)}),be=U.slice(0,5),he=Object.entries(n).sort((m,i)=>m[1].count===i[1].count?i[1].commission-m[1].commission:i[1].count-m[1].count).slice(0,10).map(([m,i])=>({subId:m,...i})),De(R),He(l,r,e,c),requestAnimationFrame(()=>{Ce("overview"),requestAnimationFrame(()=>{je(),requestAnimationFrame(()=>{we(),Re()})})})}async function De(o){var a,l,r;ce={total:0,bySubId:{}},ue={overall:0,bySubId:{}},pe={overall:0,bySubId:{}};try{let e=((a=document.getElementById("sub_id"))==null?void 0:a.value.trim())||"",c=((l=document.getElementById("sub_id_type"))==null?void 0:l.value)||"",s=((r=document.getElementById("sub_id_field"))==null?void 0:r.value.trim())||"",_=c&&s!=="",S=await idb.getAllClicks(),I=Object.values(S),u=document.getElementById("start_date"),h=document.getElementById("start_time"),t=document.getElementById("end_date"),d=document.getElementById("end_time"),n=null,p=null;if(u&&u.value){let[D,y,L]=u.value.split("-").map(Number),[O,B]=((h==null?void 0:h.value)||"00:00").split(":").map(Number);n=new Date(D,y-1,L,O,B,0,0).getTime()}if(t&&t.value){let[D,y,L]=t.value.split("-").map(Number),[O,B]=((d==null?void 0:d.value)||"23:59").split(":").map(Number);p=new Date(D,y-1,L,O,B,59,999).getTime()}(n!==null||p!==null)&&(I=I.filter(D=>{let y=D.click_time;if(!y)return!1;let L=y>9466848e5?y:y*1e3;return!(n!==null&&L<n||p!==null&&L>p)})),_?I=I.filter(D=>{let y=D.sub_id;if(!y||y.trim()==="")return!1;let O=de(y)[c]||"";return O===s||O.includes(s)}):e!==""&&(I=I.filter(D=>{let y=D.sub_id;if(!y||y.trim()==="")return!1;let L=de(y);for(let O=1;O<=5;O++){let B=`sub_id${O}`,P=L[B]||"";if(P===e||P.includes(e))return!0}return!1})),ce.total=I.length;let f={};I.forEach(D=>{let y=D.sub_id;if(!y||y.trim()==="")return;let L=de(y);for(let O=1;O<=5;O++){let B=`sub_id${O}`,P=L[B];if(P&&P.trim()!==""){let w=`${B}:${P}`;f[w]||(f[w]=0),f[w]++}}});let g={},E={};o.forEach(D=>{let y=D.order_id;if(!y)return;let L=D.total_order_commission||0;for(let O=1;O<=5;O++){let B=`sub_id${O}`,P=D[B];if(!(!P||P.trim()===""))if(P.includes("-")){let w=de(P);for(let J=1;J<=5;J++){let Y=w[`sub_id${J}`];if(Y&&Y.trim()!==""){let U=`sub_id${J}:${Y}`;E[U]||(E[U]=new Set),E[U].has(y)||(E[U].add(y),g[U]||(g[U]={orders:0,commission:0}),g[U].orders++,g[U].commission+=L)}}}else{let w=`${B}:${P}`;E[w]||(E[w]=new Set),E[w].has(y)||(E[w].add(y),g[w]||(g[w]={orders:0,commission:0}),g[w].orders++,g[w].commission+=L)}}}),new Set([...Object.keys(f),...Object.keys(g)]).forEach(D=>{let y=f[D]||0,L=g[D]||{orders:0,commission:0},O=L.orders||0,B=L.commission||0;ce.bySubId[D]=y,ue.bySubId[D]={clicks:y,commission:B,epc:y>0?B/y:0},pe.bySubId[D]={clicks:y,orders:O,cvr:y>0?O/y:0}});let K=ce.total,V=v.total,T=x.total;ue.overall=K>0?T/K:0,pe.overall=K>0?V/K:0,Oe()}catch(e){console.error("Error calculating click stats:",e)}}function de(o){if(!o||o.trim()==="")return{sub_id1:"",sub_id2:"",sub_id3:"",sub_id4:"",sub_id5:""};let a=o.split("-");return{sub_id1:a[0]||"",sub_id2:a[1]||"",sub_id3:a[2]||"",sub_id4:a[3]||"",sub_id5:a[4]||""}}function Oe(){let o=document.getElementById("totalClicks");o&&(o.textContent=ce.total.toLocaleString("vi-VN"));let a=document.getElementById("overallEPC");a&&(a.textContent=b(ue.overall));let l=document.getElementById("overallCVR");l&&(l.textContent=(pe.overall*100).toFixed(2)+"%")}function $e(){document.getElementById("totalGmv").textContent="0 \u20AB",document.getElementById("totalCommission").textContent="0 \u20AB",document.getElementById("xtraCommission").textContent="0 \u20AB",document.getElementById("shopeeCommission").textContent="0 \u20AB"}function He(o,a,l,r){document.getElementById("totalGmv").innerHTML=b(o).replace(/ /g,"&nbsp;"),document.getElementById("totalCommission").innerHTML=b(a).replace(/ /g,"&nbsp;"),document.getElementById("xtraCommission").innerHTML=b(l).replace(/ /g,"&nbsp;"),document.getElementById("shopeeCommission").innerHTML=b(r).replace(/ /g,"&nbsp;");let e=document.getElementById("orderTotal"),c=document.getElementById("orderZeroBadge"),s=document.getElementById("orderCancelledBadge"),_=document.getElementById("totalOrders");e&&(e.textContent=v.total),c&&(c.textContent=v.zero),s&&(s.textContent=v.cancelled),_&&_.firstChild&&_.firstChild.nodeType===Node.TEXT_NODE&&(_.firstChild.textContent=`${v.total} (`);let S=document.getElementById("videoOrders");S&&(S.textContent=v.video);let I=document.getElementById("videoCommissionCell");I&&(I.innerHTML=b(x.video).replace(/ /g,"&nbsp;"));let u=document.getElementById("liveOrderRow"),h=document.getElementById("liveOrders"),t=document.getElementById("liveCommissionCell");v.live>0?(u&&u.classList.remove("d-none"),h&&(h.textContent=v.live),t&&(t.innerHTML=b(x.live).replace(/ /g,"&nbsp;"))):u&&u.classList.add("d-none");let d=document.getElementById("socialOrders");d&&(d.textContent=v.social);let n=document.getElementById("socialCommissionCell");n&&(n.innerHTML=b(x.social).replace(/ /g,"&nbsp;"));let p=document.getElementById("zeroCommissionOrders");p&&(p.innerHTML=v.zero>0?`<span class="badge bg-warning text-dark">${v.zero}</span>`:"0");let f=document.getElementById("zeroCommissionCell");f&&(f.innerHTML="0&nbsp;\u20AB");let g=document.getElementById("canceledOrderRow"),E=document.getElementById("canceledOrders"),q=document.getElementById("canceledCommissionCell");v.cancelled>0?(g&&g.classList.remove("d-none"),E&&(E.textContent=v.cancelled),q&&(q.innerHTML="0&nbsp;\u20AB")):g&&g.classList.add("d-none");let K=document.getElementById("totalCommissionCell");K&&(K.innerHTML=b(a).replace(/ /g,"&nbsp;"));let V=document.getElementById("orderVideoCount");V&&(V.textContent=v.video);let T=document.getElementById("orderLiveCount");T&&(T.textContent=v.live);let D=document.getElementById("orderSocialCount");D&&(D.textContent=v.social);let y=document.getElementById("orderZeroCount");y&&(y.textContent=v.zero);let L=document.getElementById("orderCancelledCount");L&&(L.textContent=v.cancelled);let O=document.getElementById("orderCommissionTotal");O&&(O.textContent=b(a)),document.getElementById("gmvTotal").textContent=b(z.total),document.getElementById("gmvAverage").textContent=b(z.average_order_value),document.getElementById("gmvVideo").textContent=b(z.video),document.getElementById("gmvLive").textContent=b(z.live),document.getElementById("gmvSocial").textContent=b(z.social),document.getElementById("comTotal").textContent=b(x.total),document.getElementById("comAverage").textContent=b(x.average_commission),document.getElementById("comVideo").textContent=b(x.video),document.getElementById("comLive").textContent=b(x.live),document.getElementById("comSocial").textContent=b(x.social),document.getElementById("comXtraRate").textContent=ye(x.xtra_rate),document.getElementById("comShopeeRate").textContent=ye(x.shopee_rate),document.getElementById("comRate").textContent=ye(x.commission_rate)}function b(o){let a=parseFloat(o)||0;return Math.round(a).toLocaleString("vi-VN")+" \u20AB"}function ye(o){return Math.round(o*100)/100+"%"}function Ce(o="overview"){typeof ChartDataLabels<"u"&&Chart.register(ChartDataLabels),R.length!==0&&(o==="overview"&&!ee.overview?(Fe(),ee.overview=!0):o==="gmv"&&!ee.gmv?(Ae(),ee.gmv=!0):o==="commission"&&!ee.commission&&(Me(),ee.commission=!0))}function Fe(){C.commission&&(C.commission.destroy(),C.commission=null),C.orderType&&(C.orderType.destroy(),C.orderType=null),C.channel&&(C.channel.destroy(),C.channel=null);let o=0,a=0;R.forEach(s=>{o+=parseFloat(s.xtra_commission_amount)||0,a+=parseFloat(s.shopee_commission_amount)||0});let l=document.getElementById("commissionChart");l&&(C.commission=new Chart(l.getContext("2d"),{type:"doughnut",data:{labels:[`Shopee (${b(a)})`,`Xtra (${b(o)})`],datasets:[{data:[a,o],backgroundColor:["#06b6d4","#ec4899"],borderWidth:1}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"bottom"},tooltip:{callbacks:{label:function(s){return s.label+": "+b(s.parsed)}}},datalabels:{color:"#222",font:{weight:"bold",size:14},formatter:function(s){return b(s)}}}},plugins:typeof ChartDataLabels<"u"?[ChartDataLabels]:[]}));let r=document.getElementById("orderTypeChart");r&&(C.orderType=new Chart(r.getContext("2d"),{type:"bar",data:{labels:["\u0110\u01A1n video","\u0110\u01A1n live","\u0110\u01A1n social","\u0110\u01A1n 0\u0111","\u0110\u01A1n h\u1EE7y"],datasets:[{label:"S\u1ED1 l\u01B0\u1EE3ng",data:[v.video,v.live,v.social,v.zero,v.cancelled],backgroundColor:["#ec4899","#06b6d4","#fde047","#8dd873","#667eea"],borderWidth:1}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1},tooltip:{callbacks:{label:function(s){return s.dataset.label+": "+s.parsed.y}}},datalabels:{anchor:"end",align:"top",font:{weight:"bold",size:15,family:"Segoe UI"},color:"#222",formatter:function(s){return s}}},scales:{y:{beginAtZero:!0,ticks:{callback:function(s){return s}}}}},plugins:typeof ChartDataLabels<"u"?[ChartDataLabels]:[]}));let e={};R.forEach(s=>{let _=(s.channel||"").trim()||"Kh\xE1c";e[_]=(e[_]||0)+1});let c=document.getElementById("channelChart");c&&(C.channel=new Chart(c.getContext("2d"),{type:"bar",data:{labels:Object.keys(e),datasets:[{label:"S\u1ED1 \u0111\u01A1n",data:Object.values(e),backgroundColor:["#f36f21","#ec4899","#06b6d4","#fde047","#8dd873","#667eea","#a78bfa","#fbbf24","#38bdf8","#f87171"],borderWidth:1}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1},tooltip:{callbacks:{label:function(s){return s.dataset.label+": "+s.parsed.y}}}},scales:{y:{beginAtZero:!0,ticks:{callback:function(s){return s}}}}}}))}function Ae(){if(C.gmvByDay&&(C.gmvByDay.destroy(),C.gmvByDay=null),C.gmvByHour&&(C.gmvByHour.destroy(),C.gmvByHour=null),C.gmvByCategory&&(C.gmvByCategory.destroy(),C.gmvByCategory=null),Object.keys(z.by_day).length>0){let o=document.getElementById("gmvByDayChart");if(o){let a=Object.keys(z.by_day).sort();C.gmvByDay=new Chart(o.getContext("2d"),{type:"line",data:{labels:a,datasets:[{label:"GMV theo ng\xE0y",data:a.map(l=>z.by_day[l]),borderColor:"#0d47a1",backgroundColor:"rgba(13, 71, 161, 0.1)",borderWidth:2,tension:.4,fill:!0}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1},tooltip:{callbacks:{label:function(l){return"GMV: "+b(l.parsed.y)}}}},scales:{y:{beginAtZero:!0,ticks:{callback:function(l){return b(l)}}}}}})}}if(Object.keys(z.by_hour).length>0){let o=document.getElementById("gmvByHourChart");if(o){let a=Object.keys(z.by_hour).sort();C.gmvByHour=new Chart(o.getContext("2d"),{type:"bar",data:{labels:a,datasets:[{label:"GMV theo gi\u1EDD",data:a.map(l=>z.by_hour[l]),backgroundColor:"rgba(13, 71, 161, 0.7)",borderColor:"#0d47a1",borderWidth:1}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1},tooltip:{callbacks:{label:function(l){return"GMV: "+b(l.parsed.y)}}}},scales:{y:{beginAtZero:!0,ticks:{callback:function(l){return b(l)}}}}}})}}if(Object.keys(z.by_category).length>0){let o=document.getElementById("gmvByCategoryChart");o&&(C.gmvByCategory=new Chart(o.getContext("2d"),{type:"pie",data:{labels:Object.keys(z.by_category),datasets:[{label:"GMV theo danh m\u1EE5c",data:Object.values(z.by_category),backgroundColor:["#f36f21","#ec4899","#06b6d4","#fde047","#8dd873","#667eea","#a78bfa","#fbbf24","#38bdf8","#f87171","#f36f21","#ec4899","#06b6d4","#fde047","#8dd873"],borderWidth:1}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"right"},tooltip:{callbacks:{label:function(a){let l=a.label||"",r=a.parsed,e=a.dataset.data.reduce((s,_)=>s+_,0),c=(r/e*100).toFixed(1);return l+": "+b(r)+" ("+c+"%)"}}}}}}))}}function Me(){if(C.comByDay&&(C.comByDay.destroy(),C.comByDay=null),C.comByHour&&(C.comByHour.destroy(),C.comByHour=null),C.comByCategory&&(C.comByCategory.destroy(),C.comByCategory=null),Object.keys(x.by_day).length>0){let o=document.getElementById("comByDayChart");if(o){let a=Object.keys(x.by_day).sort();C.comByDay=new Chart(o.getContext("2d"),{type:"line",data:{labels:a,datasets:[{label:"Hoa h\u1ED3ng theo ng\xE0y",data:a.map(l=>x.by_day[l]),borderColor:"#1b5e20",backgroundColor:"rgba(27, 94, 32, 0.1)",borderWidth:2,tension:.4,fill:!0}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1},tooltip:{callbacks:{label:function(l){return"Hoa h\u1ED3ng: "+b(l.parsed.y)}}}},scales:{y:{beginAtZero:!0,ticks:{callback:function(l){return b(l)}}}}}})}}if(Object.keys(x.by_hour).length>0){let o=document.getElementById("comByHourChart");if(o){let a=Object.keys(x.by_hour).sort();C.comByHour=new Chart(o.getContext("2d"),{type:"bar",data:{labels:a,datasets:[{label:"Hoa h\u1ED3ng theo gi\u1EDD",data:a.map(l=>x.by_hour[l]),backgroundColor:"rgba(27, 94, 32, 0.7)",borderColor:"#1b5e20",borderWidth:1}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1},tooltip:{callbacks:{label:function(l){return"Hoa h\u1ED3ng: "+b(l.parsed.y)}}}},scales:{y:{beginAtZero:!0,ticks:{callback:function(l){return b(l)}}}}}})}}if(Object.keys(x.by_category).length>0){let o=document.getElementById("comByCategoryChart");o&&(C.comByCategory=new Chart(o.getContext("2d"),{type:"pie",data:{labels:Object.keys(x.by_category),datasets:[{label:"Hoa h\u1ED3ng theo danh m\u1EE5c",data:Object.values(x.by_category),backgroundColor:["#1b5e20","#4caf50","#8bc34a","#cddc39","#ffeb3b","#ffc107","#ff9800","#ff5722","#795548","#9e9e9e","#607d8b","#f36f21","#ec4899","#06b6d4","#fde047"],borderWidth:1}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"right"},tooltip:{callbacks:{label:function(a){let l=a.label||"",r=a.parsed,e=a.dataset.data.reduce((s,_)=>s+_,0),c=(r/e*100).toFixed(1);return l+": "+b(r)+" ("+c+"%)"}}}}}}))}}var j={all:null,pending:null,cancelled:null,completed:null};function je(){if(j.all){try{j.all.destroy()}catch(t){console.warn("Error destroying all table:",t)}j.all=null}if(j.pending){try{j.pending.destroy()}catch(t){console.warn("Error destroying pending table:",t)}j.pending=null}if(j.cancelled){try{j.cancelled.destroy()}catch(t){console.warn("Error destroying cancelled table:",t)}j.cancelled=null}if(j.completed){try{j.completed.destroy()}catch(t){console.warn("Error destroying completed table:",t)}j.completed=null}let o=R.map(t=>({data:["",t.order_id||"",t.shop_name||"",t.item_name||"",t.actual_order_value||0,t.quantity||0,t.total_order_commission||0,t.status||"",t.channel||"",t.sub_id1||"",t.sub_id2||"",t.sub_id3||"",t.sub_id4||"",t.sub_id5||""],order:t})),a=R.filter(t=>t.status==="\u0110ang ch\u1EDD x\u1EED l\xFD").map(t=>({data:["",t.order_id||"",t.shop_name||"",t.item_name||"",t.actual_order_value||0,t.quantity||0,t.total_order_commission||0,t.status||"",t.channel||"",t.sub_id1||"",t.sub_id2||"",t.sub_id3||"",t.sub_id4||"",t.sub_id5||""],order:t})),l=R.filter(t=>t.status==="\u0110\xE3 h\u1EE7y").map(t=>({data:["",t.order_id||"",t.shop_name||"",t.item_name||"",t.actual_order_value||0,t.quantity||0,t.total_order_commission||0,t.status||"",t.channel||"",t.sub_id1||"",t.sub_id2||"",t.sub_id3||"",t.sub_id4||"",t.sub_id5||""],order:t})),r=R.filter(t=>t.status==="\u0110\xE3 ho\xE0n th\xE0nh").map(t=>({data:["",t.order_id||"",t.shop_name||"",t.item_name||"",t.actual_order_value||0,t.quantity||0,t.total_order_commission||0,t.status||"",t.channel||"",t.sub_id1||"",t.sub_id2||"",t.sub_id3||"",t.sub_id4||"",t.sub_id5||""],order:t}));document.getElementById("allOrdersCount").textContent=R.length,document.getElementById("pendingOrdersCount").textContent=a.length,document.getElementById("completedOrdersCount").textContent=r.length,document.getElementById("cancelledOrdersCount").textContent=l.length;let e={responsive:!0,deferRender:!0,processing:!0,pageLength:50,order:[[1,"desc"]],language:{emptyTable:"Kh\xF4ng c\xF3 d\u1EEF li\u1EC7u",info:"Hi\u1EC3n th\u1ECB _START_ \u0111\u1EBFn _END_ c\u1EE7a _TOTAL_ m\u1EE5c",infoEmpty:"Hi\u1EC3n th\u1ECB 0 \u0111\u1EBFn 0 c\u1EE7a 0 m\u1EE5c",infoFiltered:"(\u0111\u01B0\u1EE3c l\u1ECDc t\u1EEB _MAX_ m\u1EE5c)",lengthMenu:"Hi\u1EC3n th\u1ECB _MENU_ m\u1EE5c",loadingRecords:"\u0110ang t\u1EA3i...",processing:"\u0110ang x\u1EED l\xFD...",search:"T\xECm ki\u1EBFm:",zeroRecords:"Kh\xF4ng t\xECm th\u1EA5y k\u1EBFt qu\u1EA3",paginate:{first:"\u0110\u1EA7u",last:"Cu\u1ED1i",next:"Ti\u1EBFp",previous:"Tr\u01B0\u1EDBc"}},columnDefs:[{targets:[3],width:"250px"},{targets:[0],orderable:!1}]};function c(t,d){let n=document.createElement("tr");return t.forEach((p,f)=>{let g=document.createElement("td");if(f===0){let E=d.item_id||"",q=d.shop_id||"",K="";if(E){let V=chrome.runtime.getURL(`product-detail.html?item_id=${encodeURIComponent(E)}`);K+=`<a href="${V}" target="_blank" title="Xem chi ti\u1EBFt s\u1EA3n ph\u1EA9m" style="text-decoration: none; margin-right: 8px;">
                        <span style="font-size: 18px;">\u{1F50D}</span>
                    </a>`}if(q&&E){let V=`https://shopee.vn/product/${encodeURIComponent(q)}/${encodeURIComponent(E)}`;K+=`<a href="${V}" target="_blank" title="Xem tr\xEAn Shopee" style="text-decoration: none;">
                        <span style="font-size: 18px;">\u{1F6D2}</span>
                    </a>`}g.innerHTML=K||"-",g.style.textAlign="center"}else if(f===4)g.textContent=b(p),g.setAttribute("data-order",p);else if(f===6)g.textContent=b(p),g.setAttribute("data-order",p);else if(f===7){let E=p==="\u0110\xE3 h\u1EE7y"?"bg-danger":p==="\u0110ang ch\u1EDD x\u1EED l\xFD"?"bg-warning":"bg-success";g.innerHTML=`<span class="badge ${E}">${Z(p)}</span>`}else g.textContent=p;n.appendChild(g)}),n}function s(t,d,n){if(d.length===0)return;let p=document.createDocumentFragment();d.forEach(f=>{p.appendChild(n(f.data,f.order))}),t.appendChild(p)}let _=document.querySelector("#orders-table-all");if(_){let t=_.querySelector("tbody");t.innerHTML="",s(t,o,c);let d={...e,columnDefs:[...e.columnDefs,{targets:[4,6],type:"num"}]};j.all=$("#orders-table-all").DataTable(d)}let S=document.querySelector("#orders-table-pending");if(S){let t=S.querySelector("tbody");t.innerHTML="",s(t,a,c);let d={...e,columnDefs:[...e.columnDefs,{targets:[4,6],type:"num"}]};j.pending=$("#orders-table-pending").DataTable(d)}let I=document.querySelector("#orders-table-cancelled");if(I){let t=I.querySelector("tbody");t.innerHTML="",s(t,l,c);let d={...e,columnDefs:[...e.columnDefs,{targets:[4,6],type:"num"}]};j.cancelled=$("#orders-table-cancelled").DataTable(d)}let u=document.querySelector("#orders-table-completed");if(u){let t=u.querySelector("tbody");t.innerHTML="",s(t,r,c);let d={...e,columnDefs:[...e.columnDefs,{targets:[4,6],type:"num"}]};j.completed=$("#orders-table-completed").DataTable(d)}document.querySelectorAll('#orderTab a[data-bs-toggle="tab"]').forEach(t=>{t.addEventListener("shown.bs.tab",function(){setTimeout(()=>{j.all&&j.all.columns.adjust(),j.pending&&j.pending.columns.adjust(),j.cancelled&&j.cancelled.columns.adjust(),j.completed&&j.completed.columns.adjust()},100)})})}function we(){let o=document.getElementById("topShopsList");o.innerHTML="",_e.length===0?o.innerHTML='<li class="list-group-item">Ch\u01B0a c\xF3 d\u1EEF li\u1EC7u</li>':_e.forEach(s=>{let _=document.createElement("li");_.className="list-group-item d-flex justify-content-between align-items-center flex-wrap p-2",_.innerHTML=`
                <div>
                    ${s.link?`<a href="${s.link}" target="_blank">${Z(s.shop_name)}</a>`:Z(s.shop_name)}
                    <br>
                    <span class="text-muted" style="font-size:12px;">Shop ID: ${Z(s.shop_id)}</span>
                </div>
                <div class="text-right ml-auto" style="min-width: 150px;">
                    <span class="badge bg-info" style="font-size:13px;">\u0110\u01A1n: ${s.order_count}</span>
                    <span class="badge bg-secondary" style="font-size:13px;">GMV: ${b(s.gmv)}</span>
                    <span class="badge bg-success" style="font-size:13px;">Hoa h\u1ED3ng: ${b(s.commission)}</span>
                    <span class="badge bg-warning" style="font-size:13px;">T\u1EC9 l\u1EC7 HH: ${s.commission_rate}%</span>
                </div>
            `,o.appendChild(_)});let a=document.getElementById("topProductsList2");a.innerHTML="",be.length===0?a.innerHTML='<li class="list-group-item">Ch\u01B0a c\xF3 d\u1EEF li\u1EC7u</li>':be.forEach(s=>{let _=document.createElement("li");_.className="list-group-item d-flex justify-content-between align-items-center flex-wrap p-2",_.innerHTML=`
                <div style="min-width:200px;">
                    ${s.link?`<a href="${s.link}" target="_blank">${Z(s.name)}</a>`:Z(s.name)}
                    <br>
                    <span class="text-muted" style="font-size:12px;">Item ID: ${Z(s.item_id)}</span>
                </div>
                <div class="text-right ml-auto" style="min-width: 220px;">
                    <span class="badge bg-info" style="font-size:13px;">\u0110\u01A1n: ${s.order_count}</span>
                    <span class="badge bg-secondary" style="font-size:13px;">GMV: ${b(s.gmv)}</span>
                    <span class="badge bg-success" style="font-size:13px;">Hoa h\u1ED3ng: ${b(s.commission)}</span>
                    <span class="badge bg-warning" style="font-size:13px;">T\u1EC9 l\u1EC7 HH: ${s.commission_rate}%</span>
                </div>
            `,a.appendChild(_)});let l=document.getElementById("topSubIdsList");l.innerHTML="",he.length===0?l.innerHTML='<li class="list-group-item">Ch\u01B0a c\xF3 d\u1EEF li\u1EC7u SubID</li>':he.forEach(s=>{let _=document.createElement("li");_.className="list-group-item d-flex justify-content-between align-items-center p-2",_.innerHTML=`
                <div>
                    <strong>${Z(s.subId)}</strong>
                    <span class="text-muted">(${s.count} \u0111\u01A1n)</span>
                </div>
                <span class="badge bg-info badge-pill">${b(s.commission)}</span>
            `,l.appendChild(_)});let r=document.getElementById("topProductsList");r.innerHTML="",X.top_performing_products&&X.top_performing_products.length>0?X.top_performing_products.slice(0,5).forEach(s=>{let _=document.createElement("li");_.className="list-group-item d-flex justify-content-between align-items-center",_.innerHTML=`
                <div>
                    <a href="${s.link}" target="_blank">${Z(s.name)}</a>
                    <div class="small text-muted">ID: ${Z(s.item_id)}</div>
                </div>
                <div class="text-right">
                    <span class="badge bg-info">\u0110\u01A1n: ${s.order_count}</span>
                    <span class="badge bg-success">HH: ${b(s.commission)}</span>
                </div>
            `,r.appendChild(_)}):r.innerHTML="<p>Ch\u01B0a c\xF3 d\u1EEF li\u1EC7u</p>";let e=document.getElementById("lowProductsList");e.innerHTML="",X.low_performing_products&&X.low_performing_products.length>0?X.low_performing_products.slice(0,5).forEach(s=>{let _=document.createElement("li");_.className="list-group-item d-flex justify-content-between align-items-center",_.innerHTML=`
                <div>
                    <a href="${s.link}" target="_blank">${Z(s.name)}</a>
                    <div class="small text-muted">ID: ${Z(s.item_id)}</div>
                </div>
                <div class="text-right">
                    <span class="badge bg-info">\u0110\u01A1n: ${s.order_count}</span>
                    <span class="badge bg-success">HH: ${b(s.commission)}</span>
                </div>
            `,e.appendChild(_)}):e.innerHTML="<p>Ch\u01B0a c\xF3 d\u1EEF li\u1EC7u</p>";let c=document.getElementById("performanceWarnings");if(c.innerHTML="",x.commission_rate<5){let s=document.createElement("div");s.className="alert-box alert-warning",s.innerHTML="<strong>C\u1EA3nh b\xE1o:</strong> T\u1EF7 l\u1EC7 hoa h\u1ED3ng th\u1EA5p (< 5%). C\xE2n nh\u1EAFc t\u1EADp trung v\xE0o s\u1EA3n ph\u1EA9m c\xF3 hoa h\u1ED3ng cao h\u01A1n.",c.appendChild(s)}if(v.total>0&&v.cancelled/v.total>.2){let s=document.createElement("div");s.className="alert-box alert-warning",s.innerHTML="<strong>C\u1EA3nh b\xE1o:</strong> T\u1EF7 l\u1EC7 \u0111\u01A1n h\u1EE7y cao (> 20%). C\u1EA7n xem x\xE9t l\u1EA1i ch\u1EA5t l\u01B0\u1EE3ng s\u1EA3n ph\u1EA9m ho\u1EB7c quy tr\xECnh b\xE1n h\xE0ng.",c.appendChild(s)}if(v.total>0&&v.zero/v.total>.1){let s=document.createElement("div");s.className="alert-box alert-warning",s.innerHTML="<strong>C\u1EA3nh b\xE1o:</strong> T\u1EF7 l\u1EC7 \u0111\u01A1n 0\u0111 cao (> 10%). C\xF3 th\u1EC3 do s\u1EA3n ph\u1EA9m h\u1EBFt h\xE0ng ho\u1EB7c l\u1ED7i h\u1EC7 th\u1ED1ng.",c.appendChild(s)}}var ne={all:new Set,sub_id1:new Set,sub_id2:new Set,sub_id3:new Set,sub_id4:new Set,sub_id5:new Set};function Re(){ne={all:new Set,sub_id1:new Set,sub_id2:new Set,sub_id3:new Set,sub_id4:new Set,sub_id5:new Set},te.forEach(r=>{for(let e=1;e<=5;e++){let c=r[`sub_id${e}`];c&&c.trim()!==""&&(ne.all.add(c),ne[`sub_id${e}`].add(c))}});let o=document.getElementById("all_sub_id_list");o&&(o.innerHTML="",Array.from(ne.all).sort().forEach(r=>{let e=document.createElement("option");e.value=r,o.appendChild(e)}));let a=document.getElementById("sub_id_type"),l=document.getElementById("subid_field_list");if(a&&l){let r=a.cloneNode(!0);a.parentNode.replaceChild(r,a),document.getElementById("sub_id_type").addEventListener("change",function(){l.innerHTML="";let e=this.value;e&&ne[e]&&Array.from(ne[e]).sort().forEach(c=>{let s=document.createElement("option");s.value=c,l.appendChild(s)})})}}function Z(o){let a=document.createElement("div");return a.textContent=o,a.innerHTML}function Ne(){if(!R||R.length===0){alert("Kh\xF4ng c\xF3 d\u1EEF li\u1EC7u \u0111\u1EC3 xu\u1EA5t!");return}let a=[["ID \u0111\u01A1n h\xE0ng","T\xEAn Shop","T\xEAn Item","Gi\xE1 tr\u1ECB \u0111\u01A1n","S\u1ED1 l\u01B0\u1EE3ng","T\u1ED5ng hoa h\u1ED3ng","Tr\u1EA1ng th\xE1i","K\xEAnh","SubID1","SubID2","SubID3","SubID4","SubID5"].join(","),...R.map(c=>[`"${c.order_id}"`,`"${c.shop_name}"`,`"${(c.item_name||"").replace(/"/g,'""')}"`,c.actual_order_value,c.quantity,c.net_affiliate_commission,`"${c.status}"`,`"${c.channel}"`,`"${c.sub_id1||""}"`,`"${c.sub_id2||""}"`,`"${c.sub_id3||""}"`,`"${c.sub_id4||""}"`,`"${c.sub_id5||""}"`].join(","))].join(`
`),l=new Blob(["\uFEFF"+a],{type:"text/csv;charset=utf-8;"}),r=document.createElement("a"),e=URL.createObjectURL(l);r.href=e,r.download=`shopee_orders_${new Date().toISOString().slice(0,10)}.csv`,r.style.visibility="hidden",document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(e)}function ze(){if(!R||R.length===0){alert("Kh\xF4ng c\xF3 d\u1EEF li\u1EC7u \u0111\u1EC3 xu\u1EA5t!");return}let o=JSON.stringify(R,null,2),a=new Blob([o],{type:"application/json"}),l=document.createElement("a"),r=URL.createObjectURL(a);l.href=r,l.download=`shopee_orders_${new Date().toISOString().slice(0,10)}.json`,l.style.visibility="hidden",document.body.appendChild(l),l.click(),document.body.removeChild(l),URL.revokeObjectURL(r)}function Ve(){window.print()}async function qe(){let o=document.getElementById("result-capture");if(o)try{(await html2canvas(o,{})).toBlob(async function(l){try{let r=new ClipboardItem({"image/png":l});await navigator.clipboard.write([r]);let e=document.createElement("div");e.className="toast-notification",e.textContent="\u0110\xE3 copy \u1EA3nh v\xE0o b\u1ED9 nh\u1EDB \u0111\u1EC7m!",document.body.appendChild(e),setTimeout(()=>e.remove(),2e3)}catch(r){console.error("L\u1ED7i khi copy v\xE0o clipboard:",r),alert("Kh\xF4ng th\u1EC3 copy \u1EA3nh v\xE0o b\u1ED9 nh\u1EDB \u0111\u1EC7m. Vui l\xF2ng th\u1EED l\u1EA1i.")}},"image/png")}catch(a){console.error("L\u1ED7i khi ch\u1EE5p \u1EA3nh:",a),alert("C\xF3 l\u1ED7i khi ch\u1EE5p \u1EA3nh. Vui l\xF2ng th\u1EED l\u1EA1i.")}}})();
