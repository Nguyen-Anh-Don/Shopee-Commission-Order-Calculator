(()=>{(function(){console.log("[Chart Creator] Script loaded");let c=!1,n=0,h=10;function d(){if(c){console.log("[Chart Creator] Already initializing, skipping...");return}console.log("[Chart Creator] Starting chart creation...");let a=document.getElementById("shopee-price-tracking-chart");if(console.log("[Chart Creator] Canvas:",a),!a){console.error("[Chart Creator] \u274C Canvas not found!");return}if(typeof Chart>"u"){console.error("[Chart Creator] \u274C Chart.js not loaded!"),n<h?(n++,console.log(`[Chart Creator] Retrying in 500ms... (${n}/${h})`),setTimeout(d,500)):console.error("[Chart Creator] \u274C Max retries reached. Chart.js not available.");return}console.log("[Chart Creator] \u2705 Chart.js available");let C=a.getAttribute("data-chart");if(console.log("[Chart Creator] Data attribute:",C?"Found":"Not found"),!C){console.error("[Chart Creator] \u274C No chart data in canvas!"),n<h?(n++,console.log(`[Chart Creator] Retrying in 500ms... (${n}/${h})`),setTimeout(d,500)):console.error("[Chart Creator] \u274C Max retries reached. No chart data available.");return}n=0,c=!0;let o;try{o=JSON.parse(C),console.log("[Chart Creator] Parsed chart data:",o)}catch(i){console.error("[Chart Creator] \u274C Failed to parse chart data:",i),c=!1;return}if(!o||!o.labels||!o.datasets){console.error("[Chart Creator] \u274C Invalid chart data structure!"),c=!1;return}let g=a.getAttribute("data-stats"),t=null;if(g)try{t=JSON.parse(g),console.log("[Chart Creator] Stats:",t)}catch(i){console.warn("[Chart Creator] Failed to parse stats:",i)}try{if(window.priceTrackingChartInstance){console.log("[Chart Creator] Destroying old chart...");try{window.priceTrackingChartInstance.destroy()}catch(e){console.warn("[Chart Creator] Error destroying old chart:",e)}window.priceTrackingChartInstance=null}let i=a.getContext("2d");window.priceTrackingChartInstance=new Chart(i,{type:"line",data:{labels:o.labels,datasets:[{label:"Gi\xE1",data:o.datasets[0].data,borderColor:"#ee4d2d",backgroundColor:"rgba(238, 77, 45, 0.08)",borderWidth:1.5,tension:.1,pointRadius:0,pointHoverRadius:6,pointHoverBorderWidth:2,pointHoverBackgroundColor:"#ee4d2d",pointHoverBorderColor:"#fff",fill:!0},t?{label:"Th\u1EA5p nh\u1EA5t",data:Array(o.labels.length).fill(t.min_price),borderColor:"#2196F3",borderWidth:1,borderDash:[5,5],pointRadius:0,fill:!1}:null,t?{label:"Cao nh\u1EA5t",data:Array(o.labels.length).fill(t.max_price),borderColor:"#f44336",borderWidth:1,borderDash:[5,5],pointRadius:0,fill:!1}:null,t?{label:"Hi\u1EC7n t\u1EA1i",data:Array(o.labels.length).fill(t.current_price),borderColor:"#ff9800",borderWidth:1,borderDash:[3,3],pointRadius:0,fill:!1}:null].filter(Boolean)},options:{responsive:!0,maintainAspectRatio:!1,layout:{padding:{right:50}},animation:{duration:1e3,easing:"easeInOutQuart"},interaction:{intersect:!1,mode:"index"},plugins:{legend:{display:!0,position:"top",align:"end",labels:{boxWidth:20,boxHeight:2,usePointStyle:!1,padding:10,font:{size:10,weight:"600"},filter:function(e){return e.text!=="Gi\xE1"}}},tooltip:{backgroundColor:"rgba(0, 0, 0, 0.8)",padding:12,titleFont:{size:13,weight:"bold"},bodyFont:{size:12},callbacks:{label:function(e){if(e.datasetIndex!==0)return null;let l=e.parsed.y;return"Gi\xE1: "+Math.round(l).toLocaleString("vi-VN")+" \u20AB"}},filter:function(e){return e.datasetIndex===0}}},scales:{x:{grid:{display:!1,drawBorder:!1},ticks:{maxRotation:0,minRotation:0,autoSkip:!0,maxTicksLimit:8,font:{size:10,weight:"500"},color:"#999"}},y:{position:"right",beginAtZero:!1,grid:{display:!0,color:"rgba(0, 0, 0, 0.03)",drawBorder:!1,lineWidth:1},border:{display:!1},ticks:{display:!1}}}},plugins:[{afterDatasetsDraw:function(e){let l=e.ctx,y=e.chartArea,f=e.scales.y;if(!t)return;l.save(),l.font='bold 10px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',l.textAlign="left";let b=f.getPixelForValue(t.min_price),m=f.getPixelForValue(t.max_price),x=f.getPixelForValue(t.current_price),p=15,s=[{y:m,text:u(t.max_price)+" \u20AB",color:"#f44336"},{y:x,text:u(t.current_price)+" \u20AB",color:"#ff9800"},{y:b,text:u(t.min_price)+" \u20AB",color:"#2196F3"}];s.sort((r,w)=>r.y-w.y);for(let r=1;r<s.length;r++)s[r].y-s[r-1].y<p&&(s[r].y=s[r-1].y+p);s.forEach(r=>{l.fillStyle=r.color,l.fillText(r.text,y.right+10,r.y+4)}),l.restore()}}]}),console.log("[Chart Creator] \u2705 Chart created successfully!"),console.log("[Chart Creator] Chart instance:",window.priceTrackingChartInstance),a.removeAttribute("data-chart"),a.removeAttribute("data-stats"),c=!1}catch(i){console.error("[Chart Creator] \u274C Error:",i),console.error("[Chart Creator] Stack:",i.stack),c=!1}}function u(a){return a?Math.round(a).toLocaleString("vi-VN"):"0"}window.addEventListener("createPriceChartNow",()=>{console.log("[Chart Creator] Received createPriceChartNow event"),n=0,d()}),console.log("[Chart Creator] Setting up auto-creation..."),document.readyState==="complete"||document.readyState==="interactive"?setTimeout(d,200):(window.addEventListener("DOMContentLoaded",()=>{setTimeout(d,200)}),window.addEventListener("load",()=>{setTimeout(d,200)}))})();})();
