(()=>{var _=[],m=[],B=[],P="commission",d=null;function O(s,t){let c;return function(...n){let o=()=>{clearTimeout(c),s(...n)};clearTimeout(c),c=setTimeout(o,t)}}function y(s){return s==null||isNaN(s)?"0 \u20AB":new Intl.NumberFormat("vi-VN",{style:"currency",currency:"VND",minimumFractionDigits:0,maximumFractionDigits:0}).format(s)}function l(s){let t=document.createElement("div");return t.textContent=s,t.innerHTML}document.addEventListener("DOMContentLoaded",function(){U();let s=document.getElementById("searchInput");s&&s.addEventListener("input",O(V,300));let t=document.getElementById("sortSelect");t&&t.addEventListener("change",q),document.querySelectorAll(".criteria-btn").forEach(a=>{a.addEventListener("click",function(){let r=this.getAttribute("data-criteria");N(r)})});let e=document.getElementById("exportReportBtn");e&&e.addEventListener("click",z),document.querySelectorAll('#productTabs button[data-bs-toggle="tab"]').forEach(a=>{a.addEventListener("shown.bs.tab",function(r){r.target.getAttribute("data-bs-target")==="#bestsellers"&&(d||K())})});let o=document.getElementById("openOptionsBtn");o&&o.addEventListener("click",function(){chrome.tabs.create({url:chrome.runtime.getURL("options.html")})}),document.addEventListener("click",function(a){let r=a.target.closest('button[data-favorite-btn="true"]');if(r)try{let i=r.getAttribute("data-product-key");if(i){let u=decodeURIComponent(i),g=JSON.parse(u);R(g.item_id,g.item_name,g.shop_name)}}catch(i){console.error("Error parsing product key:",i)}}),document.addEventListener("error",function(a){if(a.target.tagName==="IMG"&&a.target.hasAttribute("data-product-image")){a.target.style.display="none";let r=a.target.nextElementSibling;r&&r.classList.contains("product-image-placeholder")&&(r.style.display="flex")}},!0)});async function U(){try{let[s,t]=await Promise.all([idb.getAllOrders(),idb.getAllClicks()]);if(Object.keys(s).length===0){T();return}B=await idb.getAllFavorites();let c=new Map;B.forEach(o=>{let a=idb.generateFavoriteId(o.item_id,o.item_name,o.shop_name);c.set(a,o)});let e=j(s);_=window.productAnalytics.processProductAnalytics(e,t),_.forEach(o=>{let a=idb.generateFavoriteId(o.item_id,o.item_name,o.shop_name);o.isFavorite=c.has(a),o.favoriteData=c.get(a)}),I(),document.getElementById("loadingMessage").style.display="none",document.getElementById("mainContent").style.display="block",f();let n=document.getElementById("bestsellers-tab");n&&n.classList.contains("active")&&K()}catch(s){console.error("Error loading product analytics:",s),T()}}function j(s){let t=[],c=0;return Object.entries(s).forEach(([e,n])=>{if(!n||typeof n!="object"||e.includes("report_")||e.includes("validation_")||e.includes("payment_"))return;let o=[];if(n.orders&&Array.isArray(n.orders)&&n.orders.length>0)o=n.orders;else if(n.list&&Array.isArray(n.list))o=n.list.flatMap(a=>a.orders&&Array.isArray(a.orders)?a.orders:[]);else if(n.items&&Array.isArray(n.items)&&n.items.length>0)o=[n];else if(n.checkout_id&&!n.orders)return;o.length!==0&&o.forEach(a=>{if(!a||typeof a!="object")return;let r=a.items;!r||!Array.isArray(r)||r.length===0||r.forEach(i=>{if(!i||typeof i!="object")return;let u=n.purchase_time||a.purchase_time,g=u?u>9466848e5?u:u*1e3:null,b=n.referrer||a.referrer||i.referrer||n.internal_source||a.internal_source||"",v=b;b.includes("Shopeevideo")?v="Shopeevideo":b.includes("Shopeelive")&&(v="Shopeelive");let p=n.utm_content||a.utm_content||"",D=n.click_id||a.click_id||"",E="",k="",C="",x="",A="";if(p)if(p.includes("-")){let h=p.split("-");E=h[0]||"",k=h[1]||"",C=h[2]||"",x=h[3]||"",A=h[4]||""}else E=p,k=D;let S=i.actual_amount?i.actual_amount>1e3?parseFloat(i.actual_amount)/1e5:parseFloat(i.actual_amount):0,H=(i.item_commission?i.item_commission>1e3?parseFloat(i.item_commission)/1e5:parseFloat(i.item_commission):0)+(i.capped_brand_commission?i.capped_brand_commission>1e3?parseFloat(i.capped_brand_commission)/1e5:parseFloat(i.capped_brand_commission):0),L=i.image||i.img_code||i.image_url||"",M=L?`https://cf.shopee.vn/file/${L}`:"";t.push({id:c++,order_id:a.order_sn||a.order_id||"",checkout_id:n.checkout_id||"",purchase_time_ts:g,shop_name:i.shop_name||"",shop_id:String(i.shop_id||""),item_id:String(i.item_id||""),item_name:i.item_name||"",l1_category:i.global_category_lv1_name||"",l2_category:i.global_category_lv2_name||"",l3_category:i.global_category_lv3_name||"",actual_order_value:S,order_value:S,total_product_commission:H,shopee_commission_amount:i.item_commission?i.item_commission>1e3?parseFloat(i.item_commission)/1e5:parseFloat(i.item_commission):0,xtra_commission_amount:i.capped_brand_commission?i.capped_brand_commission>1e3?parseFloat(i.capped_brand_commission)/1e5:parseFloat(i.capped_brand_commission):0,channel:v,item_image:M,sub_id1:E,sub_id2:k,sub_id3:C,sub_id4:x,sub_id5:A})})})}),t}function V(){I(),f(),d&&F()}function q(){I(),f(),d&&F()}function I(){let s=document.getElementById("searchInput").value;m=window.productAnalytics.filterProducts(_,s);let t=document.getElementById("sortSelect").value,[c,e]=t.split("_");m=window.productAnalytics.sortProducts(m,c,e)}function N(s){P=s,document.querySelectorAll(".criteria-btn").forEach(c=>{c.classList.remove("active","btn-outline-secondary"),c.classList.add("btn-outline-secondary")});let t=document.getElementById(`criteria-${s}`);t&&(t.classList.remove("btn-outline-secondary"),t.classList.add("active")),f()}function f(){let s=document.getElementById("hotProductsContainer"),t=document.getElementById("hotProductsNoData");if(!s)return;let c=window.productAnalytics.getHotProducts(m,P,10);if(c.length===0){s.innerHTML="",t&&(t.style.display="block");return}t&&(t.style.display="none"),s.innerHTML=c.map(e=>{let n=e.isFavorite?"active":"",o=e.isFavorite?"\u2B50":"\u2606",a=e.item_image||"",r=JSON.stringify({item_id:e.item_id||"",item_name:e.item_name||"",shop_name:e.shop_name||""}),i=encodeURIComponent(r);return`
                <div class="product-card d-flex">
                    ${a?`<img src="${l(a)}" alt="${l(e.item_name||"")}" class="product-card-image" data-product-image="true" />`:""}
                    <div class="product-image-placeholder" style="display: ${a?"none":"flex"}; width: 80px; height: 80px; background-color: #f0f0f0; border-radius: 4px; align-items: center; justify-content: center; margin-right: 15px; color: #999; font-size: 0.75rem; text-align: center;">
                        \u{1F4E6}<br>No Image
                    </div>
                    <div class="product-card-content">
                        <div class="product-card-title">${l(e.item_name||"Kh\xF4ng c\xF3 t\xEAn")}</div>
                        <div class="product-card-shop">${l(e.shop_name||"Kh\xF4ng r\xF5 shop")}</div>
                        <div class="product-card-stats">
                            <div class="product-card-stat">
                                <div class="product-card-stat-label">\u0110\xE3 b\xE1n</div>
                                <div class="product-card-stat-value">${e.sold||0}</div>
                            </div>
                            <div class="product-card-stat">
                                <div class="product-card-stat-label">Clicks</div>
                                <div class="product-card-stat-value">${e.clicks||0}</div>
                            </div>
                            <div class="product-card-stat">
                                <div class="product-card-stat-label">Hoa h\u1ED3ng</div>
                                <div class="product-card-stat-value">${y(e.commission||0)}</div>
                            </div>
                            <div class="product-card-stat">
                                <div class="product-card-stat-label">EPC</div>
                                <div class="product-card-stat-value">${y(e.epc||0)}</div>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex flex-column justify-content-between">
                        <button 
                            class="favorite-btn ${n}" 
                            data-favorite-btn="true"
                            data-product-key="${i}"
                            title="${e.isFavorite?"B\u1ECF y\xEAu th\xEDch":"Th\xEAm y\xEAu th\xEDch"}"
                        >
                            ${o}
                        </button>
                        ${e.product_link?`<a href="${e.product_link}" target="_blank" class="btn btn-sm btn-outline-primary action-btn mt-2">\u{1F517}</a>`:""}
                        ${e.item_id||e.item_name?`<a href="product-detail.html?item_id=${encodeURIComponent(e.item_id||"")}&name=${encodeURIComponent(e.item_name||"")}&shop=${encodeURIComponent(e.shop_name||"")}" class="btn btn-sm btn-info action-btn mt-2">\u{1F50D}</a>`:""}
                    </div>
                </div>
            `}).join(""),s.querySelectorAll('img[data-product-image="true"]').forEach(e=>{e.addEventListener("error",function(){this.style.display="none";let n=this.nextElementSibling;n&&n.classList.contains("product-image-placeholder")&&(n.style.display="flex")},{once:!0})})}function K(){d&&d.destroy();let s=document.getElementById("productsTable");s&&(d=$(s).DataTable({data:m,columns:[{data:null,render:(t,c,e)=>{let n=e.item_image||"";return`
                        <div class="d-flex align-items-center">
                            ${n?`<img src="${l(n)}" alt="${l(e.item_name||"")}" class="product-image-small me-2" data-product-image="true" />`:""}
                            <div class="product-image-placeholder" style="display: ${n?"none":"flex"}; width: 50px; height: 50px; background-color: #f0f0f0; border-radius: 4px; align-items: center; justify-content: center; margin-right: 8px; color: #999; font-size: 0.7rem; text-align: center;">
                                \u{1F4E6}
                            </div>
                            <div>
                                <strong>${l(e.item_name||"Kh\xF4ng c\xF3 t\xEAn")}</strong>
                                ${e.item_id?`<br><small class="text-muted">ID: ${l(e.item_id)}</small>`:""}
                            </div>
                        </div>
                    `}},{data:"shop_name",render:t=>l(t||"-")},{data:"category",render:t=>l(t||"-")},{data:"sold",render:t=>(t||0).toLocaleString("vi-VN")},{data:"clicks",render:t=>(t||0).toLocaleString("vi-VN")},{data:"commission",render:t=>y(t||0)},{data:"epc",render:t=>!t||t===0?"-":y(t)},{data:null,orderable:!1,render:(t,c,e)=>{let n=e.isFavorite?"active":"",o=e.isFavorite?"\u2B50":"\u2606",a=JSON.stringify({item_id:e.item_id||"",item_name:e.item_name||"",shop_name:e.shop_name||""}),r=encodeURIComponent(a);return`
                        <div class="action-buttons">
                            <button 
                                class="favorite-btn ${n} action-btn" 
                                data-favorite-btn="true"
                                data-product-key="${r}"
                                title="${e.isFavorite?"B\u1ECF y\xEAu th\xEDch":"Th\xEAm y\xEAu th\xEDch"}"
                            >
                                ${o}
                            </button>
                            ${e.item_id||e.item_name?`<a href="product-detail.html?item_id=${encodeURIComponent(e.item_id||"")}&name=${encodeURIComponent(e.item_name||"")}&shop=${encodeURIComponent(e.shop_name||"")}" class="btn btn-sm btn-info action-btn" title="Xem chi ti\u1EBFt">\u{1F50D}</a>`:""}
                        </div>
                    `}}],order:[[5,"desc"]],pageLength:15,language:{emptyTable:"Kh\xF4ng c\xF3 d\u1EEF li\u1EC7u",info:"Hi\u1EC3n th\u1ECB _START_ \u0111\u1EBFn _END_ trong t\u1ED5ng s\u1ED1 _TOTAL_ m\u1EE5c",infoEmpty:"Hi\u1EC3n th\u1ECB 0 \u0111\u1EBFn 0 trong t\u1ED5ng s\u1ED1 0 m\u1EE5c",infoFiltered:"(\u0111\xE3 l\u1ECDc t\u1EEB _MAX_ m\u1EE5c)",lengthMenu:"Hi\u1EC3n th\u1ECB _MENU_ m\u1EE5c",loadingRecords:"\u0110ang t\u1EA3i...",processing:"\u0110ang x\u1EED l\xFD...",search:"T\xECm ki\u1EBFm:",zeroRecords:"Kh\xF4ng t\xECm th\u1EA5y k\u1EBFt qu\u1EA3",paginate:{first:"\u0110\u1EA7u",last:"Cu\u1ED1i",next:"Sau",previous:"Tr\u01B0\u1EDBc"}},drawCallback:function(){let t=$(s).closest(".table-responsive");t.find('img[data-product-image="true"]').each(function(){let c=this;c.hasAttribute("data-error-handler")||(c.setAttribute("data-error-handler","true"),c.addEventListener("error",function(){this.style.display="none";let e=this.nextElementSibling;e&&e.classList.contains("product-image-placeholder")&&(e.style.display="flex")}))}),t.find('button[data-favorite-btn="true"]').each(function(){let c=this;c.hasAttribute("data-click-handler")||(c.setAttribute("data-click-handler","true"),c.addEventListener("click",function(){try{let e=this.getAttribute("data-product-key");if(e){let n=decodeURIComponent(e),o=JSON.parse(n);R(o.item_id,o.item_name,o.shop_name)}}catch(e){console.error("Error parsing product key:",e)}}))})}}))}function F(){d&&(d.clear(),d.rows.add(m),d.draw())}async function R(s,t,c){try{if(await idb.getFavorite(s,t,c))await idb.deleteFavorite(s,t,c),_.forEach(n=>{let o=idb.generateFavoriteId(n.item_id,n.item_name,n.shop_name),a=idb.generateFavoriteId(s,t,c);o===a&&(n.isFavorite=!1,n.favoriteData=null)});else{let n=_.find(o=>{let a=idb.generateFavoriteId(o.item_id,o.item_name,o.shop_name),r=idb.generateFavoriteId(s,t,c);return a===r});n&&(await idb.saveFavorite({item_id:s,item_name:t,shop_name:c,shop_id:n.shop_id||"",category:n.category||"",product_link:n.product_link||""}),_.forEach(o=>{let a=idb.generateFavoriteId(o.item_id,o.item_name,o.shop_name),r=idb.generateFavoriteId(s,t,c);a===r&&(o.isFavorite=!0,o.favoriteData={item_id:s,item_name:t,shop_name:c})}))}f(),d&&F()}catch(e){console.error("Error toggling favorite:",e),alert("C\xF3 l\u1ED7i x\u1EA3y ra khi c\u1EADp nh\u1EADt y\xEAu th\xEDch")}}function z(){if(m.length===0){alert("Kh\xF4ng c\xF3 d\u1EEF li\u1EC7u \u0111\u1EC3 xu\u1EA5t");return}let s=["S\u1EA3n ph\u1EA9m","Shop","Danh m\u1EE5c","\u0110\xE3 b\xE1n","Clicks","Hoa h\u1ED3ng","EPC","Item ID","Link"],t=m.map(i=>[`"${(i.item_name||"").replace(/"/g,'""')}"`,`"${(i.shop_name||"").replace(/"/g,'""')}"`,`"${(i.category||"").replace(/"/g,'""')}"`,i.sold||0,i.clicks||0,i.commission||0,i.epc||0,i.item_id||"",i.product_link||""].join(",")),c=["","Gi\u1EA3i th\xEDch:","- EPC = Hoa h\u1ED3ng / Clicks (Earnings Per Click)","- Clicks = S\u1ED1 l\u1EA7n click v\xE0o link s\u1EA3n ph\u1EA9m","- Hoa h\u1ED3ng = T\u1ED5ng commission t\u1EEB c\xE1c \u0111\u01A1n h\xE0ng"],e=[s.join(","),...t,...c].join(`
`),n="\uFEFF",o=new Blob([n+e],{type:"text/csv;charset=utf-8;"}),a=document.createElement("a"),r=URL.createObjectURL(o);a.setAttribute("href",r),a.setAttribute("download",`product-analytics-${new Date().toISOString().split("T")[0]}.csv`),a.style.visibility="hidden",document.body.appendChild(a),a.click(),document.body.removeChild(a)}function T(){document.getElementById("loadingMessage").style.display="none",document.getElementById("mainContent").style.display="none";let s=document.getElementById("noDataMessage");s&&(s.style.display="block");let t=document.getElementById("noFilterResultsMessage");t&&(t.style.display="none")}})();
