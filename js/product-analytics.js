(()=>{function b(e,o,s){if(e&&String(e).trim()!=="")return`item_${String(e).trim()}`;let c=(o||"").trim().toLowerCase(),i=(s||"").trim().toLowerCase();return`name_shop_${c}_${i}`}function p(e){let o={};return e.forEach(s=>{let c=s.item_id||"",i=s.item_name||"",a=s.shop_name||"",n=b(c,i,a);o[n]?!o[n].item_image&&s.item_image&&(o[n].item_image=s.item_image):o[n]={item_id:c,item_name:i,shop_name:a,shop_id:s.shop_id||"",category:s.l1_category||s.l2_category||s.l3_category||"",item_image:s.item_image||"",orders:[],orderIds:new Set};let t=s.order_id||"";t&&!o[n].orderIds.has(t)&&(o[n].orderIds.add(t),o[n].orders.push(s))}),o}function y(e){if(!e||e.trim()==="")return{sub_id1:"",sub_id2:"",sub_id3:"",sub_id4:"",sub_id5:""};let o=e.split("-");return{sub_id1:o[0]||"",sub_id2:o[1]||"",sub_id3:o[2]||"",sub_id4:o[3]||"",sub_id5:o[4]||""}}function g(e,o,s=[]){let c=Object.values(o),i={},a={};c.forEach(t=>{let m=t.data||t,_=m.sub_id||"";if(_&&_.trim()!==""){i[_]||(i[_]=[]),i[_].push(m);let u=y(_);for(let d=1;d<=5;d++){let r=`sub_id${d}`,l=u[r];if(l&&l.trim()!==""){let f=`${r}:${l}`;a[f]||(a[f]=[]),a[f].push(m)}}}});let n={};return s.forEach(t=>{let m=[],_=t.sub_id1&&t.sub_id2&&t.sub_id3&&t.sub_id4&&t.sub_id5?`${t.sub_id1}-${t.sub_id2}-${t.sub_id3}-${t.sub_id4}-${t.sub_id5}`:t.sub_id1||"";if(_&&i[_])m=i[_];else for(let u=1;u<=5;u++){let d=`sub_id${u}`,r=t[d];if(r&&r.trim()!==""){let l=`${d}:${r}`;if(a[l]&&a[l].length>0){m=a[l];break}}}if(m.length>0){let u=b(t.item_id,t.item_name,t.shop_name);n[u]||(n[u]=new Set),m.forEach(d=>{let r=d.click_id||"";r&&n[u].add(r)})}}),Object.keys(e).forEach(t=>{let m=e[t],_=n[t]?n[t].size:0;m.clicks=_}),e}function k(e){let o=e.orders||[],s=e.item_id||"",c=0,i=0,a=0,n=new Set;o.forEach(u=>{let d=u.order_id||"";if(d&&!n.has(d)){n.add(d),c++;let r=u.total_product_commission||(u.shopee_commission_amount||0)+(u.xtra_commission_amount||0);i+=r||0;let l=u.actual_order_value||u.order_value||0;a+=l||0}});let t=e.clicks||0,m=t>0?i/t:0,_=s&&e.shop_id?`https://shopee.vn/product/${e.shop_id}/${s}`:"";return{item_id:s,item_name:e.item_name||"",shop_name:e.shop_name||"",shop_id:e.shop_id||"",category:e.category||"",item_image:e.item_image||"",sold:c,commission:i,clicks:t,epc:m,gmv:a,product_link:_,orders:o}}function I(e,o){let s=p(e),c=g(s,o,e);return Object.values(c).map(a=>k(a))}function h(e){return e?e.normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/đ/g,"d").replace(/Đ/g,"D").toLowerCase():""}function S(e,o){if(!o||o.trim()==="")return e;let s=h(o.trim());return e.filter(c=>{let i=h(c.item_name||"").includes(s),a=h(c.shop_name||"").includes(s),n=h(c.category||"").includes(s),t=(c.item_id||"").toLowerCase().includes(s.toLowerCase());return i||a||n||t})}function v(e,o="commission",s="desc"){let c=[...e];return c.sort((i,a)=>{let n=i[o]||0,t=a[o]||0;return s==="asc"?n-t:t-n}),c}function w(e,o="commission",s=10){return v(e,o,"desc").slice(0,s)}function D(e){let o=e.orders||[],s={byDate:{},byChannel:{video:{orders:0,commission:0},live:{orders:0,commission:0},social:{orders:0,commission:0},other:{orders:0,commission:0}},dailyData:[]},c=new Set;return o.forEach(i=>{let a=i.order_id||"";if(!a||c.has(a))return;c.add(a);let n=i.purchase_time_ts||null;if(n){let d=new Date(n).toISOString().split("T")[0];s.byDate[d]||(s.byDate[d]={orders:0,commission:0,gmv:0}),s.byDate[d].orders++;let r=i.total_product_commission||(i.shopee_commission_amount||0)+(i.xtra_commission_amount||0);s.byDate[d].commission+=r||0;let l=i.actual_order_value||i.order_value||0;s.byDate[d].gmv+=l||0}let t=i.channel||"",m="other";t.includes("Shopeevideo")||t.includes("Shopeevideo-Shopee")?m="video":t.includes("Shopeelive")||t.includes("Shopeelive-Shopee")?m="live":t&&t.trim()!==""&&(m="social"),s.byChannel[m].orders++;let _=i.total_product_commission||(i.shopee_commission_amount||0)+(i.xtra_commission_amount||0);s.byChannel[m].commission+=_||0}),Object.keys(s.byDate).sort().forEach(i=>{s.dailyData.push({date:i,orders:s.byDate[i].orders,commission:s.byDate[i].commission,gmv:s.byDate[i].gmv})}),s}typeof window<"u"&&(window.productAnalytics={groupProductsByItemId:p,matchClicksToProducts:g,calculateProductStats:k,processProductAnalytics:I,filterProducts:S,sortProducts:v,getHotProducts:w,getProductBreakdown:D,generateProductKey:b,parseSubId:y});})();
