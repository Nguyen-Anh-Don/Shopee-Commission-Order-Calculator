(()=>{var T="shopeeExtensionDB";var k=null,m=null,D=null;async function b(){if(D)return D;try{if(typeof chrome<"u"&&chrome.storage&&chrome.storage.local){let e=await chrome.storage.local.get("currentAffiliateId");if(e&&e.currentAffiliateId)return D=e.currentAffiliateId,e.currentAffiliateId}}catch(e){typeof console<"u"&&console.warn&&console.warn("Cannot access chrome.storage:",e)}return null}async function S(e){if(e){D=e;try{await chrome.storage.local.set({currentAffiliateId:e})}catch(t){typeof console<"u"&&console.warn&&console.warn("Cannot save affiliate_id to chrome.storage:",t)}}}function u(){return typeof indexedDB>"u"||!indexedDB?Promise.reject(new Error("IndexedDB is not available in this context")):m||(m=new Promise((e,t)=>{if(k)try{let i=k.objectStoreNames;if(i&&i.length>0){let a=m;m=null,e(k);return}}catch(i){typeof console<"u"&&console.warn&&console.warn("Database connection lost, reopening...",i),k=null}try{let i=indexedDB.open(T,3);i.onerror=()=>{let a=i.error||new Error("Unknown IndexedDB error");typeof console<"u"&&console.error&&console.error("IndexedDB open error:",a);let r=m;m=null,t(a)},i.onsuccess=()=>{try{if(k=i.result,!k){let r=m;m=null,t(new Error("Database result is null"));return}if(!k.objectStoreNames){let r=m;m=null,t(new Error("Database objectStoreNames is not available"));return}k.onclose=()=>{typeof console<"u"&&console.warn&&console.warn("Database connection closed"),k=null,m=null},k.onerror=r=>{typeof console<"u"&&console.error&&console.error("Database error:",r)};let a=m;m=null,e(k)}catch(a){let r=m;m=null,t(new Error("Error initializing database: "+(a.message||a)))}},i.onupgradeneeded=a=>{try{let r=a.target.result;if(!r){typeof console<"u"&&console.error&&console.error("Database upgrade: database result is null");return}let l=a.oldVersion||0;if(typeof console<"u"&&console.log&&console.log(`Upgrading database from version ${l} to 3`),l<3&&l>0){typeof console<"u"&&console.log&&console.log("Database version c\u0169 < 3, \u0111ang x\xF3a t\u1EA5t c\u1EA3 d\u1EEF li\u1EC7u c\u0169 v\xE0 t\u1EA1o l\u1EA1i v\u1EDBi affiliate_id support..."),Array.from(r.objectStoreNames).forEach(o=>{try{r.deleteObjectStore(o),typeof console<"u"&&console.log&&console.log(`\u0110\xE3 x\xF3a object store: ${o}`)}catch(s){typeof console<"u"&&console.warn&&console.warn(`Kh\xF4ng th\u1EC3 x\xF3a object store ${o}:`,s)}});try{if(typeof chrome<"u"&&chrome.storage&&chrome.storage.local){let o=["clickHistory","orderHistory"];chrome.storage.local.remove(o,()=>{chrome.runtime.lastError?console.warn("L\u1ED7i khi x\xF3a d\u1EEF li\u1EC7u c\u0169 t\u1EEB chrome.storage.local:",chrome.runtime.lastError):typeof console<"u"&&console.log&&console.log("\u0110\xE3 x\xF3a d\u1EEF li\u1EC7u c\u0169 t\u1EEB chrome.storage.local:",o)})}}catch(o){typeof console<"u"&&console.warn&&console.warn("Kh\xF4ng th\u1EC3 x\xF3a d\u1EEF li\u1EC7u t\u1EEB chrome.storage.local:",o)}}if(!r.objectStoreNames.contains("orders")){let n=r.createObjectStore("orders",{keyPath:"key"});n.createIndex("purchase_time","purchase_time",{unique:!1}),n.createIndex("checkout_id","checkout_id",{unique:!1}),n.createIndex("order_id","order_id",{unique:!1}),n.createIndex("affiliate_id","affiliate_id",{unique:!1})}if(!r.objectStoreNames.contains("clicks")){let n=r.createObjectStore("clicks",{keyPath:"key"});n.createIndex("click_time","click_time",{unique:!1}),n.createIndex("click_id","click_id",{unique:!1}),n.createIndex("affiliate_id","affiliate_id",{unique:!1})}if(!r.objectStoreNames.contains("affiliateLinks")){let n=r.createObjectStore("affiliateLinks",{keyPath:"id",autoIncrement:!0});n.createIndex("timestamp","timestamp",{unique:!1}),n.createIndex("affiliate_id","affiliate_id",{unique:!1})}if(!r.objectStoreNames.contains("favorites")){let n=r.createObjectStore("favorites",{keyPath:"id"});n.createIndex("item_id","item_id",{unique:!1}),n.createIndex("created_at","created_at",{unique:!1}),n.createIndex("affiliate_id","affiliate_id",{unique:!1})}}catch(r){typeof console<"u"&&console.error&&console.error("Error during database upgrade:",r)}},i.onblocked=()=>{typeof console<"u"&&console.warn&&console.warn("IndexedDB upgrade blocked - close other tabs using this database")}}catch(i){let a=m;m=null,t(new Error("Failed to open IndexedDB: "+(i.message||i)))}}),m)}async function F(e,t){let i=await u();if(!i)return Promise.reject(new Error("Database connection failed"));let a=await b()||t.affiliate_id||null;return t.affiliate_id&&t.affiliate_id!==a&&await S(t.affiliate_id),new Promise((r,l)=>{var d,f;if(!i||!i.objectStoreNames){l(new Error("Database connection is invalid"));return}let o=i.transaction(["orders"],"readwrite").objectStore("orders"),s={key:e,data:t,affiliate_id:t.affiliate_id||a,purchase_time:t.purchase_time||t.checkout_complete_time||0,checkout_id:t.checkout_id||"",order_id:((f=(d=t.orders)==null?void 0:d[0])==null?void 0:f.order_id)||""},c=o.put(s);c.onsuccess=()=>r(),c.onerror=()=>l(c.error)})}async function R(e){let t=await u(),i=await b();if(!i){let o=Object.values(e)[0];o!=null&&o.affiliate_id&&(i=o.affiliate_id,await S(i))}let a=Object.entries(e);if(a.length===0)return Promise.resolve();let l=1e3,n=[];for(let o=0;o<a.length;o+=l)n.push(a.slice(o,o+l));for(let o of n)await new Promise((s,c)=>{if(!t||!t.objectStoreNames){c(new Error("Database connection is invalid"));return}let f=t.transaction(["orders"],"readwrite").objectStore("orders"),g=0,_=!1;o.forEach(([I,w])=>{var L,O;let p=w.affiliate_id||i;p&&p!==i&&(S(p).catch(()=>{}),i=p);let N={key:I,data:w,affiliate_id:p,purchase_time:w.purchase_time||w.checkout_complete_time||0,checkout_id:w.checkout_id||"",order_id:((O=(L=w.orders)==null?void 0:L[0])==null?void 0:O.order_id)||""},E=f.put(N);E.onsuccess=()=>{g++,g===o.length&&!_&&s()},E.onerror=()=>{_||(_=!0,c(E.error))}})})}async function $(e){let t=await u();return t?new Promise((i,a)=>{if(!t||!t.objectStoreNames){a(new Error("Database connection is invalid"));return}let n=t.transaction(["orders"],"readonly").objectStore("orders").get(e);n.onsuccess=()=>{i(n.result?n.result.data:null)},n.onerror=()=>a(n.error)}):Promise.reject(new Error("Database connection failed"))}async function H(){let e=await u();if(!e)return Promise.reject(new Error("Database connection failed"));let t=await b();return new Promise((i,a)=>{if(!e||!e.objectStoreNames){a(new Error("Database connection is invalid"));return}let l=e.transaction(["orders"],"readonly").objectStore("orders");if(t&&l.indexNames.contains("affiliate_id")){let o=l.index("affiliate_id").getAll(t);o.onsuccess=()=>{let s={};o.result.forEach(c=>{s[c.key]=c.data}),i(s)},o.onerror=()=>a(o.error)}else{let n=l.getAll();n.onsuccess=()=>{let o={};n.result.forEach(s=>{(!t||s.affiliate_id===t)&&(o[s.key]=s.data)}),i(o)},n.onerror=()=>a(n.error)}})}async function V(e){let t=await u();return t?new Promise((i,a)=>{if(!t||!t.objectStoreNames){a(new Error("Database connection is invalid"));return}let n=t.transaction(["orders"],"readwrite").objectStore("orders").delete(e);n.onsuccess=()=>i(),n.onerror=()=>a(n.error)}):Promise.reject(new Error("Database connection failed"))}async function K(){let e;try{e=await u()}catch(i){return Promise.reject(new Error("Kh\xF4ng th\u1EC3 m\u1EDF database: "+i.message))}if(!e||e.objectStoreNames.length===0)return Promise.reject(new Error("Database connection kh\xF4ng h\u1EE3p l\u1EC7"));let t=await b();return new Promise((i,a)=>{if(!e||!e.objectStoreNames){a(new Error("Database connection is invalid"));return}let r;try{r=e.transaction(["orders"],"readwrite")}catch(n){a(new Error("Kh\xF4ng th\u1EC3 t\u1EA1o transaction: "+n.message));return}let l=r.objectStore("orders");if(r.oncomplete=()=>{},r.onerror=n=>{console.error("Transaction error:",n),a(n.target.error||new Error("Transaction failed"))},r.onabort=()=>{a(new Error("Transaction b\u1ECB h\u1EE7y"))},!t){let n=l.clear();n.onsuccess=()=>{typeof console<"u"&&console.log&&console.log("\u0110\xE3 x\xF3a t\u1EA5t c\u1EA3 orders (kh\xF4ng c\xF3 affiliate_id filter)"),i()},n.onerror=()=>a(n.error);return}if(l.indexNames.contains("affiliate_id")){let o=l.index("affiliate_id").openCursor(IDBKeyRange.only(t)),s=0,c=!1;o.onsuccess=d=>{if(r.readyState!=="active"){c||(c=!0,a(new Error("Transaction \u0111\xE3 b\u1ECB \u0111\xF3ng tr\u01B0\u1EDBc khi ho\xE0n th\xE0nh")));return}let f=d.target.result;if(f)try{f.delete(),s++,f.continue()}catch(g){c||(c=!0,a(new Error("L\u1ED7i khi x\xF3a record: "+g.message)))}else c||(c=!0,typeof console<"u"&&console.log&&console.log(`\u0110\xE3 x\xF3a ${s} orders c\u1EE7a affiliate_id: ${t}`),i())},o.onerror=d=>{c||(c=!0,console.error("L\u1ED7i khi x\xF3a orders theo affiliate_id:",o.error),a(o.error||new Error("Cursor error")))}}else{let n=l.getAll();n.onsuccess=()=>{let o=n.result.filter(d=>d.affiliate_id===t);if(o.length===0){i();return}let s=0,c=!1;o.forEach(d=>{let f=l.delete(d.key);f.onsuccess=()=>{s++,s===o.length&&!c&&(typeof console<"u"&&console.log&&console.log(`\u0110\xE3 x\xF3a ${s} orders c\u1EE7a affiliate_id: ${t}`),i())},f.onerror=()=>{c||(c=!0,a(f.error))}})},n.onerror=()=>a(n.error)}})}async function M(e,t){let i=await u();if(!i)return Promise.reject(new Error("Database connection failed"));let a=await b()||t.affiliate_id||null;return t.affiliate_id&&t.affiliate_id!==a&&await S(t.affiliate_id),new Promise((r,l)=>{if(!i||!i.objectStoreNames){l(new Error("Database connection is invalid"));return}let o=i.transaction(["clicks"],"readwrite").objectStore("clicks"),s={key:e,data:t,affiliate_id:t.affiliate_id||a,click_time:t.click_time||0,click_id:t.click_id||""},c=o.put(s);c.onsuccess=()=>r(),c.onerror=()=>l(c.error)})}async function U(e){let t=await u();if(!t)return Promise.reject(new Error("Database connection failed"));let i=await b();if(!i){let o=Object.values(e)[0];o!=null&&o.affiliate_id&&(i=o.affiliate_id,await S(i))}let a=Object.entries(e);if(a.length===0)return Promise.resolve();let l=1e3,n=[];for(let o=0;o<a.length;o+=l)n.push(a.slice(o,o+l));for(let o of n)await new Promise((s,c)=>{if(!t||!t.objectStoreNames){c(new Error("Database connection is invalid"));return}let f=t.transaction(["clicks"],"readwrite").objectStore("clicks"),g=0,_=!1;o.forEach(([I,w])=>{let p=w.affiliate_id||i;p&&p!==i&&(S(p).catch(()=>{}),i=p);let N={key:I,data:w,affiliate_id:p,click_time:w.click_time||0,click_id:w.click_id||""},E=f.put(N);E.onsuccess=()=>{g++,g===o.length&&!_&&s()},E.onerror=()=>{_||(_=!0,c(E.error))}})})}async function Z(e){let t=await u();return t?new Promise((i,a)=>{if(!t||!t.objectStoreNames){a(new Error("Database connection is invalid"));return}let n=t.transaction(["clicks"],"readonly").objectStore("clicks").get(e);n.onsuccess=()=>{i(n.result?n.result.data:null)},n.onerror=()=>a(n.error)}):Promise.reject(new Error("Database connection failed"))}async function z(){let e=await u(),t=await b();return new Promise((i,a)=>{let l=e.transaction(["clicks"],"readonly").objectStore("clicks");if(t&&l.indexNames.contains("affiliate_id")){let o=l.index("affiliate_id").getAll(t);o.onsuccess=()=>{let s={};o.result.forEach(c=>{s[c.key]=c.data}),i(s)},o.onerror=()=>a(o.error)}else{let n=l.getAll();n.onsuccess=()=>{let o={};n.result.forEach(s=>{(!t||s.affiliate_id===t)&&(o[s.key]=s.data)}),i(o)},n.onerror=()=>a(n.error)}})}async function G(e){let t=await u();return t?new Promise((i,a)=>{if(!t||!t.objectStoreNames){a(new Error("Database connection is invalid"));return}let n=t.transaction(["clicks"],"readwrite").objectStore("clicks").delete(e);n.onsuccess=()=>i(),n.onerror=()=>a(n.error)}):Promise.reject(new Error("Database connection failed"))}async function W(){let e;try{e=await u()}catch(i){return Promise.reject(new Error("Kh\xF4ng th\u1EC3 m\u1EDF database: "+i.message))}if(!e||e.objectStoreNames.length===0)return Promise.reject(new Error("Database connection kh\xF4ng h\u1EE3p l\u1EC7"));let t=await b();return new Promise((i,a)=>{if(!e||!e.objectStoreNames){a(new Error("Database connection is invalid"));return}let r;try{r=e.transaction(["clicks"],"readwrite")}catch(n){a(new Error("Kh\xF4ng th\u1EC3 t\u1EA1o transaction: "+n.message));return}let l=r.objectStore("clicks");if(r.oncomplete=()=>{},r.onerror=n=>{console.error("Transaction error:",n),a(n.target.error||new Error("Transaction failed"))},r.onabort=()=>{a(new Error("Transaction b\u1ECB h\u1EE7y"))},!t){let n=l.clear();n.onsuccess=()=>{typeof console<"u"&&console.log&&console.log("\u0110\xE3 x\xF3a t\u1EA5t c\u1EA3 clicks (kh\xF4ng c\xF3 affiliate_id filter)"),i()},n.onerror=()=>a(n.error);return}if(l.indexNames.contains("affiliate_id")){let o=l.index("affiliate_id").openCursor(IDBKeyRange.only(t)),s=0,c=!1;o.onsuccess=d=>{if(r.readyState!=="active"){c||(c=!0,a(new Error("Transaction \u0111\xE3 b\u1ECB \u0111\xF3ng tr\u01B0\u1EDBc khi ho\xE0n th\xE0nh")));return}let f=d.target.result;if(f)try{f.delete(),s++,f.continue()}catch(g){c||(c=!0,a(new Error("L\u1ED7i khi x\xF3a record: "+g.message)))}else c||(c=!0,typeof console<"u"&&console.log&&console.log(`\u0110\xE3 x\xF3a ${s} clicks c\u1EE7a affiliate_id: ${t}`),i())},o.onerror=d=>{c||(c=!0,console.error("L\u1ED7i khi x\xF3a clicks theo affiliate_id:",o.error),a(o.error||new Error("Cursor error")))}}else{let n=l.getAll();n.onsuccess=()=>{let o=n.result.filter(d=>d.affiliate_id===t);if(o.length===0){i();return}let s=0,c=!1;o.forEach(d=>{let f=l.delete(d.key);f.onsuccess=()=>{s++,s===o.length&&!c&&(typeof console<"u"&&console.log&&console.log(`\u0110\xE3 x\xF3a ${s} clicks c\u1EE7a affiliate_id: ${t}`),i())},f.onerror=()=>{c||(c=!0,a(f.error))}})},n.onerror=()=>a(n.error)}})}async function J(e){let t=await u(),i=await b();return new Promise((a,r)=>{let n=t.transaction(["affiliateLinks"],"readwrite").objectStore("affiliateLinks"),o={...e,affiliate_id:i,timestamp:e.timestamp||Date.now()},s=n.add(o);s.onsuccess=()=>a(s.result),s.onerror=()=>r(s.error)})}async function Q(){let e=await u();if(!e)return Promise.reject(new Error("Database connection failed"));let t=await b();return new Promise((i,a)=>{if(!e||!e.objectStoreNames){a(new Error("Database connection is invalid"));return}let l=e.transaction(["affiliateLinks"],"readonly").objectStore("affiliateLinks");if(t&&l.indexNames.contains("affiliate_id")){let o=l.index("affiliate_id").getAll(t);o.onsuccess=()=>{let s=o.result.sort((c,d)=>(d.timestamp||0)-(c.timestamp||0)).slice(0,100).map(c=>{let{id:d,...f}=c;return f});i(s)},o.onerror=()=>a(o.error)}else{let o=l.index("timestamp").getAll();o.onsuccess=()=>{let s=o.result.filter(c=>!t||c.affiliate_id===t).sort((c,d)=>(d.timestamp||0)-(c.timestamp||0)).slice(0,100).map(c=>{let{id:d,...f}=c;return f});i(s)},o.onerror=()=>a(o.error)}})}async function X(e){let t=await u();return new Promise((i,a)=>{let n=t.transaction(["affiliateLinks"],"readwrite").objectStore("affiliateLinks").delete(e);n.onsuccess=()=>i(),n.onerror=()=>a(n.error)})}async function Y(){let e=await u();return e?new Promise((t,i)=>{if(!e||!e.objectStoreNames){i(new Error("Database connection is invalid"));return}let l=e.transaction(["affiliateLinks"],"readwrite").objectStore("affiliateLinks").clear();l.onsuccess=()=>t(),l.onerror=()=>i(l.error)}):Promise.reject(new Error("Database connection failed"))}function C(e,t,i){if(e&&String(e).trim()!=="")return`item_${String(e).trim()}`;let a=(t||"").trim().toLowerCase(),r=(i||"").trim().toLowerCase();return`name_shop_${a}_${r}`}async function ee(e){let t=await u();if(!t)return Promise.reject(new Error("Database connection failed"));let i=await b();return new Promise((a,r)=>{if(!t||!t.objectStoreNames){r(new Error("Database connection is invalid"));return}let n=t.transaction(["favorites"],"readwrite").objectStore("favorites"),o=C(e.item_id,e.item_name,e.shop_name),s={id:o,affiliate_id:i,item_id:e.item_id||"",item_name:e.item_name||"",shop_name:e.shop_name||"",shop_id:e.shop_id||"",category:e.category||"",notes:e.notes||"",tags:e.tags||[],product_link:e.product_link||"",created_at:e.created_at||Date.now(),updated_at:Date.now()},c=n.put(s);c.onsuccess=()=>a(o),c.onerror=()=>r(c.error)})}async function te(){let e=await u();if(!e)return Promise.reject(new Error("Database connection failed"));let t=await b();return new Promise((i,a)=>{if(!e||!e.objectStoreNames){a(new Error("Database connection is invalid"));return}let l=e.transaction(["favorites"],"readonly").objectStore("favorites");if(t&&l.indexNames.contains("affiliate_id")){let o=l.index("affiliate_id").getAll(t);o.onsuccess=()=>{i(o.result||[])},o.onerror=()=>a(o.error)}else{let n=l.getAll();n.onsuccess=()=>{let o=(n.result||[]).filter(s=>!t||s.affiliate_id===t);i(o)},n.onerror=()=>a(n.error)}})}async function ne(e,t,i){let a=await u();return a?new Promise((r,l)=>{if(!a||!a.objectStoreNames){l(new Error("Database connection is invalid"));return}let o=a.transaction(["favorites"],"readonly").objectStore("favorites"),s=C(e,t,i),c=o.get(s);c.onsuccess=()=>{r(c.result||null)},c.onerror=()=>l(c.error)}):Promise.reject(new Error("Database connection failed"))}async function oe(e,t,i,a){let r=await u();return r?new Promise((l,n)=>{if(!r||!r.objectStoreNames){n(new Error("Database connection is invalid"));return}let s=r.transaction(["favorites"],"readwrite").objectStore("favorites"),c=C(e,t,i),d=s.get(c);d.onsuccess=()=>{let f=d.result;if(!f){n(new Error("Favorite not found"));return}let g={...f,...a,updated_at:Date.now()},_=s.put(g);_.onsuccess=()=>l(g),_.onerror=()=>n(_.error)},d.onerror=()=>n(d.error)}):Promise.reject(new Error("Database connection failed"))}async function re(e,t,i){let a=await u();return new Promise((r,l)=>{let o=a.transaction(["favorites"],"readwrite").objectStore("favorites"),s=C(e,t,i),c=o.delete(s);c.onsuccess=()=>r(),c.onerror=()=>l(c.error)})}async function ie(){let e=await u();return e?new Promise((t,i)=>{if(!e||!e.objectStoreNames){i(new Error("Database connection is invalid"));return}let l=e.transaction(["favorites"],"readwrite").objectStore("favorites").clear();l.onsuccess=()=>t(),l.onerror=()=>i(l.error)}):Promise.reject(new Error("Database connection failed"))}var q={saveOrder:F,saveOrders:R,getOrder:$,getAllOrders:H,deleteOrder:V,clearOrders:K,saveClick:M,saveClicks:U,getClick:Z,getAllClicks:z,deleteClick:G,clearClicks:W,saveAffiliateLink:J,getAllAffiliateLinks:Q,deleteAffiliateLink:X,clearAffiliateLinks:Y,saveFavorite:ee,getAllFavorites:te,getFavorite:ne,updateFavorite:oe,deleteFavorite:re,clearFavorites:ie,generateFavoriteId:C,getCurrentAffiliateId:b,setCurrentAffiliateId:S,initDB:u},j=q;typeof window<"u"&&(window.idb=q);typeof self<"u"&&(self.idb=q);var h=null,y=null,v={};function P(e){return e==null||isNaN(e)?"0 \u20AB":new Intl.NumberFormat("vi-VN",{style:"currency",currency:"VND",minimumFractionDigits:0,maximumFractionDigits:0}).format(e)}function B(e){return e?new Date(e).toLocaleDateString("vi-VN"):""}document.addEventListener("DOMContentLoaded",function(){ae()});function x(e){let t=document.getElementById("loadingMessage");if(t){let i=t.querySelector("p");i&&(i.textContent=e)}}async function ae(){try{let e=new URLSearchParams(window.location.search),t=e.get("item_id")||"",i=decodeURIComponent(e.get("name")||""),a=decodeURIComponent(e.get("shop")||"");if(!t&&!i){A();return}x("\u0110ang t\u1EA3i d\u1EEF li\u1EC7u t\u1EEB c\u01A1 s\u1EDF d\u1EEF li\u1EC7u...");let[r,l]=await Promise.all([j.getAllOrders(),j.getAllClicks()]);if(Object.keys(r).length===0){A();return}x("\u0110ang x\u1EED l\xFD d\u1EEF li\u1EC7u \u0111\u01A1n h\xE0ng..."),await new Promise(d=>setTimeout(d,10));let n=se(r);x("\u0110ang l\u1ECDc s\u1EA3n ph\u1EA9m..."),await new Promise(d=>setTimeout(d,10));let o=n;if(t?o=n.filter(d=>String(d.item_id)===String(t)):i&&a&&(o=n.filter(d=>d.item_name===i&&d.shop_name===a)),o.length===0){A();return}x("\u0110ang ph\xE2n t\xEDch d\u1EEF li\u1EC7u s\u1EA3n ph\u1EA9m..."),await new Promise(d=>setTimeout(d,10));let s=window.productAnalytics.groupProductsByItemId(o),c=window.productAnalytics.matchClicksToProducts(s,l,o);if(x("\u0110ang t\xEDnh to\xE1n th\u1ED1ng k\xEA..."),await new Promise(d=>setTimeout(d,10)),h=Object.values(c).map(d=>window.productAnalytics.calculateProductStats(d)).find(d=>t?String(d.item_id)===String(t):d.item_name===i&&d.shop_name===a),!h){A();return}h.orders=o,x("\u0110ang t\u1EA1o bi\u1EC3u \u0111\u1ED3..."),await new Promise(d=>setTimeout(d,10)),y=window.productAnalytics.getProductBreakdown(h),ce(),le(),de(),fe(),document.getElementById("loadingMessage").style.display="none",document.getElementById("mainContent").style.display="block"}catch(e){console.error("Error loading product detail:",e),A()}}function se(e){let t=[],i=0;return Object.entries(e).forEach(([a,r])=>{if(!r||typeof r!="object"||a.includes("report_")||a.includes("validation_")||a.includes("payment_"))return;let l=[];if(r.orders&&Array.isArray(r.orders)&&r.orders.length>0)l=r.orders;else if(r.list&&Array.isArray(r.list))l=r.list.flatMap(n=>n.orders&&Array.isArray(n.orders)?n.orders:[]);else if(r.items&&Array.isArray(r.items)&&r.items.length>0)l=[r];else if(r.checkout_id&&!r.orders)return;l.length!==0&&l.forEach(n=>{if(!n||typeof n!="object")return;let o=n.items;!o||!Array.isArray(o)||o.length===0||o.forEach(s=>{if(!s||typeof s!="object")return;let c=r.purchase_time||n.purchase_time,d=c?c>9466848e5?c:c*1e3:null,f=r.referrer||n.referrer||s.referrer||r.internal_source||n.internal_source||"",g=f;f.includes("Shopeevideo")?g="Shopeevideo":f.includes("Shopeelive")&&(g="Shopeelive");let _=s.actual_amount?s.actual_amount>1e3?parseFloat(s.actual_amount)/1e5:parseFloat(s.actual_amount):0,I=(s.item_commission?s.item_commission>1e3?parseFloat(s.item_commission)/1e5:parseFloat(s.item_commission):0)+(s.capped_brand_commission?s.capped_brand_commission>1e3?parseFloat(s.capped_brand_commission)/1e5:parseFloat(s.capped_brand_commission):0);t.push({id:i++,order_id:n.order_sn||n.order_id||"",checkout_id:r.checkout_id||"",purchase_time_ts:d,shop_name:s.shop_name||"",shop_id:String(s.shop_id||""),item_id:String(s.item_id||""),item_name:s.item_name||"",l1_category:s.global_category_lv1_name||"",l2_category:s.global_category_lv2_name||"",l3_category:s.global_category_lv3_name||"",actual_order_value:_,order_value:_,total_product_commission:I,shopee_commission_amount:s.item_commission?s.item_commission>1e3?parseFloat(s.item_commission)/1e5:parseFloat(s.item_commission):0,xtra_commission_amount:s.capped_brand_commission?s.capped_brand_commission>1e3?parseFloat(s.capped_brand_commission)/1e5:parseFloat(s.capped_brand_commission):0,channel:g})})})}),t}function ce(){if(!h)return;document.getElementById("productName").textContent=h.item_name||"Kh\xF4ng c\xF3 t\xEAn",document.getElementById("shopName").textContent=h.shop_name||"-",document.getElementById("category").textContent=h.category||"-",document.getElementById("itemId").textContent=h.item_id||"-";let e=document.getElementById("productLink");h.product_link?e.href=h.product_link:e.style.display="none"}function le(){h&&(document.getElementById("totalSold").textContent=(h.sold||0).toLocaleString("vi-VN"),document.getElementById("totalClicks").textContent=(h.clicks||0).toLocaleString("vi-VN"),document.getElementById("totalCommission").textContent=P(h.commission||0),document.getElementById("totalEPC").textContent=P(h.epc||0))}function de(){if(!y)return;Object.values(v).forEach(r=>{r&&r.destroy()}),v={};let e=document.getElementById("commissionChart");e&&y.dailyData.length>0&&(v.commission=new Chart(e,{type:"line",data:{labels:y.dailyData.map(r=>B(r.date)),datasets:[{label:"Hoa h\u1ED3ng (\u20AB)",data:y.dailyData.map(r=>r.commission||0),borderColor:"#f36f21",backgroundColor:"rgba(243, 111, 33, 0.1)",tension:.1}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!0}},scales:{y:{beginAtZero:!0,ticks:{callback:function(r){return P(r)}}}}}}));let t=document.getElementById("ordersChart");t&&y.dailyData.length>0&&(v.orders=new Chart(t,{type:"bar",data:{labels:y.dailyData.map(r=>B(r.date)),datasets:[{label:"S\u1ED1 \u0111\u01A1n",data:y.dailyData.map(r=>r.orders||0),backgroundColor:"#4caf50"}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!0}},scales:{y:{beginAtZero:!0,ticks:{stepSize:1}}}}}));let i=document.getElementById("channelChart");if(i){let r=y.byChannel;v.channel=new Chart(i,{type:"pie",data:{labels:["Video","Live","Social","Kh\xE1c"],datasets:[{data:[r.video.commission||0,r.live.commission||0,r.social.commission||0,r.other.commission||0],backgroundColor:["#ff9800","#f44336","#2196f3","#9e9e9e"]}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!0,position:"bottom"},tooltip:{callbacks:{label:function(l){let n=l.label||"",o=P(l.parsed||0);return`${n}: ${o}`}}}}}})}let a=document.getElementById("channelOrdersChart");if(a){let r=y.byChannel;v.channelOrders=new Chart(a,{type:"pie",data:{labels:["Video","Live","Social","Kh\xE1c"],datasets:[{data:[r.video.orders||0,r.live.orders||0,r.social.orders||0,r.other.orders||0],backgroundColor:["#ff9800","#f44336","#2196f3","#9e9e9e"]}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!0,position:"bottom"}}}})}}function fe(){if(!y)return;let e=document.querySelector("#breakdownTable tbody");if(e){if(y.dailyData.length===0){e.innerHTML="<tr><td colspan='4' class='text-center text-muted'>Kh\xF4ng c\xF3 d\u1EEF li\u1EC7u</td></tr>";return}e.innerHTML=y.dailyData.map(t=>`
                <tr>
                    <td>${B(t.date)}</td>
                    <td>${(t.orders||0).toLocaleString("vi-VN")}</td>
                    <td>${P(t.commission||0)}</td>
                    <td>${P(t.gmv||0)}</td>
                </tr>
            `).join("")}}function A(){document.getElementById("loadingMessage").style.display="none",document.getElementById("mainContent").style.display="none";let e=document.getElementById("noDataMessage");e&&(e.style.display="block")}})();
