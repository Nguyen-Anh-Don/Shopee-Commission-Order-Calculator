(()=>{function p(t,e="VND"){return!t||isNaN(t)?"0 \u20AB":Math.round(Number(t)).toLocaleString("vi-VN")+" \u20AB"}typeof window<"u"&&(window.formatPrice=p);function h(t){try{let e=new Date(t),r=e.getDate(),n=e.getMonth()+1;return`${r}/${n}`}catch{return t}}typeof window<"u"&&(window.formatDateShort=h);function g(){try{if(window.__INITIAL_STATE__){let e=window.__INITIAL_STATE__;if(e.item)return d(e.item)}let t=document.querySelectorAll("script:not([src])");for(let e of t){let r=e.textContent||"";if(r.includes("__INITIAL_STATE__"))try{let n=r.match(/window\.__INITIAL_STATE__\s*=\s*({.+?});/s);if(n&&n[1]){let o=JSON.parse(n[1]);if(o.item)return d(o.item)}}catch(n){console.warn("[Extract] Parse error:",n)}}return m()}catch(t){return console.error("[Extract] Error:",t),null}}function d(t){var e,r;return t?{item_id:t.itemid||t.item_id,shop_id:t.shopid||t.shop_id,name:t.name,price:t.price||t.price_min,price_min:t.price_min,price_max:t.price_max,currency:t.currency||"VND",stock:t.stock,sold:t.sold||t.historical_sold,rating_star:(e=t.item_rating)==null?void 0:e.rating_star,rating_count:(r=t.item_rating)==null?void 0:r.rating_count,images:t.images||[],brand:t.brand}:null}function m(){try{let t={},e=document.querySelector('h1, [class*="title"]');e&&(t.name=e.textContent.trim());let r=document.querySelectorAll('[class*="price"]');for(let n of r){let i=n.textContent.match(/â‚«\s*([\d.,]+)/);if(i){t.price=parseInt(i[1].replace(/\./g,""));break}}return t.name||t.price?t:null}catch{return null}}typeof window<"u"&&(window.extractProductData=g,window.normalizeProductData=d,window.extractFromDOM=m);async function w(t,e=90,r="VND",n=null){var i;if(!((i=SERVER_CONFIG==null?void 0:SERVER_CONFIG.priceTracking)!=null&&i.endpoint))throw new Error("Ch\u01B0a c\u1EA5u h\xECnh API endpoint");let o=new URL(SERVER_CONFIG.priceTracking.endpoint);try{let c;if(n){let a={item_id:t,day:e,currency:r,product_data:n};c=await fetch(o.toString(),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)})}else o.searchParams.set("item_id",t),o.searchParams.set("day",e),o.searchParams.set("currency",r),c=await fetch(o.toString());if(!c.ok){if(c.status===404)return{prices:[],stats:{}};throw new Error(`API error: ${c.status}`)}let s=await c.json();return s&&s.success&&s.data?s.data:s&&(s.prices||s.stats)?s:{prices:[],stats:{}}}catch(c){throw console.error("[Price Tracking] Error:",c),c}}typeof window<"u"&&(window.fetchPriceTracking=w);function _(t){var n;if(!((n=t==null?void 0:t.prices)!=null&&n.length))return{labels:[],datasets:[]};let e=[...t.prices].sort((o,i)=>new Date(o.date)-new Date(i.date)),r=e;if(e.length>30){let o=Math.ceil(e.length/30);r=e.filter((i,c)=>c%o===0),r[r.length-1]!==e[e.length-1]&&r.push(e[e.length-1])}return{labels:r.map(o=>h(o.date)),datasets:[{label:"Gi\xE1 (\u20AB)",data:r.map(o=>o.price),borderColor:"#ee4d2d",backgroundColor:"rgba(238, 77, 45, 0.1)",borderWidth:2,fill:!0,tension:.4,pointRadius:3,pointHoverRadius:5,pointBackgroundColor:"#ee4d2d",pointBorderColor:"#fff",pointBorderWidth:2}]}}typeof window<"u"&&(window.formatPriceTrackingForChart=_);function C(t,e=null){var s;if(!((s=t==null?void 0:t.prices)!=null&&s.length))return{min_price:e||0,max_price:e||0,avg_price:e||0,current_price:e||0};let r=t.prices.map(a=>a.price),n=e!==null&&e>0?e:r[r.length-1]||0,o=Math.min(...r),i=Math.max(...r);n>0&&(n<o&&(o=n),n>i&&(i=n));let c=Math.round(r.reduce((a,l)=>a+l,0)/r.length);return{min_price:o,max_price:i,avg_price:c,current_price:n}}typeof window<"u"&&(window.getPriceStats=C);function y(t,e){if(typeof getCurrentTabId=="function")getCurrentTabId(r=>{if(!r){console.warn("[Chart] Kh\xF4ng th\u1EC3 l\u1EA5y tabId, s\u1EED d\u1EE5ng fallback"),u(t,e);return}f(r,t,e)});else if(typeof chrome<"u"&&chrome.scripting&&chrome.tabs&&chrome.tabs.query)try{chrome.tabs.query({active:!0,currentWindow:!0},r=>{if(chrome.runtime.lastError||!r||!r[0]){console.warn("[Chart] Kh\xF4ng th\u1EC3 l\u1EA5y tabId, s\u1EED d\u1EE5ng fallback"),u(t,e);return}f(r[0].id,t,e)})}catch(r){console.error("[Chart] Error accessing chrome.tabs:",r),u(t,e)}else console.warn("[Chart] chrome.scripting API kh\xF4ng c\xF3 s\u1EB5n"),u(t,e)}function f(t,e,r){if(!chrome.scripting){console.error("[Chart] chrome.scripting API kh\xF4ng c\xF3 s\u1EB5n");return}chrome.scripting.executeScript({target:{tabId:t},files:["js/chart.min.js"],world:"MAIN"}).then(()=>{setTimeout(()=>{chrome.scripting.executeScript({target:{tabId:t},func:(n,o)=>{try{let i=document.getElementById(n);if(!i){console.error("[Chart] Canvas not found:",n);return}window.priceChart&&window.priceChart.destroy();let c=window.Chart;if(!c){console.error("[Chart] Chart.js not loaded");return}let s=i.getContext("2d");window.priceChart=new c(s,{type:"line",data:o,options:{responsive:!0,maintainAspectRatio:!1,animation:{duration:750},plugins:{legend:{display:!1},tooltip:{callbacks:{label:function(a){let l=a.parsed.y;return l>=1e6?(l/1e6).toFixed(1)+"M \u20AB":l>=1e3?(l/1e3).toFixed(0)+"k \u20AB":l.toLocaleString("vi-VN")+" \u20AB"}}}},scales:{x:{ticks:{maxRotation:45,minRotation:45,font:{size:10}}},y:{beginAtZero:!1,ticks:{callback:function(a){return a>=1e6?(a/1e6).toFixed(1)+"M":a>=1e3?(a/1e3).toFixed(0)+"k":a.toLocaleString("vi-VN")}}}}}}),console.log("[Chart] Created successfully")}catch(i){console.error("[Chart] Create error:",i)}},args:[e,r],world:"MAIN"}).catch(n=>{console.error("[Chart] Error executing script:",n),u(e,r)})},500)}).catch(n=>{console.error("[Chart] Error injecting Chart.js:",n),u(e,r)})}function u(t,e){console.warn("[Chart] Using fallback method - may violate CSP"),console.error("[Chart] Cannot create chart: chrome.scripting API not available and inline scripts are blocked by CSP")}typeof window<"u"&&(window.createChartInPageContext=y);})();
