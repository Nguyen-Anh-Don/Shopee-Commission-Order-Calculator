(()=>{var C=[],c=[],y=null,M=null,D=null,O=null,h=null;document.addEventListener("DOMContentLoaded",function(){S();let o=document.getElementById("applyFiltersBtn"),t=document.getElementById("resetFiltersBtn"),n=document.getElementById("searchInput"),r=document.getElementById("filterHasOrders"),a=document.getElementById("minOrders"),s=document.getElementById("minGMV");o&&o.addEventListener("click",g),t&&t.addEventListener("click",G),n&&n.addEventListener("input",E(g,300)),r&&r.addEventListener("change",g),a&&a.addEventListener("input",E(g,300)),s&&s.addEventListener("input",E(g,300));let i=document.getElementById("start_date"),e=document.getElementById("end_date");i&&i.addEventListener("change",g),e&&e.addEventListener("change",g);let d=document.querySelectorAll(".quick-date-btn");d.forEach(u=>{u.addEventListener("click",function(){let m=parseInt(this.getAttribute("data-days"));w(m),d.forEach(f=>f.classList.remove("active")),this.classList.add("active"),g()})});let l=document.getElementById("exportBtn");l&&l.addEventListener("click",q),L();let p=document.getElementById("detailModal");p&&p.addEventListener("hidden.bs.modal",function(){let u=document.querySelector(".modal-backdrop");u&&u.remove(),document.body.classList.remove("modal-open"),document.body.style.overflow="",document.body.style.paddingRight=""})});async function S(){try{let o=document.getElementById("loadingMessage"),t=document.getElementById("noDataMessage"),n=document.getElementById("mainContent");o&&(o.style.display="block"),t&&(t.style.display="none"),n&&(n.style.display="none");let r=await idb.getAllOrders();if(!r||Object.keys(r).length===0){o&&(o.style.display="none"),t&&(t.style.display="block");return}let a=getVideoOrders(r);if(!a||a.length===0){o&&(o.style.display="none"),t&&(t.style.display="block");return}let s=groupOrdersByProduct(a);C=calculateVideoOverviewStats(s),o&&(o.style.display="none"),t&&(t.style.display="none"),n&&(n.style.display="block"),g()}catch(o){console.error("Error loading video data:",o);let t=document.getElementById("loadingMessage"),n=document.getElementById("noDataMessage");t&&(t.style.display="none"),n&&(n.style.display="block",n.innerHTML=`<strong>L\u1ED7i!</strong> Kh\xF4ng th\u1EC3 t\u1EA3i d\u1EEF li\u1EC7u: ${o.message}`)}}function g(){c=[...C];let o=document.getElementById("searchInput");if(o&&o.value.trim()){let e=o.value.trim().toLowerCase();c=c.filter(d=>String(d.productId).toLowerCase().includes(e)||d.productName.toLowerCase().includes(e))}let t=document.getElementById("filterHasOrders");t&&t.value!=="all"&&(t.value==="has"?c=c.filter(e=>e.orderCount>0):t.value==="no"&&(c=c.filter(e=>e.orderCount===0)));let n=document.getElementById("minOrders");if(n&&n.value){let e=parseInt(n.value);!isNaN(e)&&e>0&&(c=c.filter(d=>d.orderCount>=e))}let r=document.getElementById("minGMV");if(r&&r.value){let e=parseFloat(r.value);!isNaN(e)&&e>0&&(c=c.filter(d=>d.totalGMV>=e))}let a=document.getElementById("start_date"),s=document.getElementById("end_date");if(a&&a.value){let e=new Date(a.value);e.setHours(0,0,0,0),c=c.filter(d=>{if(!d.firstOrderDate)return!1;let l=new Date(d.firstOrderDate);return l.setHours(0,0,0,0),l>=e})}if(s&&s.value){let e=new Date(s.value);e.setHours(23,59,59,999),c=c.filter(d=>{if(!d.lastOrderDate)return!1;let l=new Date(d.lastOrderDate);return l.setHours(23,59,59,999),l<=e})}let i=document.getElementById("noFilterResultsMessage");i&&(c.length===0&&C.length>0?i.style.display="block":i.style.display="none"),H(),_(),F()}function G(){let o=document.getElementById("searchInput"),t=document.getElementById("filterHasOrders"),n=document.getElementById("minOrders"),r=document.getElementById("minGMV"),a=document.getElementById("start_date"),s=document.getElementById("end_date");o&&(o.value=""),t&&(t.value="all"),n&&(n.value=""),r&&(r.value=""),a&&(a.value=""),s&&(s.value="");let i=document.querySelectorAll(".quick-date-btn");i&&i.forEach(e=>e.classList.remove("active")),g()}function w(o){let t=new Date,n=new Date;n.setDate(n.getDate()-o);let r=document.getElementById("start_date"),a=document.getElementById("end_date");r&&(r.value=n.toISOString().split("T")[0]),a&&(a.value=t.toISOString().split("T")[0])}function H(){let o=c.length,t=c.reduce((d,l)=>d+l.orderCount,0),n=c.reduce((d,l)=>d+l.totalGMV,0),r=c.reduce((d,l)=>d+l.totalCommission,0),a=document.getElementById("summaryTotalVideos"),s=document.getElementById("summaryTotalOrders"),i=document.getElementById("summaryTotalGMV"),e=document.getElementById("summaryTotalCommission");a&&(a.textContent=o),s&&(s.textContent=t),i&&(i.textContent=n.toLocaleString("vi-VN",{style:"currency",currency:"VND"})),e&&(e.textContent=r.toLocaleString("vi-VN",{style:"currency",currency:"VND"}))}function _(){let o=document.querySelector("#videoTable tbody");o&&(y&&(y.destroy(),y=null),o.innerHTML="",c.forEach(t=>{let n=document.createElement("tr");n.className=t.orderCount>0?"has-orders":"no-orders";let r=document.createElement("td");t.productImage?r.innerHTML=`<img src="${t.productImage}" alt="${t.productName}" class="video-image" onerror="this.style.display='none';this.nextElementSibling.style.display='flex';" />
                <div class="video-image-placeholder" style="display:none;">No Image</div>`:r.innerHTML='<div class="video-image-placeholder">No Image</div>';let a=document.createElement("td");a.textContent=t.productId;let s=document.createElement("td");s.textContent=t.productName;let i=document.createElement("td");i.innerHTML=`<span class="video-badge ${t.orderCount>0?"badge-has-orders":"badge-no-orders"}">${t.orderCount} \u0111\u01A1n</span>`;let e=document.createElement("td");e.className="text-end",e.textContent=t.formatted.totalGMV,e.setAttribute("data-sort",t.totalGMV);let d=document.createElement("td");d.className="text-end",d.textContent=t.formatted.totalCommission,d.setAttribute("data-sort",t.totalCommission);let l=document.createElement("td");l.textContent=t.formatted.firstOrderDate;let p=document.createElement("td");p.textContent=t.formatted.lastOrderDate;let u=document.createElement("td");t.orderCount>0?u.innerHTML=`<button class="btn btn-sm btn-primary btn-detail" data-product-id="${t.productId}">Chi ti\u1EBFt</button>`:u.innerHTML='<span class="text-muted">-</span>',n.appendChild(r),n.appendChild(a),n.appendChild(s),n.appendChild(i),n.appendChild(e),n.appendChild(d),n.appendChild(l),n.appendChild(p),n.appendChild(u),o.appendChild(n)}),$.fn.dataTable.ext.order["dom-data-sort"]||($.fn.dataTable.ext.order["dom-data-sort"]=function(t,n){return this.api().column(n,{order:"index"}).nodes().map(function(r,a){let s=$(r).attr("data-sort");return s?parseFloat(s):0})}),y=$("#videoTable").DataTable({pageLength:25,order:[[3,"desc"]],searching:!1,columnDefs:[{targets:[4,5],orderDataType:"dom-data-sort",type:"num"}],language:{url:"//cdn.datatables.net/plug-ins/1.13.6/i18n/vi.json"}}),L())}function L(){let o=document.querySelector("#videoTable tbody");o&&(o.removeEventListener("click",V),o.addEventListener("click",V))}function V(o){let n=o.target.closest("button.btn-detail");if(n){o.preventDefault(),o.stopPropagation();let r=n.getAttribute("data-product-id");r&&A(r)}}function F(){let o=document.getElementById("chartsSection");if(!o)return;let t=c.filter(s=>s.orderCount>0);if(t.length===0){o.style.display="none";return}o.style.display="block";let n=[...t].sort((s,i)=>i.orderCount-s.orderCount).slice(0,10);I("topOrdersChart",n,"orderCount","S\u1ED1 \u0111\u01A1n","#4caf50");let r=[...t].sort((s,i)=>i.totalGMV-s.totalGMV).slice(0,10);I("topGMVChart",r,"totalGMV","GMV (\u20AB)","#ff9800");let a=[...t].sort((s,i)=>i.totalCommission-s.totalCommission).slice(0,10);I("topCommissionChart",a,"totalCommission","Hoa h\u1ED3ng (\u20AB)","#f36f21")}function I(o,t,n,r,a){let s=document.getElementById(o);if(!s)return;let i=o==="topOrdersChart"?M:o==="topGMVChart"?D:O;i&&i.destroy();let e=s.getContext("2d"),d={labels:t.map(m=>`${m.productName.length>20?m.productName.substring(0,20)+"...":m.productName} (${m.productId})`),datasets:[{label:r,data:t.map(m=>{let f=m[n];return(n==="totalGMV"||n==="totalCommission")&&(f=f/1e3),f}),backgroundColor:a,borderColor:a,borderWidth:1}]},l=m=>n==="orderCount"?m:(m*1e3).toLocaleString("vi-VN")+" \u20AB",p={type:"bar",data:d,options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1},tooltip:{callbacks:{label:function(m){return l(m.parsed.y)}}}},scales:{y:{beginAtZero:!0,ticks:{callback:function(m){return l(m)}}}}}};typeof ChartDataLabels<"u"&&(p.plugins=p.plugins||{},p.plugins.datalabels={anchor:"end",align:"top",formatter:m=>n==="orderCount"?m:(m*1e3).toLocaleString("vi-VN"),font:{size:10}});let u=new Chart(e,p);o==="topOrdersChart"?M=u:o==="topGMVChart"?D=u:o==="topCommissionChart"&&(O=u)}function A(o){let t=C.find(e=>e.productId===o);if(!t)return;let n=document.getElementById("detailModalTitle"),r=document.getElementById("videoDetailInfo"),a=document.getElementById("detailOrdersCount"),s=document.getElementById("detailOrdersList"),i=document.getElementById("viewOrderHistoryLink");if(n&&(n.textContent=`Chi ti\u1EBFt Video: ${t.productName}`),r&&(r.innerHTML=`
            <div class="row">
                <div class="col-md-3">
                    ${t.productImage?`<img src="${t.productImage}" alt="${t.productName}" class="img-fluid" />`:'<div class="bg-light p-3 text-center">No Image</div>'}
                </div>
                <div class="col-md-9">
                    <h6>${t.productName}</h6>
                    <p class="mb-1"><strong>ID S\u1EA3n ph\u1EA9m:</strong> ${t.productId}</p>
                    <p class="mb-1"><strong>S\u1ED1 \u0111\u01A1n:</strong> ${t.orderCount}</p>
                    <p class="mb-1"><strong>T\u1ED5ng GMV:</strong> ${t.formatted.totalGMV}</p>
                    <p class="mb-1"><strong>T\u1ED5ng hoa h\u1ED3ng:</strong> ${t.formatted.totalCommission}</p>
                    <p class="mb-0"><strong>\u0110\u01A1n \u0111\u1EA7u ti\xEAn:</strong> ${t.formatted.firstOrderDate}</p>
                    <p class="mb-0"><strong>\u0110\u01A1n cu\u1ED1i:</strong> ${t.formatted.lastOrderDate}</p>
                </div>
            </div>
        `),a&&(a.textContent=t.orders.length),s&&(s.innerHTML="",t.orders.forEach((e,d)=>{var B;let l=e.item,p=e.purchase_time||e.checkout_complete_time||0,u=p>0?new Date(p*1e3).toLocaleString("vi-VN"):"N/A",m=e.checkout_id||e.order&&e.order.order_id||"N/A",f=0,b=0;if(l.item_gmv)f=parseFloat(l.item_gmv||0)/1e5,b=parseFloat(l.item_commission||0)/1e5;else{let k=parseFloat(l.actual_amount||0);f=parseInt(k/1e5);let x=parseFloat(l.item_commission||0)/1e5,N=parseFloat(l.capped_brand_commission||0)/1e5;b=parseInt(x+N)}let T=((B=e.order)==null?void 0:B.order_status)||e.checkout_status||"",v=document.createElement("tr");v.innerHTML=`
                <td>${d+1}</td>
                <td>${m}</td>
                <td>${u}</td>
                <td class="text-end">${f.toLocaleString("vi-VN")} \u20AB</td>
                <td class="text-end">${b.toLocaleString("vi-VN")} \u20AB</td>
                <td>${T||"-"}</td>
            `,s.appendChild(v)})),i&&(i.href=`product-detail.html?item_id=${o}`),!h){let e=document.getElementById("detailModal");e&&(h=new bootstrap.Modal(e))}h&&h.show()}function q(){if(c.length===0){alert("Kh\xF4ng c\xF3 d\u1EEF li\u1EC7u \u0111\u1EC3 xu\u1EA5t!");return}let o=["ID S\u1EA3n ph\u1EA9m","T\xEAn s\u1EA3n ph\u1EA9m","S\u1ED1 \u0111\u01A1n","T\u1ED5ng GMV (\u20AB)","T\u1ED5ng hoa h\u1ED3ng (\u20AB)","\u0110\u01A1n \u0111\u1EA7u ti\xEAn","\u0110\u01A1n cu\u1ED1i"],t=c.map(e=>[e.productId,`"${e.productName.replace(/"/g,'""')}"`,e.orderCount,e.totalGMV,e.totalCommission,e.formatted.firstOrderDate,e.formatted.lastOrderDate]),n=[o.join(","),...t.map(e=>e.join(","))].join(`
`),r="\uFEFF",a=new Blob([r+n],{type:"text/csv;charset=utf-8;"}),s=document.createElement("a"),i=URL.createObjectURL(a);s.setAttribute("href",i),s.setAttribute("download",`video-overview-${new Date().toISOString().split("T")[0]}.csv`),s.style.visibility="hidden",document.body.appendChild(s),s.click(),document.body.removeChild(s)}function E(o,t){let n;return function(...a){let s=()=>{clearTimeout(n),o(...a)};clearTimeout(n),n=setTimeout(s,t)}}})();
